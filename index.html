<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>흔들갈대</title>
<style>
  /* 전체 스타일 */
  body {
    font-family: 'Noto Sans KR', sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f7f7f7;
    color: #333;
    line-height: 1.6;
  }
  
  /* 비밀번호 화면 */
  #password-screen {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    background-color: #f5f5f5;
  }
  
  #password-form {
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    text-align: center;
    width: 90%;
    max-width: 350px;
  }
  
  #password-form h2 {
    margin-top: 0;
    color: #333;
  }
  
  #password {
    width: 100%;
    padding: 12px;
    margin: 15px 0;
    border: 1px solid #ddd;
    border-radius: 5px;
    box-sizing: border-box;
  }
  
  #password-form button {
    width: 100%;
    padding: 12px;
    background-color: #5f7561;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    transition: background-color 0.3s;
  }
  
  #password-form button:hover {
    background-color: #4a5b4b;
  }
  
  #error-msg {
    color: #e74c3c;
    margin-top: 10px;
  }
  
  /* 메인 컨텐츠 */
  #main-content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }
  
  header {
    text-align: center;
    padding: 20px 0;
    margin-bottom: 30px;
    border-bottom: 1px solid #eee;
  }
  
  header p {
    color: #666;
    font-style: italic;
  }
  
  nav {
    margin-bottom: 30px;
  }
  
  nav ul {
    display: flex;
    list-style: none;
    padding: 0;
    margin: 0;
    justify-content: center;
    flex-wrap: wrap;
  }
  
  nav li {
    margin: 0 10px 10px;
  }
  
  nav a {
    text-decoration: none;
    color: #333;
    padding: 8px 15px;
    border-radius: 20px;
    background-color: #eee;
    transition: all 0.3s;
    display: inline-block;
  }
  
  nav a:hover, nav a.active {
    background-color: #5f7561;
    color: white;
  }
  
  /* 탭 컨텐츠 */
  .tab-content {
    display: none;
    padding: 20px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
  }
  
  .tab-content.active {
    display: block;
  }
  
  /* 습관 트래커 스타일 */
  .habit-container {
    margin-top: 20px;
  }
  
  .habit-section {
    margin-bottom: 30px;
  }
  
  .habit-form {
    background-color: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
  }
  
  .form-group {
    margin-bottom: 15px;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
  }
  
  .form-group input[type="text"], 
  .form-group select, 
  .form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    box-sizing: border-box;
  }
  
  .form-group textarea {
    min-height: 80px;
    resize: vertical;
  }
  
  .weekday-options {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
  }
  
  .weekday-item {
    margin-right: 10px;
  }
  
  .checkbox-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
  }
  
  .checkbox-item {
    display: flex;
    align-items: center;
    margin-right: 10px;
  }
  
  .checkbox-item input {
    margin-right: 5px;
  }
  
  button {
    padding: 10px 20px;
    background-color: #5f7561;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 15px;
    transition: background-color 0.3s;
  }
  
  button:hover {
    background-color: #4a5b4b;
  }
  
  .delete-btn {
    background-color: #e74c3c;
  }
  
  .delete-btn:hover {
    background-color: #c0392b;
  }
  
  /* 습관 목록 */
  .habit-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
  }
  
  .habit-list-item {
    background-color: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  
  .habit-list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  
  .habit-list-title {
    font-size: 18px;
    font-weight: 600;
  }
  
  .habit-list-category {
    font-size: 14px;
    color: #666;
    background-color: #f0f0f0;
    padding: 3px 8px;
    border-radius: 15px;
  }
  
  .habit-streak {
    margin: 15px 0;
    color: #5f7561;
    font-weight: 500;
  }
  
  .habit-streak-number {
    font-size: 24px;
    font-weight: 700;
  }
  
  .habit-list-controls {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  
  .habit-list-controls button {
    padding: 8px 12px;
    font-size: 14px;
  }
  
  /* 달력 스타일 */
  .habit-calendar-container {
    background-color: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  
  .habit-calendar-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }
  
  #habitCalendarHeader {
    font-size: 18px;
    font-weight: 600;
    text-align: center;
    flex-grow: 1;
  }
  
  .habit-calendar-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
    font-weight: 500;
    margin-bottom: 10px;
  }
  
  .habit-calendar-day-name {
    padding: 5px;
  }
  
  .habit-calendar-body {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
  }
  
  .habit-calendar-day {
    border: 1px solid #eee;
    min-height: 80px;
    padding: 5px;
    position: relative;
    transition: background-color 0.2s;
  }
  
  .habit-calendar-day.today {
    background-color: #f0f7f0;
    border-color: #5f7561;
  }
  
  .habit-calendar-day.other-month {
    background-color: #f5f5f5;
    color: #aaa;
  }
  
  .habit-day-number {
    font-size: 14px;
    text-align: right;
    margin-bottom: 5px;
  }
  
  .habit-items {
    font-size: 12px;
  }
  
  .habit-item {
    display: flex;
    align-items: center;
    margin-bottom: 3px;
  }
  
  .habit-circle {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 5px;
    border: 1px solid transparent;
  }
  
  .habit-circle.completed {
    background-color: inherit;
  }
  
  .habit-circle.missed {
    background-color: #eee;
  }
  
  /* 특정일 선택 모드 스타일 */
  .habit-calendar-day.specific-date-selected {
    background-color: #d4edda;
    border-color: #5f7561;
  }
  
  /* 미디어 쿼리 - 모바일 대응 */
  @media (max-width: 768px) {
    .habit-list {
      grid-template-columns: 1fr;
    }
    
    .habit-list-controls {
      flex-direction: column;
    }
    
    .habit-list-controls button {
      width: 100%;
      margin-bottom: 5px;
    }
    
    .habit-calendar-body {
      gap: 2px;
    }
    
    .habit-calendar-day {
      min-height: 60px;
      padding: 2px;
    }
  }
</style>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>
<div id="password-screen">
  <form id="password-form" onsubmit="return checkPassword(event)">
    <h2>🔐 비밀번호를 입력하세요</h2>
    <input id="password" type="password" placeholder="비밀번호 입력" required>
    <button type="submit">입장</button>
    <p id="error-msg"></p>
  </form>
</div>
<div id="main-content" style="display: none;">
  <header>
    <img src="logo.png" alt="흔들갈대 로고" style="height:60px;">
    <p>헛되이 보낸 오늘은, 죽은이가 그토록 바라던 내일이었다</p>
    <audio id="bgm" src="bgm.mp3" autoplay loop hidden></audio>
  </header>
  
  <nav>
    <ul>
      <li><a href="#" class="tab-link active" data-tab="home">홈</a></li>
      <li><a href="#" class="tab-link" data-tab="habits">습관 관리</a></li>
      <li><a href="#" class="tab-link" data-tab="journal">일기</a></li>
      <li><a href="#" class="tab-link" data-tab="goals">목표</a></li>
      <li><a href="#" class="tab-link" data-tab="settings">설정</a></li>
    </ul>
  </nav>
  
  <div id="tabs">
    <div id="home" class="tab-content active">
      <h2>환영합니다</h2>
      <p>이곳에서 습관을 관리하고, 일상을 기록하며 자신의 성장을 확인하세요.</p>
    </div>
    
    <div id="habits" class="tab-content">
      <h2>습관 관리</h2>
      
      <div class="habit-container">
        <!-- 습관 추가 폼 -->
        <div class="habit-section">
          <h3>새 습관 추가</h3>
          <div class="habit-form">
            <div class="form-group">
              <label for="habitTitle">습관 이름</label>
              <input type="text" id="habitTitle" placeholder="예: 30분 독서하기">
            </div>
            
            <div class="form-group">
              <label for="habitCategory">카테고리</label>
              <select id="habitCategory">
                <option value="health">건강</option>
                <option value="productivity">생산성</option>
                <option value="mental">정신 건강</option>
                <option value="learning">학습</option>
                <option value="custom">직접 입력</option>
              </select>
              <input type="text" id="habitCustomCategory" placeholder="카테고리 입력" style="display: none; margin-top: 10px;">
            </div>
            
            <div class="form-group">
              <label for="habitFrequency">주기</label>
              <select id="habitFrequency">
                <option value="daily">매일</option>
                <option value="weekly">주간</option>
                <option value="specific">특정일</option>
              </select>
              
              <!-- 주간 옵션 -->
              <div id="weekdayOptionContainer" style="display: none; margin-top: 10px;">
                <div class="weekday-options">
                  <div class="weekday-item">
                    <input type="radio" id="weekdaysOption" name="weekdayOption" value="weekdays" checked>
                    <label for="weekdaysOption">주 5일 (월-금)</label>
                  </div>
                  <div class="weekday-item">
                    <input type="radio" id="customWeekdaysOption" name="weekdayOption" value="custom">
                    <label for="customWeekdaysOption">요일 직접 선택</label>
                  </div>
                </div>
                
                <!-- 직접 선택 요일 -->
                <div id="customWeekdaysContainer" class="checkbox-container" style="display: none;">
                  <div class="checkbox-item">
                    <input type="checkbox" id="sunday" class="habitWeekDay" value="0">
                    <label for="sunday">일</label>
                  </div>
                  <div class="checkbox-item">
                    <input type="checkbox" id="monday" class="habitWeekDay" value="1">
                    <label for="monday">월</label>
                  </div>
                  <div class="checkbox-item">
                    <input type="checkbox" id="tuesday" class="habitWeekDay" value="2">
                    <label for="tuesday">화</label>
                  </div>
                  <div class="checkbox-item">
                    <input type="checkbox" id="wednesday" class="habitWeekDay" value="3">
                    <label for="wednesday">수</label>
                  </div>
                  <div class="checkbox-item">
                    <input type="checkbox" id="thursday" class="habitWeekDay" value="4">
                    <label for="thursday">목</label>
                  </div>
                  <div class="checkbox-item">
                    <input type="checkbox" id="friday" class="habitWeekDay" value="5">
                    <label for="friday">금</label>
                  </div>
                  <div class="checkbox-item">
                    <input type="checkbox" id="saturday" class="habitWeekDay" value="6">
                    <label for="saturday">토</label>
                  </div>
                </div>
              </div>
              
              <!-- 특정일 선택 설명 -->
              <div id="specificDatesContainer" style="display: none; margin-top: 10px;">
                <p>아래 달력에서 원하는 날짜를 선택하세요.</p>
              </div>
            </div>
            
            <div class="form-group">
              <label for="habitDescription">메모 (선택사항)</label>
              <textarea id="habitDescription" placeholder="습관에 대한 추가 정보를 입력하세요"></textarea>
            </div>
            
            <button type="button" onclick="addHabit()">습관 추가</button>
          </div>
        </div>
        
        <!-- 캘린더 섹션 -->
        <div class="habit-section">
          <div class="habit-calendar-container">
            <div class="habit-calendar-header-row">
              <button onclick="prevHabitMonth()">◀ 이전 달</button>
              <div id="habitCalendarHeader">2025년 4월</div>
              <button onclick="nextHabitMonth()">다음 달 ▶</button>
            </div>
            <div id="habitCalendar"></div>
          </div>
        </div>
        
        <!-- 습관 목록 -->
        <div class="habit-section">
          <h3>내 습관 목록</h3>
          <div id="habitsList" class="habit-list">
            <!-- 습관 목록이 여기에 표시됩니다 -->
          </div>
        </div>
      </div>
    </div>
    
    <div id="journal" class="tab-content">
      <h2>일기</h2>
      <p>이 기능은 아직 개발 중입니다.</p>
    </div>
    
    <div id="goals" class="tab-content">
      <h2>목표</h2>
      <p>이 기능은 아직 개발 중입니다.</p>
    </div>
    
    <div id="settings" class="tab-content">
      <h2>설정</h2>
      <p>이 기능은 아직 개발 중입니다.</p>
    </div>
  </div>
</div>

<script>
// Firebase 초기화 및 로그인 관련 스크립트
let firebaseInitialized = false;

function initializeFirebase() {
  if (!firebaseInitialized && typeof firebase !== 'undefined' && firebase.apps.length === 0) {
    const firebaseConfig = {
      apiKey: "AIzaSyAc1vHqkpkK76kYtZazxq2bVso2cPFA1Qw",
      authDomain: "song-homepage.firebaseapp.com",
      projectId: "song-homepage",
      storageBucket: "song-homepage.appspot.com",
      messagingSenderId: "59678249334",
      appId: "1:59678249334:web:83018cd88e5c244ac2cf1a",
      measurementId: "G-3YSWN7XH2W"
    };
    firebase.initializeApp(firebaseConfig);
    firebaseInitialized = true;
    const userId = localStorage.getItem("uid") || Date.now().toString();
    localStorage.setItem("uid", userId);
    console.log('Firebase 초기화 완료, 사용자 ID:', userId);
    return true;
  }
  return firebaseInitialized;
}

function checkPassword(event) {
  event.preventDefault();
  const input = document.getElementById('password').value;
  const errorMsg = document.getElementById('error-msg');

  if (input === 'sik282') {
    localStorage.setItem('loggedIn', 'true');
    document.getElementById('password-screen').style.display = 'none';
    document.getElementById('main-content').style.display = 'block';
    if (initializeFirebase()) {
      loadInitialData();
    }
  } else {
    errorMsg.textContent = '비밀번호가 틀렸습니다';
  }
}

document.addEventListener('DOMContentLoaded', function() {
  if (localStorage.getItem('loggedIn') === 'true') {
    document.getElementById('password-screen').style.display = 'none';
    document.getElementById('main-content').style.display = 'block';
    if (initializeFirebase()) {
      loadInitialData();
    }
  }
  
  // 탭 전환 이벤트 리스너 추가
  document.querySelectorAll('.tab-link').forEach(tab => {
    tab.addEventListener('click', function(e) {
      e.preventDefault();
      const tabId = this.getAttribute('data-tab');
      
      // 탭 링크 활성화
      document.querySelectorAll('.tab-link').forEach(t => {
        t.classList.remove('active');
      });
      this.classList.add('active');
      
      // 탭 컨텐츠 활성화
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tabId).classList.add('active');
      
      // 습관 탭이 활성화되면 습관 기능 초기화
      if (tabId === 'habits') {
        initializeHabitFunctions();
        renderHabits();
        renderHabitCalendar();
      }
    });
  });
});

// 초기 데이터 로드
function loadInitialData() {
  console.log('초기 데이터 로드');
  
  // Firebase에서 데이터 로드
  const dbRef = firebase.database().ref(localStorage.getItem("uid"));
  
  dbRef.child('habits').get().then((snapshot) => {
    if (snapshot.exists()) {
      habits = snapshot.val();
      localStorage.setItem('habits', JSON.stringify(habits));
      renderHabits();
    } else {
      // 로컬 스토리지에서 로드
      const storedHabits = localStorage.getItem('habits');
      if (storedHabits) {
        habits = JSON.parse(storedHabits);
      }
    }
    renderHabits();
  });
  
  dbRef.child('habitRecords').get().then((snapshot) => {
    if (snapshot.exists()) {
      habitRecords = snapshot.val();
      localStorage.setItem('habitRecords', JSON.stringify(habitRecords));
    } else {
      // 로컬 스토리지에서 로드
      const storedRecords = localStorage.getItem('habitRecords');
      if (storedRecords) {
        habitRecords = JSON.parse(storedRecords);
      }
    }
    renderHabitCalendar();
  });
}

// Firebase에 데이터 저장
function saveToFirebase(path, data) {
  if (!firebaseInitialized) return;
  
  const userId = localStorage.getItem("uid");
  if (!userId) return;
  
  firebase.database().ref(userId).child(path).set(data)
    .then(() => {
      console.log(`${path} 데이터가 Firebase에 저장되었습니다.`);
    })
    .catch((error) => {
      console.error(`Firebase 저장 오류: ${error.message}`);
    });
}

// ===== 습관 트래커 기능 =====

// 전역 변수
let habits = JSON.parse(localStorage.getItem('habits') || '[]');
let habitRecords = JSON.parse(localStorage.getItem('habitRecords') || '[]');
let selectedSpecificDates = [];

// 현재 달력 날짜
const today = new Date();
let currentHabitYear = today.getFullYear();
let currentHabitMonth = today.getMonth();

// 습관 주기에 따른 옵션 토글
function toggleWeekdayOptions() {
  const frequency = document.getElementById('habitFrequency').value;
  const weekdayOptionContainer = document.getElementById('weekdayOptionContainer');
  const specificDatesContainer = document.getElementById('specificDatesContainer');
  
  if (frequency === 'weekly') {
    if (weekdayOptionContainer) weekdayOptionContainer.style.display = 'block';
    if (specificDatesContainer) specificDatesContainer.style.display = 'none';
    
    // 요일 옵션 기본값 설정
    const weekdaysOption = document.getElementById('weekdaysOption');
    if (weekdaysOption) weekdaysOption.checked = true;
    
    toggleCustomWeekdays();
  } 
  else if (frequency === 'specific') {
    if (weekdayOptionContainer) weekdayOptionContainer.style.display = 'none';
    if (specificDatesContainer) specificDatesContainer.style.display = 'block';
    
    // 특정일 선택 모드 활성화
    enableSpecificDateSelection();
  } 
  else {
    if (weekdayOptionContainer) weekdayOptionContainer.style.display = 'none';
    if (specificDatesContainer) specificDatesContainer.style.display = 'none';
  }
}

// 카테고리 직접 입력 토글
function toggleHabitCategoryInput() {
  const category = document.getElementById('habitCategory').value;
  const customCategoryInput = document.getElementById('habitCustomCategory');
  
  if (category === 'custom') {
    if (customCategoryInput) customCategoryInput.style.display = 'block';
  } else {
    if (customCategoryInput) customCategoryInput.style.display = 'none';
  }
}

// 커스텀 요일 옵션 토글
function toggleCustomWeekdays() {
  const weekdayOption = document.querySelector('input[name="weekdayOption"]:checked')?.value;
  const customWeekdaysContainer = document.getElementById('customWeekdaysContainer');
  
  if (weekdayOption === 'custom') {
    if (customWeekdaysContainer) customWeekdaysContainer.style.display = 'block';
  } else {
    if (customWeekdaysContainer) customWeekdaysContainer.style.display = 'none';
  }
}

// 특정일 선택 활성화
function enableSpecificDateSelection() {
  console.log("특정일 선택 모드 활성화");
  
  // 특정일 선택을 위한 전역 배열 초기화
  selectedSpecificDates = selectedSpecificDates || [];
  
  // 선택된 날짜 표시
  setTimeout(() => {
    const calendarDays = document.querySelectorAll('.habit-calendar-day');
    calendarDays.forEach(day => {
      const dateStr = day.querySelector('.habit-items')?.dataset.date;
      if (dateStr && selectedSpecificDates.includes(dateStr)) {
        day.classList.add('specific-date-selected');
      }
      
      // 클릭 이벤트 추가
      day.style.cursor = 'pointer';
      day.addEventListener('click', function(e) {
        if (document.getElementById('habitFrequency')?.value !== 'specific') return;
        
        const dateElement = this.querySelector('.habit-items');
        if (!dateElement) return;
        
        const dateStr = dateElement.dataset.date;
        if (!dateStr) return;
        
        // 날짜 토글
        const dateIndex = selectedSpecificDates.indexOf(dateStr);
        if (dateIndex === -1) {
          selectedSpecificDates.push(dateStr);
          this.classList.add('specific-date-selected');
        } else {
          selectedSpecificDates.splice(dateIndex, 1);
          this.classList.remove('specific-date-selected');
        }
      });
    });
  }, 100);
}

// 습관 추가
function addHabit() {
  const title = document.getElementById('habitTitle').value.trim();
  const category = document.getElementById('habitCategory').value;
  const customCategory = document.getElementById('habitCustomCategory')?.value.trim();
  const frequency = document.getElementById('habitFrequency').value;
  const description = document.getElementById('habitDescription').value.trim();
  
  if (!title) {
    alert('습관 이름을 입력해주세요.');
    return;
  }
  
  // 실제 사용할 카테고리
  const finalCategory = category === 'custom' ? customCategory : category;
  
  // 주기에 따른 날짜 설정
  let weekDays = [];
  let specificDates = [];
  
  if (frequency === 'weekly') {
    const weekdayOption = document.querySelector('input[name="weekdayOption"]:checked')?.value;
    
    if (weekdayOption === 'weekdays' || !weekdayOption) {
      // 주 5일(월-금) 선택
      weekDays = [1, 2, 3, 4, 5]; // 월화수목금 (1-5)
    } else if (weekdayOption === 'custom') {
      // 직접 선택
      const checkboxes = document.querySelectorAll('.habitWeekDay:checked');
      weekDays = Array.from(checkboxes).map(cb => parseInt(cb.value));
      
      if (weekDays.length === 0) {
        alert('하나 이상의 요일을 선택해주세요.');
        return;
      }
    }
  } 
  else if (frequency === 'specific') {
    // 특정일 처리
    specificDates = selectedSpecificDates || [];
    
    if (specificDates.length === 0) {
      alert('하나 이상의 날짜를 선택해주세요.');
      return;
    }
  }
  
  const habit = {
    id: Date.now(),
    title,
    category: finalCategory,
    frequency,
    weekDays, // 주간인 경우만 사용됨
    specificDates, // 특정일인 경우만 사용됨
    description,
    createdAt: new Date().toISOString(),
    streak: 0, // 초기 연속 기록은 0
    color: getRandomHabitColor() // 랜덤 색상 지정
  };
  
  habits.push(habit);
  
  // 저장
  localStorage.setItem('habits', JSON.stringify(habits));
  saveToFirebase('habits', habits);
  
  // 입력 필드 초기화
  document.getElementById('habitTitle').value = '';
  document.getElementById('habitCategory').value = 'health';
  if (document.getElementById('habitCustomCategory')) {
    document.getElementById('habitCustomCategory').value = '';
    document.getElementById('habitCustomCategory').style.display = 'none';
  }
  document.getElementById('habitFrequency').value = 'daily';
  
  // 주간 옵션 초기화
  const weekdayOptionContainer = document.getElementById('weekdayOptionContainer');
  const customWeekdaysContainer = document.getElementById('customWeekdaysContainer');
  const specificDatesContainer = document.getElementById('specificDatesContainer');
  
  if (weekdayOptionContainer) weekdayOptionContainer.style.display = 'none';
  if (customWeekdaysContainer) customWeekdaysContainer.style.display = 'none';
  if (specificDatesContainer) specificDatesContainer.style.display = 'none';
  
  // 요일 체크박스 초기화
  document.querySelectorAll('.habitWeekDay').forEach(cb => cb.checked = false);
  
  // 주 5일 옵션이 기본값이 되도록 설정
  const weekdaysOption = document.getElementById('weekdaysOption');
  if (weekdaysOption) weekdaysOption.checked = true;
  
  // 특정일 선택 초기화
  selectedSpecificDates = [];
  document.querySelectorAll('.habit-calendar-day').forEach(day => {
    day.classList.remove('specific-date-selected');
  });
  
  document.getElementById('habitDescription').value = '';
  
  // 습관 목록 및 달력 렌더링
  renderHabits();
  renderHabitCalendar();
  
  alert('새로운 습관이 추가되었습니다.');
}

// 랜덤 색상 생성
function getRandomHabitColor() {
  const colors = [
    '#5f7561', '#4CAF50', '#8BC34A', '#2196F3', '#9C27B0',
    '#FF9800', '#9E9E9E', '#607D8B', '#795548', '#FF5722'
  ];
  
  return colors[Math.floor(Math.random() * colors.length)];
}

// 습관 렌더링
function renderHabits() {
  const habitsList = document.getElementById('habitsList');
  
  if (!habitsList) return;
  
  if (habits.length === 0) {
    habitsList.innerHTML = '<p class="no-habits" style="text-align: center; color: #888; padding: 20px;">아직 추가된 습관이 없습니다. 새로운 습관을 추가해보세요!</p>';
    return;
  }
  
  habitsList.innerHTML = '';
  
  // 생성일 기준 정렬 (최신 순)
  habits.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  
  habits.forEach(habit => {
    const habitItem = document.createElement('div');
    habitItem.className = 'habit-list-item';
    
    // 습관 빈도 텍스트 생성
    let frequencyText = '매일';
    if (habit.frequency === 'weekly') {
      const days = ['일', '월', '화', '수', '목', '금', '토'];
      
      // 주 5일(월-금) 여부 확인
      if (JSON.stringify(habit.weekDays.sort()) === JSON.stringify([1, 2, 3, 4, 5])) {
        frequencyText = '주 5일 (월-금)';
      } else {
        const selectedDays = habit.weekDays.map(day => days[day]).join(', ');
        frequencyText = `매주 ${selectedDays}요일`;
      }
    } else if (habit.frequency === 'monthly') {
      frequencyText = '매월';
    } else if (habit.frequency === 'specific') {
      // 특정일은 선택된 날짜 수를 표시
      const datesCount = (habit.specificDates || []).length;
      frequencyText = `특정일 (${datesCount}일)`;
    }
    
    // 연속 달성 일수 계산
    const streak = calculateHabitStreak(habit);
    
    habitItem.innerHTML = `
      <div class="habit-list-header">
        <div class="habit-list-title">${habit.title}</div>
        <div class="habit-list-category">${habit.category}</div>
      </div>
      
      <div>${frequencyText}</div>
      ${habit.description ? `<div style="margin-top: 8px; color: #666;">${habit.description}</div>` : ''}
      
      <div class="habit-streak">
        <span class="habit-streak-number">${streak}</span> 일 연속 달성 중
      </div>
      
      <div class="habit-list-controls">
        <button onclick="checkHabitToday(${habit.id})">오늘 체크</button>
        <button onclick="viewHabitHistory(${habit.id})">기록 보기</button>
        <button class="delete-btn" onclick="deleteHabit(${habit.id})">삭제</button>
      </div>
    `;
    
    habitsList.appendChild(habitItem);
  });
}

// 습관 달력 렌더링
function renderHabitCalendar() {
  const habitCalendar = document.getElementById('habitCalendar');
  const habitCalendarHeader = document.getElementById('habitCalendarHeader');
  
  if (!habitCalendar || !habitCalendarHeader) return;
  
  habitCalendarHeader.textContent = `${currentHabitYear}년 ${currentHabitMonth + 1}월`;
  
  // 현재 월의 첫날과 마지막 날
  const firstDay = new Date(currentHabitYear, currentHabitMonth, 1);
  const lastDay = new Date(currentHabitYear, currentHabitMonth + 1, 0);
  
  // 첫째 날의 요일 (0: 일요일, 6: 토요일)
  const firstDayOfWeek = firstDay.getDay();
  
  // 마지막 날짜
  const lastDate = lastDay.getDate();
  
  // 오늘 날짜
  const today = new Date();
  const isCurrentMonth = today.getFullYear() === currentHabitYear && today.getMonth() === currentHabitMonth;
  const todayDate = today.getDate();
  
  // 달력 생성
  let calendarHTML = '<div class="habit-calendar-header">';
  const days = ['일', '월', '화', '수', '목', '금', '토'];
  
  // 요일 헤더
  for (let i = 0; i < 7; i++) {
    calendarHTML += `<div class="habit-calendar-day-name">${days[i]}</div>`;
  }
  
  calendarHTML += '</div><div class="habit-calendar-body">';
  
  // 첫째 날 이전의 빈 셀
  for (let i = 0; i < firstDayOfWeek; i++) {
    calendarHTML += '<div class="habit-calendar-day other-month"></div>';
  }
  
  // 날짜 채우기
  for (let day = 1; day <= lastDate; day++) {
    const date = new Date(currentHabitYear, currentHabitMonth, day);
    const dateStr = date.toISOString().split('T')[0];
    const isToday = isCurrentMonth && day === todayDate;
    
    // 특정일 선택 모드에서 선택된 날짜인지 확인
    const isSelectedDate = selectedSpecificDates && selectedSpecificDates.includes(dateStr);
    
    calendarHTML += `
      <div class="habit-calendar-day ${isToday ? 'today' : ''} ${isSelectedDate ? 'specific-date-selected' : ''}">
        <div class="habit-day-number">${day}</div>
        <div class="habit-items" data-date="${dateStr}">
    `;
    
    // 오늘과 그 이전 날짜에만 습관 체크 항목 표시
    const isPastOrToday = new Date(dateStr) <= today;
    
    if (isPastOrToday) {
      // 해당 날짜에 체크 가능한 습관 목록 표시
      habits.forEach(habit => {
        // 해당 날짜에 이 습관이 체크 가능한지 확인
        if (isHabitScheduledForDate(habit, date)) {
          // 이 날짜에 습관이 완료되었는지 확인
          const isCompleted = isHabitCompletedOnDate(habit.id, dateStr);
          
          calendarHTML += `
            <div class="habit-item">
              <span class="habit-circle ${isCompleted ? 'completed' : 'missed'}" 
                    style="background-color: ${isCompleted ? habit.color : '#eee'}; border-color: ${habit.color};"
                    title="${habit.title}"></span>
              <span>${habit.title}</span>
            </div>
          `;
        }
      });
    }
    
    calendarHTML += '</div></div>';
  }
  
  // 마지막 주 이후의 빈 셀 채우기
  const lastDayOfWeek = lastDay.getDay();
  const remainingCells = 6 - lastDayOfWeek;
  
  for (let i = 0; i < remainingCells; i++) {
    calendarHTML += '<div class="habit-calendar-day other-month"></div>';
  }
  
  calendarHTML += '</div>';
  habitCalendar.innerHTML = calendarHTML;
  
  // 새 달력이 렌더링된 후에 특정일 모드에서 날짜 선택을 가능하게 함
  if (document.getElementById('habitFrequency')?.value === 'specific') {
    enableSpecificDateSelection();
  }
}

// 습관이 특정 날짜에 예정되어 있는지 확인
function isHabitScheduledForDate(habit, date) {
  const dateStr = date.toISOString().split('T')[0];
  const dayOfWeek = date.getDay(); // 0(일) ~ 6(토)
  
  switch (habit.frequency) {
    case 'daily':
      return true;
    case 'weekly':
      return habit.weekDays.includes(dayOfWeek);
    case 'monthly':
      // 매월 같은 날짜에 습관 체크
      const habitStartDate = new Date(habit.createdAt);
      return date.getDate() === habitStartDate.getDate();
    case 'specific':
      // 특정일 목록에 있는 날짜만 체크
      return habit.specificDates && habit.specificDates.includes(dateStr);
    default:
      return false;
  }
}

// 습관이 특정 날짜에 완료되었는지 확인
function isHabitCompletedOnDate(habitId, dateStr) {
  return habitRecords.some(record => 
    record.habitId === habitId && 
    record.date === dateStr && 
    record.completed
  );
}

// 오늘 습관 체크
function checkHabitToday(habitId) {
  const habit = habits.find(h => h.id === habitId);
  if (!habit) return;
  
  const today = new Date();
  const dateStr = today.toISOString().split('T')[0];
  
  // 해당 습관이 오늘 체크 가능한지 확인
  if (!isHabitScheduledForDate(habit, today)) {
    alert('오늘은 이 습관의 체크 날짜가 아닙니다.');
    return;
  }
  
  // 이미 체크한 경우
  const existingRecord = habitRecords.find(r => 
    r.habitId === habitId && r.date === dateStr
  );
  
  if (existingRecord) {
    // 토글: 체크되어 있으면 체크 해제, 아니면 체크
    existingRecord.completed = !existingRecord.completed;
    
    if (existingRecord.completed) {
      alert('오늘의 습관을 완료했습니다! 👍');
    } else {
      alert('습관 체크가 취소되었습니다.');
    }
  } else {
    // 새로운 기록 추가
    const newRecord = {
      habitId,
      date: dateStr,
      completed: true
    };
    
    habitRecords.push(newRecord);
    alert('오늘의 습관을 완료했습니다! 👍');
  }
  
  // 연속 달성 일수 업데이트
  updateHabitStreak(habit);
  
  // 저장 및 업데이트
  localStorage.setItem('habitRecords', JSON.stringify(habitRecords));
  saveToFirebase('habitRecords', habitRecords);
  
  renderHabits();
  renderHabitCalendar();
}

// 습관 연속 달성 일수 계산
function calculateHabitStreak(habit) {
  // 역순으로 날짜 확인 (오늘부터 과거로)
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  let streak = 0;
  let date = new Date(today);
  
  // 최대 365일까지만 체크 (무한 루프 방지)
  for (let i = 0; i < 365; i++) {
    const dateStr = date.toISOString().split('T')[0];
    
    // 해당 날짜에 습관 체크가 예정되어 있는지 확인
    if (isHabitScheduledForDate(habit, date)) {
      // 습관이 완료되었는지 확인
      const completed = isHabitCompletedOnDate(habit.id, dateStr);
      
      if (completed) {
        streak++;
      } else {
        // 완료되지 않은 날짜가 있으면 중단
        break;
      }
    }
    
    // 이전 날짜로 이동
    date.setDate(date.getDate() - 1);
  }
  
  return streak;
}

// 습관 연속 달성 일수 업데이트
function updateHabitStreak(habit) {
  const habitIndex = habits.findIndex(h => h.id === habit.id);
  if (habitIndex === -1) return;
  
  const streak = calculateHabitStreak(habit);
  habits[habitIndex].streak = streak;
  
  // 저장
  localStorage.setItem('habits', JSON.stringify(habits));
  saveToFirebase('habits', habits);
}

// 습관 기록 보기
function viewHabitHistory(habitId) {
  const habit = habits.find(h => h.id === habitId);
  if (!habit) return;
  
  // 해당 습관의 모든 기록 가져오기
  const records = habitRecords.filter(r => r.habitId === habitId);
  
  // 날짜순 정렬
  records.sort((a, b) => new Date(b.date) - new Date(a.date));
  
  let historyText = `${habit.title} 기록\n\n`;
  
  if (records.length === 0) {
    historyText += "아직 기록이 없습니다.";
  } else {
    records.forEach(record => {
      historyText += `${formatDate(record.date)}: ${record.completed ? '✓ 완료' : '✗ 미완료'}\n`;
    });
  }
  
  alert(historyText);
}

// 습관 삭제
function deleteHabit(habitId) {
  if (confirm('이 습관을 삭제하시겠습니까?')) {
    habits = habits.filter(h => h.id !== habitId);
    habitRecords = habitRecords.filter(r => r.habitId !== habitId);
    
    // 저장 및 업데이트
    localStorage.setItem('habits', JSON.stringify(habits));
    localStorage.setItem('habitRecords', JSON.stringify(habitRecords));
    
    saveToFirebase('habits', habits);
    saveToFirebase('habitRecords', habitRecords);
    
    renderHabits();
    renderHabitCalendar();
    
    alert('습관이 삭제되었습니다.');
  }
}

// 습관 달력 이전달/다음달 이동
function prevHabitMonth() {
  currentHabitMonth--;
  if (currentHabitMonth < 0) {
    currentHabitMonth = 11;
    currentHabitYear--;
  }
  renderHabitCalendar();
}

function nextHabitMonth() {
  currentHabitMonth++;
  if (currentHabitMonth > 11) {
    currentHabitMonth = 0;
    currentHabitYear++;
  }
  renderHabitCalendar();
}

// 습관 기능 초기화
function initializeHabitFunctions() {
  // 옵션 설정에 이벤트 리스너 추가
  const habitFrequency = document.getElementById('habitFrequency');
  if (habitFrequency) {
    habitFrequency.removeEventListener('change', toggleWeekdayOptions);
    habitFrequency.addEventListener('change', toggleWeekdayOptions);
  }
  
  const habitCategory = document.getElementById('habitCategory');
  if (habitCategory) {
    habitCategory.removeEventListener('change', toggleHabitCategoryInput);
    habitCategory.addEventListener('change', toggleHabitCategoryInput);
  }
  
  // 주간 옵션 라디오 버튼에 이벤트 리스너 추가
  const weekdayOptions = document.querySelectorAll('input[name="weekdayOption"]');
  weekdayOptions.forEach(option => {
    option.removeEventListener('change', toggleCustomWeekdays);
    option.addEventListener('change', toggleCustomWeekdays);
  });
  
  // 특정일 모드에서 달력 활성화
  if (habitFrequency?.value === 'specific') {
    enableSpecificDateSelection();
  }
}

// 날짜 포맷팅 유틸리티 함수
function formatDate(dateString) {
  const date = new Date(dateString);
  return `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`;
}

function formatDateTime(dateString) {
  const date = new Date(dateString);
  return `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일 ${date.getHours()}시 ${String(date.getMinutes()).padStart(2, '0')}분`;
}
</script>
</body>
</html>
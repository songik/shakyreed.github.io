
<!DOCTYPE html>

<html lang="ko">
<head>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCnHq4KAqxfu8ZzzzgW9o2hFcP_",
    authDomain: "song-homepage.firebaseapp.com",
    projectId: "song-homepage",
    storageBucket: "song-homepage.appspot.com",
    messagingSenderId: "596762043944",
    appId: "1:596762043944:web:e01fc8d0b8e62b4ad2cfcf",
    measurementId: "G-JS9M7Z3MCY"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const userId = "defaultUser";
</script>

<!-- Firebase App (the core Firebase SDK) -->



<!-- Firebase App (the core Firebase SDK) -->


<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>흔들갈대</title>
<style>
  body {
    margin: 0;
    font-family: 'Arial', sans-serif;
    background-color: #f0f0f0;
  }
  #password-screen {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100vh;
    background-color: #4a665b;
    color: #fff;
  }
  #password-screen input {
    padding: 10px;
    font-size: 16px;
    border: none;
    border-radius: 5px;
    margin-top: 10px;
  }
  #main-content {
    display: none;
  }

.habit-entry {
  margin-top: 5px;
  padding: 2px 6px;
  border-radius: 4px;
  display: inline-block;
  background-color: #ffecb3;
  cursor: pointer;
}
.habit-entry.selected {
  background-color: #c8e6c9;
}
</style>
<style>
/* 달력에서 선택된 날짜 스타일 */
.calendar-table td.selected {
    background-color: #e8f4f1;
    border: 2px solid #5f7561;
    box-shadow: 0 0 8px rgba(95, 117, 97, 0.3);
    position: relative;
}

.calendar-table td.selected::after {
    content: "";
    position: absolute;
    bottom: 4px;
    right: 4px;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #5f7561;
    animation: pulse 1.5s infinite;
}

.calendar-day.selected {
    background-color: #e8f4f1;
    border: 2px solid #5f7561 !important;
    box-shadow: 0 0 8px rgba(95, 117, 97, 0.3);
}

/* 오늘 날짜 스타일 */
.calendar-table td.today {
    background-color: #f5f0e5;
    border: 2px solid #e3b587;
}

.calendar-day.today {
    background-color: #f5f0e5;
    border: 2px solid #e3b587;
}

/* 호버 효과 */
.calendar-table td:hover {
    background-color: #f9f9f9;
    cursor: pointer;
    transform: scale(1.05);
    transition: all 0.2s ease;
    z-index: 5;
}

.calendar-day:hover {
    transform: scale(1.05) !important;
    z-index: 6;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

/* 펄스 애니메이션 */
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.3; }
    100% { opacity: 1; }
}
</style>



































<!-- Firebase App (the core Firebase SDK) -->


<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>흔들갈대 HOME</title>
<style>
        /* 기본 스타일 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, 'Nanum Gothic', sans-serif;
        }
        
        body {
            background-color: #d7d5cb;
            color: #2c3e50;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.15);
            border-radius: 8px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        header {
            background-color: #5f7561;
            color: white;
            padding: 30px 0;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(95, 117, 97, 0.7);
            z-index: 1;
        }
        
        header h1, header p {
            position: relative;
            z-index: 2;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        nav {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
            background-color: #34403a;
            padding: 12px;
            border-radius: 8px;
            flex-wrap: wrap;
        }
        
        nav a {
            color: white;
            text-decoration: none;
            padding: 10px 18px;
            margin: 5px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        nav a:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .active {
            background-color: #9ab39c;
            color: #34403a;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        h2 {
            color: #34403a;
            margin-bottom: 20px;
        }
        
        /* 일기장 스타일 */
        .diary-entry {
            background-color: #f9f9f9;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border-left: 4px solid #9ab39c;
        }
        
        .diary-date {
            font-weight: bold;
            color: #5f7561;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .diary-content {
            white-space: pre-wrap;
            line-height: 1.7;
        }
        
        .diary-meta {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: #888;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        
        /* 버튼 스타일 */
        button {
            background-color: #5f7561;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 5px;
        }
        
        button:hover {
            background-color: #34403a;
        }
        
        button.delete-btn {
            background-color: #e74c3c;
        }
        
        /* 폼 스타일 */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        /* 할일 스타일 */
        .todo-item {
            background-color: #f9f9f9;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #9ab39c;
        }
        
        .todo-text {
            flex: 1;
            display: flex;
            align-items: center;
        }
        
        .todo-text input[type="checkbox"] {
            margin-right: 10px;
        }
        
        /* 달력 공통 스타일 */
        .calendar-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed; /* 칸 크기 고정 */
        }
        
        .calendar-table th {
            background-color: #f0f0f0;
            padding: 8px;
            border: 1px solid #ddd;
        }
        
        .calendar-table td {
            border: 1px solid #ddd;
            height: 80px; /* 고정 높이 */
            vertical-align: top;
            position: relative;
            width: 14.28%; /* 모든 열의 너비를 동일하게 */
            overflow: hidden; /* 내용이 넘치면 숨김 */
        }
        
        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
        }
        
        .calendar-title {
            font-weight: bold;
        }
        
        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }
        
/* 체중 기록 중앙 정렬 스타일 */
.weight-entry {
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 16px;
    font-weight: bold;
    color: #3b82f6;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: rgba(235, 245, 251, 0.7);
    padding: 4px 8px;
    border-radius: 5px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    z-index: 2;
}

/* 달력 셀 위치 관련 설정 */
.calendar-table td {
    border: 1px solid #ddd;
    height: 80px;
    vertical-align: top;
    position: relative;
    width: 14.28%;
    overflow: visible; /* 체중 표시가 잘리지 않도록 변경 */
}

        /* 할일 달력 스타일 */
        .todo-entry {
            display: flex;
            align-items: center;
            font-size: 12px;
            margin-top: 4px;
            max-width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .todo-entry input[type="checkbox"] {
            margin-right: 4px;
            flex-shrink: 0;
        }
        
        .todo-text.completed {
            text-decoration: line-through;
            color: #888;
        }
        
        /* 스케줄 관리 스타일 */
        .schedule {
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }
        
        .schedule table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            border-radius: 5px;
        }
        
        .schedule th, .schedule td {
            border: 1px solid #e0e0e0;
            padding: 14px;
            text-align: left;
        }
        
        .schedule th {
            background-color: #9ab39c;
            color: white;
            font-weight: 500;
        }
        
        .schedule tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .schedule tr:hover {
            background-color: #d7d5cb;
        }
        
        .schedule-form {
            margin-top: 25px;
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #9ab39c;
        }
        
        /* 스케줄 보기 방식 */
        .schedule-view-options {
            margin-top: 35px;
        }
        
        .view-options {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .view-option {
            background-color: #d7d5cb;
            border: 1px solid #d0d5d1;
            color: #34403a;
            padding: 10px 18px;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 5px;
            font-weight: 500;
        }
        
        .view-option.active {
            background-color: #5f7561;
            color: white;
            border-color: #5f7561;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }
        
        .schedule-view {
            display: none;
        }
        
        .schedule-view.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 달력 스타일 */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background-color: #9ab39c;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            color: white;
        }
        
        .calendar-header button {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .calendar-header button:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .calendar-grid {
            border: 1px solid #e0e0e0;
            border-radius: 0 0 8px 8px;
            overflow: hidden;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.05);
        }
        
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background-color: #d7d5cb;
            font-weight: bold;
        }
        
        .day-name {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .calendar-dates {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-auto-rows: minmax(120px, auto);
            background-color: white;
        }
        
        .calendar-day {
            border: 1px solid #e0e0e0;
            padding: 8px;
            min-height: 120px;
            background-color: white;
            position: relative;
            transition: all 0.2s;
        }
        
        .calendar-day:hover {
            background-color: #f9f9f9;
            transform: scale(1.02);
            z-index: 5;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .day-number {
            position: absolute;
            top: 8px;
            right: 8px;
            font-weight: bold;
            color: #34403a;
        }
        
        .calendar-day.today {
            background-color: #e8f4f1;
            border: 2px solid #9ab39c;
        }
        
        .calendar-day.other-month {
            background-color: #f9f9f9;
            color: #bbb;
        }
        
        .calendar-day.selected {
            background-color: #f5f0e5;
            border: 2px solid #e3b587;
        }
        
        .calendar-day.has-events {
            position: relative;
        }
        
        .calendar-day.has-events::after {
            content: "";
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #e3b587;
            border-radius: 50%;
            top: 8px;
            left: 8px;
            box-shadow: 0 0 5px rgba(227, 181, 135, 0.7);
        }
        
        .event-list {
            margin-top: 25px;
            font-size: 0.85rem;
            overflow: hidden;
        }
        
        .event-item {
            background-color: #5f7561;
            color: white;
            padding: 4px 8px;
            margin-bottom: 3px;
            border-radius: 3px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }
        
        .event-item:hover {
            transform: translateX(3px);
            background-color: #34403a;
        }
        
        .event-details {
            margin-top: 25px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.05);
        }
        
        .event-day-item {
            background-color: white;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #9ab39c;
            transition: all 0.2s;
        }
        
        .event-day-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .event-time {
            font-weight: bold;
            color: #5f7561;
            margin-bottom: 5px;
        }
        
        .no-events {
            font-style: italic;
            color: #999;
            text-align: center;
            padding: 15px;
        }
        
        /* 가계부 스타일 */
        .accountbook {
            margin-bottom: 30px;
        }
        
        .accountbook-form {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #9ab39c;
        }
        
        .accountbook-list {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .accountbook-list th {
            background-color: #eef;
            padding: 10px;
            text-align: left;
        }
        
        .accountbook-list td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .accountbook-list tr:hover {
            background-color: #f5f5f5;
        }
        
        .accountbook-summary {
            margin: 20px 0;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        
        .chart-container {
            background-color: #fdfdfd;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 5px rgba(0,0,0,0.05);
            margin: 20px auto;
            max-width: 650px;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            background-color: #34403a;
            color: white;
            border-radius: 8px;
        }

        /* 헤더 이미지 스타일 */
        .header-image {
            position: relative;
            z-index: 2;
            max-width: 100%;
            height: auto;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
/* 검색 결과 스타일 */
.search-results {
  margin-top: 20px;
}

.search-result-item {
  background-color: #f9f9f9;
  padding: 15px;
  margin-bottom: 10px;
  border-radius: 8px;
  border-left: 4px solid #9ab39c;
}

.search-result-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
}

.search-result-category {
  font-size: 0.85rem;
  padding: 2px 8px;
  background-color: #5f7561;
  color: white;
  border-radius: 4px;
}

.search-result-date {
  color: #777;
  font-size: 0.85rem;
}

.search-result-title {
  font-weight: bold;
  margin-bottom: 5px;
}

.search-result-content {
  margin-bottom: 10px;
}

.search-result-highlight {
  background-color: #fff3cd;
  padding: 0 2px;
  border-radius: 2px;
}

.no-results {
  text-align: center;
  color: #888;
  padding: 20px;
}

/* 목표 스타일 */
.goal-item {
  background-color: #f9f9f9;
  padding: 20px;
  margin-bottom: 20px;
  border-radius: 8px;
  border-left: 4px solid #9ab39c;
}

.goal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.goal-title {
  font-weight: bold;
  font-size: 1.1rem;
  color: #34403a;
}

.goal-category {
  padding: 4px 8px;
  background-color: #5f7561;
  color: white;
  border-radius: 4px;
  font-size: 0.85rem;
}

.goal-info {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  margin-bottom: 15px;
}

.goal-info-item {
  flex: 1;
  min-width: 100px;
}

.goal-info-label {
  font-size: 0.8rem;
  color: #777;
}

.goal-info-value {
  font-weight: bold;
  color: #333;
}

.goal-progress {
  margin-bottom: 15px;
}

.goal-progress-bar {
  height: 20px;
  background-color: #eee;
  border-radius: 10px;
  overflow: hidden;
  margin-top: 5px;
}

.goal-progress-fill {
  height: 100%;
  background-color: #5f7561;
  border-radius: 10px;
  width: 0%;
  transition: width 0.5s ease;
}

.goal-controls {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

/* 습관 스타일 */
.habit-calendar {
  margin-top: 15px;
  background-color: white;
  border-radius: 8px;
  padding: 15px;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
}

.habit-calendar-header {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  text-align: center;
  font-weight: bold;
  margin-bottom: 10px;
}

.habit-calendar-body {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 5px;
}

.habit-calendar-day {
  background-color: #f9f9f9;
  border-radius: 5px;
  padding: 10px 5px;
  min-height: 100px;
  position: relative;
}

.habit-calendar-day.other-month {
  background-color: #f0f0f0;
  color: #bbb;
}

.habit-calendar-day.today {
  background-color: #e8f4f1;
  border: 2px solid #9ab39c;
}

.habit-day-number {
  position: absolute;
  top: 5px;
  right: 5px;
  font-weight: bold;
  font-size: 0.85rem;
}

.habit-items {
  margin-top: 20px;
}

.habit-item {
  margin-bottom: 5px;
  font-size: 0.85rem;
  display: flex;
  align-items: center;
}

.habit-checkbox {
  margin-right: 5px;
  cursor: pointer;
}

.habit-checkbox.completed {
  color: #5f7561;
}

.habit-list-item {
  background-color: #f9f9f9;
  padding: 15px;
  margin-bottom: 15px;
  border-radius: 8px;
  border-left: 4px solid #9ab39c;
}

.habit-list-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.habit-list-title {
  font-weight: bold;
  color: #34403a;
}

.habit-list-category {
  padding: 3px 6px;
  background-color: #5f7561;
  color: white;
  border-radius: 4px;
  font-size: 0.8rem;
}

.habit-streak {
  margin-top: 10px;
  padding: 8px;
  background-color: #e8f4f1;
  border-radius: 5px;
  text-align: center;
}

.habit-streak-number {
  font-size: 1.1rem;
  font-weight: bold;
  color: #5f7561;
}

.habit-list-controls {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 10px;
}

/* 습관 원형 표시 스타일 */
.habit-circle {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  margin-right: 5px;
  display: inline-block;
  vertical-align: middle;
}

.habit-circle.completed {
  background-color: #5f7561;
  border: 2px solid #34403a;
}

.habit-circle.missed {
  background-color: #e74c3c;
  border: 2px solid #c0392b;
}

.habit-circle.future {
  background-color: #eee;
  border: 2px solid #ddd;
}

.habit-circle.not-scheduled {
  background-color: #f9f9f9;
  border: 2px solid #ddd;
}
    </style>

































<script>
  

  if (!firebase.apps.length) {
    
  }

  const db = ;
  
  localStorage.setItem("uid", userId);

  function saveToFirebase(key, data) {
    db.ref(`${userId}/${key}`).set(data);
  }

  function loadFromFirebase(key, callback) {
    db.ref(`${userId}/${key}`).once('value').then(snapshot => {
      callback(snapshot.val());
    });
  }

  window.addEventListener('load', function() {
    const keys = ["diaries", "memos", "goals", "schedules", "habits", "moneybook"];
    const renderMap = {
      diaries: typeof renderDiaryList === "function" ? renderDiaryList : null,
      memos: typeof renderMemoList === "function" ? renderMemoList : null,
      goals: typeof renderGoalList === "function" ? renderGoalList : null,
      schedules: typeof renderScheduleList === "function" ? renderScheduleList : null,
      habits: typeof renderHabitList === "function" ? renderHabitList : null,
      moneybook: typeof renderMoneybookList === "function" ? renderMoneybookList : null
    };

    keys.forEach(key => {
      loadFromFirebase(key, function(data) {
        if (data) {
          try {
            localStorage.setItem(key, JSON.stringify(data));
            if (renderMap[key]) renderMap[key]();
          } catch (e) {
            console.warn("Firebase 데이터 불러오기 오류:", e);
          }
        }
      });
    });
  });

  const originalSetItem = localStorage.setItem;
  localStorage.setItem = function(key, value) {
    const validKeys = ["diaries", "memos", "goals", "schedules", "habits", "moneybook"];
    if (validKeys.includes(key)) {
      try {
        saveToFirebase(key, JSON.parse(value));
      } catch (e) {
        console.warn("Firebase 저장 오류:", e);
      }
    }
    originalSetItem.apply(this, arguments);
  };
</script>


<!-- Firebase SDK -->
</script>
</script>

<script>
  

  if (!firebase.apps.length) {
    
  }

  
  
  localStorage.setItem("uid", userId);

  function saveToFirebase(key, data) {
    db.ref(`${userId}/${key}`).set(data);
  }

  function loadFromFirebase(key, callback) {
    db.ref(`${userId}/${key}`).once('value').then(snapshot => {
      callback(snapshot.val());
    });
  }

  window.addEventListener('load', function() {
    const keys = ["diaries", "memos", "goals", "schedules", "habits", "moneybook"];
    const renderMap = {
      diaries: typeof renderDiaryList === "function" ? renderDiaryList : null,
      memos: typeof renderMemoList === "function" ? renderMemoList : null,
      goals: typeof renderGoalList === "function" ? renderGoalList : null,
      schedules: typeof renderScheduleList === "function" ? renderScheduleList : null,
      habits: typeof renderHabitList === "function" ? renderHabitList : null,
      moneybook: typeof renderMoneybookList === "function" ? renderMoneybookList : null
    };

    keys.forEach(key => {
      loadFromFirebase(key, function(data) {
        if (data) {
          try {
            localStorage.setItem(key, JSON.stringify(data));
            if (renderMap[key]) renderMap[key]();
          } catch (e) {
            console.warn("Firebase 불러오기 오류:", e);
          }
        }
      });
    });
  });

  const originalSetItem = localStorage.setItem;
  localStorage.setItem = function(key, value) {
    const validKeys = ["diaries", "memos", "goals", "schedules", "habits", "moneybook"];
    if (validKeys.includes(key)) {
      try {
        saveToFirebase(key, JSON.parse(value));
      } catch (e) {
        console.warn("Firebase 저장 오류:", e);
      }
    }
    originalSetItem.apply(this, arguments);
  };
</script>

</head>
<body onload="loadInitialData()">
<!-- 메인 컨텐츠 -->
<div class="container">
<header><img src="logo.png" style="height: 60px; margin-bottom: 10px;"/>
<p id="preview-text">헛되이 보낸 오늘은, 죽은이가 그토록 바라던 내일이었다</p>
<audio autoplay="" hidden="" id="bgm" loop="" src="bgm.mp3"></audio>
</header>
<nav>
<a class="nav-link active" href="#" onclick="showTab('home')">HOME</a>
<a class="nav-link" href="#" onclick="showTab('schedule')">스케줄</a>
<a class="nav-link" href="#" onclick="showTab('diary')">기록</a>
<a class="nav-link" href="#" onclick="showTab('memo')">메모</a>
<a class="nav-link" href="#" onclick="showTab('todo')">뭐해?</a>
<a class="nav-link" href="#" onclick="showTab('weight')">그만먹어</a>
<a class="nav-link" href="#" onclick="showTab('accountbook')">그만써</a>
<a class="nav-link" href="#" onclick="showTab('search')">검색</a>
<a class="nav-link" href="#" onclick="showTab('goals')">목표</a>
<a class="nav-link" href="#" onclick="showTab('habits')">습관</a>
</nav>
<!-- 탭 컨텐츠 -->
<div class="tab-content active" id="home"><div style="text-align: center; margin-top: 20px;"><video autoplay="True" loop="True" muted="True" style="width: 40%; height: auto; border-radius: 12px; box-shadow: 0 0 20px rgba(0,0,0,0.2);"><source src="video.mp4" type="video/mp4"/>동영상을 재생할 수 없습니다.</video></div></div>
<!-- 스케줄 탭 -->
<div class="tab-content" id="schedule">
<h2>내 스케줄</h2>
<div class="schedule">
<div class="schedule-form">
<h3>새 일정 추가</h3>
<div class="form-group">
<label for="eventTitle">제목</label>
<input id="eventTitle" placeholder="일정 제목을 입력하세요" type="text"/>
</div>
<div class="form-group">
<label for="eventDate">날짜</label>
<input id="eventDate" type="date"/>
</div>
<div class="form-group">
<label for="eventTime">시간</label>
<input id="eventTime" type="time"/>
</div>
<div class="form-group">
<label for="eventDescription">상세 내용</label>
<textarea id="eventDescription" placeholder="일정에 대한 상세 내용을 입력하세요" rows="3"></textarea>
</div>
<button id="addScheduleBtn">일정 추가</button>
</div>
<!-- 스케줄 보기 방식 선택 -->
<div class="schedule-view-options">
<h3>일정 보기</h3>
<div class="view-options">
<button class="view-option active" id="viewListBtn">리스트 형식</button>
<button class="view-option" id="viewCalendarBtn">달력 형식</button>
</div>
</div>
<!-- 리스트 형식 보기 -->
<div class="schedule-view active" id="listView">
<h3>다가오는 일정</h3>
<table id="scheduleTable">
<thead>
<tr>
<th>날짜</th>
<th>시간</th>
<th>제목</th>
<th>상세 내용</th>
<th>작업</th>
</tr>
</thead>
<tbody>
<!-- 일정 항목이 여기에 동적으로 추가됩니다 -->
</tbody>
</table>
</div>
<!-- 달력 형식 보기 -->
<div class="schedule-view" id="calendarView">
<div class="calendar-header">
<button id="prevMonthBtn">&lt;</button>
<h3 id="currentMonthYear">2025년 4월</h3>
<button id="nextMonthBtn">&gt;</button>
</div>
<div class="calendar-grid">
<div class="calendar-days">
<div class="day-name">일</div>
<div class="day-name">월</div>
<div class="day-name">화</div>
<div class="day-name">수</div>
<div class="day-name">목</div>
<div class="day-name">금</div>
<div class="day-name">토</div>
</div>
<div class="calendar-dates" id="calendarDays">
<!-- 달력 날짜가 여기에 동적으로 생성됩니다 -->
</div>
</div>
<div class="event-details" id="eventDetails">
<h3>일정 상세 정보</h3>
<div id="selectedDateEvents">
<!-- 선택된 날짜의 일정이 표시됩니다 -->
<p class="no-events">날짜를 선택하면 일정이 표시됩니다.</p>
</div>
</div>
</div>
</div>
</div>
<!-- 기록(일기) 탭 -->
<div class="tab-content" id="diary">
<h2>일기장</h2>
<div class="form-group">
<label for="diaryDate">날짜</label>
<input id="diaryDate" type="date"/>
</div>
<div class="form-group">
<label for="diaryContent">내용</label>
<textarea id="diaryContent" placeholder="오늘의 일기를 작성하세요..." rows="6"></textarea>
</div>
<button onclick="saveDiary()">저장</button>
<h3 style="margin-top: 30px;">내 일기 목록</h3>
<div id="diaryEntries">
<!-- 일기 항목이 여기에 동적으로 추가됩니다 -->
</div>
</div>
<!-- 메모 탭 -->
<div class="tab-content" id="memo">
<h2>메모장</h2>
<div class="form-group">
<label for="memoTitle">제목</label>
<input id="memoTitle" placeholder="메모 제목" type="text"/>
</div>
<div class="form-group">
<label for="memoContent">내용</label>
<textarea id="memoContent" placeholder="메모 내용을 작성하세요..." rows="4"></textarea>
</div>
<button onclick="saveMemo()">저장</button>
<h3 style="margin-top: 30px;">내 메모 목록</h3>
<div id="memoList">
<!-- 메모 항목이 여기에 동적으로 추가됩니다 -->
</div>
</div>
<!-- 할일 탭 (이름 변경: 할일 -> 뭐해?) -->
<div class="tab-content" id="todo">
<h2>뭐해? (할 일 목록)</h2>
<div class="form-group" style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
<div style="flex: 1;">
<input id="todoInput" placeholder="할 일을 입력하세요" style="width: 100%;" type="text"/>
</div>
<div>
<label for="todoDate">날짜:</label>
<input id="todoDate" style="margin-left: 5px;" type="date"/>
</div>
<button onclick="addTodo()" style="width: auto;">추가</button>
</div>
<div id="editTodoForm" style="display: none; background-color: #d7d5cb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
<h3 style="margin-top: 0;">할 일 수정</h3>
<div class="form-group">
<input id="editTodoInput" type="text"/>
<div style="margin-top: 10px;">
<label for="editTodoDate">날짜:</label>
<input id="editTodoDate" type="date"/>
</div>
<input id="editTodoId" type="hidden"/>
</div>
<div style="display: flex; justify-content: flex-end; gap: 10px;">
<button onclick="updateTodo()">수정 완료</button>
<button onclick="cancelEdit()" style="background-color: #95a5a6;">취소</button>
</div>
</div>
<div id="todoList" style="margin-top: 20px;">
<!-- 할 일 항목이 여기에 동적으로 추가됩니다 -->
</div>
<h3 style="margin-top: 30px;">달력 보기 (간단 표시)</h3>
<div class="calendar-nav">
<button onclick="prevTodoMonth()">◀ 이전달</button>
<span class="calendar-title" id="todoCalendarHeader"></span>
<button onclick="nextTodoMonth()">다음달 ▶</button>
</div>
<table class="calendar-table" id="todoCalendarTable">
<thead>
<tr>
<th>일</th><th>월</th><th>화</th><th>수</th><th>목</th><th>금</th><th>토</th>
</tr>
</thead>
<tbody id="todoCalendarBody"></tbody>
</table>
</div>
<!-- 체중 기록 탭 -->
<div class="tab-content" id="weight">
<h2>⚖️ 체중 기록</h2>
<div id="weightArea">
<div class="form-group" style="display: flex; flex-wrap: wrap; align-items: center; gap: 12px; margin-bottom: 20px;">
<label for="weightDate">날짜</label>
<input id="weightDate" required="" type="date"/>
<label for="weightValue">체중 (kg)</label>
<input id="weightValue" required="" step="0.1" type="number"/>
<button onclick="saveWeight()">기록하기</button>
</div>
<h3>📅 달력 보기</h3>
<div class="calendar-nav">
<button onclick="prevWeightMonth()">◀ 이전 달</button>
<div class="calendar-title" id="calendarTitle">2025년 4월</div>
<button onclick="nextWeightMonth()">다음 달 ▶</button>
</div>
<table class="calendar-table" id="weightCalendarTable">
<thead>
<tr>
<th>일</th><th>월</th><th>화</th><th>수</th><th>목</th><th>금</th><th>토</th>
</tr>
</thead>
<tbody id="calendarBody"></tbody>
</table>
<div class="weight-list-section" style="margin-top: 30px;">
<h3>📋 체중 기록 목록</h3>
<div id="weightListContainer" style="margin-top: 15px;"></div>
</div>
</div>
</div>
<!-- 가계부 탭 (추가) -->
<div class="tab-content" id="accountbook">
<h2>📒 나의 가계부</h2>
<div class="accountbook">
<div class="accountbook-form">
<div class="form-group">
<label for="ab-date">날짜</label>
<input class="form-input" id="ab-date" type="date"/>
</div>
<div class="form-group">
<label for="ab-amount">금액</label>
<input class="form-input" id="ab-amount" type="number"/>
</div>
<div class="form-group">
<label for="ab-type">종류</label>
<select class="form-input" id="ab-type">
<option value="income">수입</option>
<option value="expense">지출</option>
</select>
</div>
<div class="form-group">
<label for="ab-category">카테고리</label>
<select id="ab-category" name="ab-category">
<option value="식비(장보기)">식비(장보기)</option>
<option value="쿠폰 구매">쿠폰 구매</option>
<option value="주전부리">주전부리</option>
<option value="쇼핑">쇼핑</option>
<option value="음식_배달">음식_배달</option>
<option value="음식_온라인 구매">음식_온라인 구매</option>
<option value="외식">외식</option>
<option value="의료비">의료비</option>
<option value="인간관계">인간관계</option>
<option value="운동">운동</option>
<option value="교통비">교통비</option>
<option value="집 관련 물품">집 관련 물품</option>
<option value="가족비">가족비</option>
<option value="매달 고정비">매달 고정비</option>
<option value="문화 생활">문화 생활</option>
<option value="자기계발">자기계발</option>
<option value="업무용">업무용</option>
<option value="공용">공용</option>
<option value="차량 유지비">차량 유지비</option>
<option value="구독">구독</option>
<option value="기타">기타</option>
</select>
</div>
<div class="form-group">
<label for="ab-method">결제 방법</label>
<select id="ab-method" name="ab-method">
<option value="현대카드">현대카드</option>
<option value="삼성카드">삼성카드</option>
<option value="롯데카드">롯데카드</option>
<option value="신한카드">신한카드</option>
<option value="계좌">계좌</option>
<option value="현금">현금</option>
<option value="기타">기타</option>
</select>
</div>
<div class="form-group">
<label for="ab-memo">메모</label>
<textarea id="ab-memo" rows="3"></textarea>
</div>
<button id="ab-submit">기록하기</button>
</div>
<h3>📅 달력 보기</h3>
<div id="ab-calendar" style="min-height:600px; height:600px; margin-bottom:20px; background-color: #f9f9f9; border-radius: 8px; padding: 10px;"></div>
<h3>📃 내역 리스트</h3>
<table class="accountbook-list" id="ab-list">
<thead>
<tr>
<th>날짜</th><th>금액</th><th>종류</th><th>카테고리</th><th>결제</th><th>메모</th><th>작업</th>
</tr>
</thead>
<tbody>
<!-- 가계부 항목이 여기에 동적으로 추가됩니다 -->
</tbody>
</table>
<div class="accountbook-summary" id="ab-summary">
<strong>이번 달 수입:</strong> 0원 | <strong>지출:</strong> 0원
                </div>
<h3>📊 통계 보기</h3>
<div class="chart-container">
<canvas height="200" id="ab-month-summary" style="max-width:600px; margin:20px auto; display:block;"></canvas>
</div>
<div class="chart-container">
<canvas height="200" id="ab-category-summary" style="max-width:600px; margin:20px auto; display:block;"></canvas>
</div>
<div class="chart-container">
<canvas height="200" id="ab-method-summary" style="max-width:600px; margin:20px auto; display:block;"></canvas>
</div>
</div>
</div>
<!-- 검색 탭 -->
<div class="tab-content" id="search">
<h2>🔍 통합 검색</h2>
<div class="form-group">
<div style="display: flex; gap: 10px; margin-bottom: 20px;">
<input id="searchInput" placeholder="검색어를 입력하세요" style="flex: 1;" type="text"/>
<select class="form-control" id="searchType" style="width: 120px;">
<option value="all">전체</option>
<option value="diary">일기</option>
<option value="memo">메모</option>
<option value="todo">할일</option>
<option value="schedule">일정</option>
<option value="accountbook">가계부</option>
<option value="goals">목표</option>
<option value="habits">습관</option>
</select>
<button onclick="performSearch()">검색</button>
</div>
</div>
<div class="search-results" id="searchResults">
<p class="no-results">검색 결과가 여기에 표시됩니다.</p>
</div>
</div>
<!-- 목표 설정 탭 -->
<div class="tab-content" id="goals">
<h2>🎯 목표 설정 및 추적</h2>
<!-- 목표 추가 폼 -->
<div class="form-group" style="background-color: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #9ab39c;">
<h3 style="margin-top: 0;">새 목표 추가</h3>
<div style="display: flex; flex-wrap: wrap; gap: 15px;">
<div style="flex: 1; min-width: 200px;">
<label for="goalTitle">목표 제목</label>
<input id="goalTitle" placeholder="목표를 입력하세요" type="text"/>
</div>
<div style="flex: 1; min-width: 200px;">
<label for="goalCategory">카테고리</label>
<select id="goalCategory" onchange="toggleCategoryInput()">
<option value="weight">체중</option>
<option value="finance">재정</option>
<option value="study">공부</option>
<option value="fitness">운동</option>
<option value="custom">직접 입력</option>
</select>
<!-- 직접 입력 필드 추가 -->
<input id="goalCustomCategory" placeholder="카테고리 직접 입력" style="display: none; margin-top: 8px; width: 100%;" type="text"/>
</div>
</div>
<div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px;">
<div style="flex: 1; min-width: 200px;">
<label for="goalStartValue">시작 값</label>
<input id="goalStartValue" placeholder="현재 값" step="0.01" type="number"/>
</div>
<div style="flex: 1; min-width: 200px;">
<label for="goalTargetValue">목표 값</label>
<input id="goalTargetValue" placeholder="목표 값" step="0.01" type="number"/>
</div>
<div style="flex: 1; min-width: 200px;">
<label for="goalUnit">단위</label>
<input id="goalUnit" placeholder="kg, 만원, 시간 등" type="text"/>
</div>
</div>
<div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px;">
<div style="flex: 1; min-width: 200px;">
<label for="goalStartDate">시작일</label>
<input id="goalStartDate" type="date"/>
</div>
<div style="flex: 1; min-width: 200px;">
<label for="goalEndDate">목표일</label>
<input id="goalEndDate" type="date"/>
</div>
</div>
<div style="margin-top: 15px;">
<label for="goalDescription">상세 설명</label>
<textarea id="goalDescription" placeholder="목표에 대한 자세한 설명을 입력하세요" rows="3"></textarea>
</div>
<div style="margin-top: 15px; text-align: right;">
<button onclick="addGoal()">목표 추가</button>
</div>
</div>
<!-- 목표 진행 상황 -->
<h3>📊 내 목표 현황</h3>
<div class="goals-list" id="goalsList">
<!-- 목표 항목이 여기에 동적으로 추가됩니다 -->
<p class="no-goals" style="text-align: center; color: #888; padding: 20px;">아직 설정된 목표가 없습니다. 새로운 목표를 추가해보세요!</p>
</div>
<!-- 목표 업데이트 폼 -->
<div id="goalUpdateForm" style="display: none; background-color: #d7d5cb; padding: 15px; border-radius: 8px; margin: 20px 0;">
<h3 style="margin-top: 0;">목표 진행 상황 업데이트</h3>
<div style="display: flex; gap: 15px; margin-top: 15px;">
<div style="flex: 1;">
<label for="goalUpdateValue">현재 값</label>
<input id="goalUpdateValue" step="0.01" type="number"/>
</div>
<div style="flex: 1;">
<label for="goalUpdateDate">날짜</label>
<input id="goalUpdateDate" type="date"/>
</div>
<input id="goalUpdateId" type="hidden"/>
</div>
<div style="margin-top: 15px; text-align: right;">
<button onclick="updateGoalProgress()">업데이트</button>
<button onclick="closeGoalUpdateForm()" style="background-color: #95a5a6;">취소</button>
</div>
</div>
<!-- 세부 항목 추가 폼 (동적으로 추가될 예정) -->
<div id="subTaskForm" style="display: none; background-color: #d7d5cb; padding: 15px; border-radius: 8px; margin: 20px 0;">
<h3 style="margin-top: 0;">세부 항목 추가</h3>
<div style="margin-bottom: 15px;">
<label for="subTaskTitle">항목 이름</label>
<input id="subTaskTitle" style="width: 100%; margin-top: 5px; padding: 8px; border-radius: 5px; border: 1px solid #ccc;" type="text"/>
</div>
<input id="subTaskGoalId" type="hidden"/>
<div style="text-align: right;">
<button onclick="addSubTask()">추가</button>
<button onclick="closeSubTaskForm()" style="background-color: #95a5a6;">취소</button>
</div>
</div>
</div>
<!-- 습관 추적 탭 -->
<div class="tab-content" id="habits">
<h2>🔄 습관 추적</h2>
<!-- 습관 추가 폼 -->
<div class="form-group" style="background-color: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #9ab39c;">
<h3 style="margin-top: 0;">새 습관 추가</h3>
<div style="display: flex; flex-wrap: wrap; gap: 15px;">
<div style="flex: 1; min-width: 200px;">
<label for="habitTitle">습관 이름</label>
<input id="habitTitle" placeholder="습관을 입력하세요" type="text"/>
</div>
<div style="flex: 1; min-width: 200px;">
<label for="habitCategory">카테고리</label>
<select id="habitCategory" onchange="toggleHabitCategoryInput()">
<option value="health">건강</option>
<option value="study">공부</option>
<option value="selfcare">자기관리</option>
<option value="work">업무</option>
<option value="custom">직접 입력</option>
</select>
<!-- 직접 입력 필드 추가 -->
<input id="habitCustomCategory" placeholder="카테고리 직접 입력" style="display: none; margin-top: 8px; width: 100%;" type="text"/>
</div>
</div>
<div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px;">
<div style="flex: 1; min-width: 200px;">
<label for="habitFrequency">주기</label>
<select id="habitFrequency" onchange="toggleWeekdayOptions()">
<option value="daily">매일</option>
<option value="weekly">매주</option>
<option value="monthly">매월</option>
</select>
</div>
<!-- 주간 옵션 선택 (주 5일 또는 직접 선택) -->
<div id="weekdayOptionContainer" style="flex: 2; min-width: 300px; display: none;">
<label>주간 옵션</label>
<div style="display: flex; gap: 15px; margin-top: 5px;">
<label style="display: flex; align-items: center;">
<input checked="" id="weekdaysOption" name="weekdayOption" onchange="toggleCustomWeekdays()" type="radio" value="weekdays"/> 
            주 5일 (월-금)
          </label>
<label style="display: flex; align-items: center;">
<input id="customDaysOption" name="weekdayOption" onchange="toggleCustomWeekdays()" type="radio" value="custom"/> 
            직접 선택
          </label>
</div>
</div>
</div>
<!-- 요일 직접 선택 컨테이너 -->
<div id="customWeekdaysContainer" style="margin-top: 15px; display: none;">
<label>요일 선택</label>
<div style="display: flex; gap: 8px; margin-top: 5px;">
<label style="display: flex; align-items: center;"><input class="habitWeekDay" type="checkbox" value="0"/> 일</label>
<label style="display: flex; align-items: center;"><input class="habitWeekDay" type="checkbox" value="1"/> 월</label>
<label style="display: flex; align-items: center;"><input class="habitWeekDay" type="checkbox" value="2"/> 화</label>
<label style="display: flex; align-items: center;"><input class="habitWeekDay" type="checkbox" value="3"/> 수</label>
<label style="display: flex; align-items: center;"><input class="habitWeekDay" type="checkbox" value="4"/> 목</label>
<label style="display: flex; align-items: center;"><input class="habitWeekDay" type="checkbox" value="5"/> 금</label>
<label style="display: flex; align-items: center;"><input class="habitWeekDay" type="checkbox" value="6"/> 토</label>
</div>
</div>
<div style="margin-top: 15px;">
<label for="habitDescription">상세 설명</label>
<textarea id="habitDescription" placeholder="습관에 대한 자세한 설명을 입력하세요" rows="2"></textarea>
</div>
<div style="margin-top: 15px; text-align: right;">
<button onclick="addHabit()">습관 추가</button>
</div>
</div>
<!-- 습관 달력 -->
<h3>📅 이번 달 습관 달력</h3>
<div class="calendar-nav">
<button onclick="prevHabitMonth()">◀ 이전달</button>
<span class="calendar-title" id="habitCalendarHeader"></span>
<button onclick="nextHabitMonth()">다음달 ▶</button>
</div>
<div class="habit-calendar" id="habitCalendar">
<!-- 습관 달력이 여기에 동적으로 생성됩니다 -->
</div>
<!-- 습관 목록 -->
<h3 style="margin-top: 30px;">📋 내 습관 목록</h3>
<div class="habits-list" id="habitsList">
<!-- 습관 항목이 여기에 동적으로 추가됩니다 -->
<p class="no-habits" style="text-align: center; color: #888; padding: 20px;">아직 추가된 습관이 없습니다. 새로운 습관을 추가해보세요!</p>
</div>
</div>
<!-- 홈화면 설정 탭 -->
</div>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.0/main.min.js">
function toggleHabit(element) {
    element.classList.toggle("selected");
    if (element.classList.contains("selected")) {
        element.textContent = "✅ 줌바";
    } else {
        element.textContent = "🟠 줌바";
    }
}
</script>
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.0/main.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
        // 전역 변수
        let diaries = [];
        let memos = [];
        let todos = [];
        let schedules = [];
        let accountData = []; // 가계부 데이터 추가
        let currentCalendarYear = new Date().getFullYear();
        let currentCalendarMonth = new Date().getMonth();
        let currentTodoYear = new Date().getFullYear();
        let currentTodoMonth = new Date().getMonth();
        let currentScheduleYear = new Date().getFullYear();
        let currentScheduleMonth = new Date().getMonth();
        let selectedDate = null;
        
        // 초기 데이터 로드
        function loadInitialData() {
            document.getElementById("ab-submit")?.addEventListener("click", addAccountItem);

document.getElementById("addScheduleBtn")?.addEventListener("click", addSchedule);

            document.getElementById("ab-submit")?.addEventListener("click", addAccountItem);
            // 로컬 스토리지에서 데이터 로드
            loadDataFromLocalStorage();
            
            loadDiaries();
            loadMemos();
            renderTodos();
            renderTodoCalendar();
            renderWeightCalendar();
            renderWeightList();
            loadSchedules();
            renderScheduleCalendar();
            loadAccountData(); // 가계부 데이터 로드
            applyCustomHome();
            
            // 기본 날짜 설정
            const today = new Date().toISOString().split('T')[0];
            if (document.getElementById('diaryDate')) document.getElementById('diaryDate').value = today;
            if (document.getElementById('weightDate')) document.getElementById('weightDate').value = today;
            if (document.getElementById('eventDate')) document.getElementById('eventDate').value = today;
            if (document.getElementById('ab-date')) document.getElementById('ab-date').value = today;

            // 이벤트 리스너 설정
            document.getElementById('save-button').addEventListener('click', saveCustomHome);
            document.getElementById('addScheduleBtn').addEventListener('click', addSchedule);
            document.getElementById('viewListBtn').addEventListener('click', showListView);
            document.getElementById('viewCalendarBtn').addEventListener('click', showCalendarView);
            document.getElementById('prevMonthBtn').addEventListener('click', prevScheduleMonth);
            document.getElementById('nextMonthBtn').addEventListener('click', nextScheduleMonth);
            
            // 가계부 이벤트 리스너 설정
            if (document.getElementById('ab-submit')) {
                document.getElementById('ab-submit').addEventListener('click', addAccountItem);
            }
            
            // 필요한 외부 라이브러리 로드
            loadRequiredLibraries();
        }
        
        // 필요한 외부 라이브러리 로드 함수
        function loadRequiredLibraries() {
            // FullCalendar 라이브러리 로드
            if (typeof FullCalendar === 'undefined') {
                // CSS 먼저 로드
                const style = document.createElement('link');
                style.rel = 'stylesheet';
                style.href = 'https://cdn.jsdelivr.net/npm/fullcalendar@5.10.0/main.min.css';
                document.head.appendChild(style);
                
                // 그 다음 JS 로드
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/fullcalendar@5.10.0/main.min.js';
                script.onload = function() {
                    // 가계부 탭이 현재 활성화되어 있는 경우에만 달력 초기화
                    if (document.getElementById('accountbook').classList.contains('active')) {
                        // FullCalendar 초기화 전에 약간의 지연 추가
                        setTimeout(function() {
                            // 달력 컨테이너를 초기화
                            const calendarEl = document.getElementById('ab-calendar');
                            if (calendarEl) {
                                calendarEl.innerHTML = '';
                                initializeAccountCalendar();
                            }
                        }, 200);
                    }
                };
                document.head.appendChild(script);
            } else if (document.getElementById('accountbook').classList.contains('active')) {
                // FullCalendar가 이미 로드되어 있지만 달력이 표시되지 않는 경우
                setTimeout(function() {
                    const calendarEl = document.getElementById('ab-calendar');
                    if (calendarEl && !calendarEl.querySelector('.fc')) {
                        calendarEl.innerHTML = '';
                        initializeAccountCalendar();
                    }
                }, 200);
            }
            
            // Chart.js 라이브러리 로드
            if (typeof Chart === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                script.onload = function() {
                    // 가계부 탭이 현재 활성화되어 있는 경우에만 차트 업데이트
                    if (document.getElementById('accountbook').classList.contains('active')) {
                        createCharts();
                    }
                };
                document.head.appendChild(script);
            }
        }
        
        // 로컬 스토리지에서 데이터 로드
        function loadDataFromLocalStorage() {
            try {
                diaries = JSON.parse(localStorage.getItem('diaries')) || [];
                memos = JSON.parse(localStorage.getItem('memos')) || [];
                todos = JSON.parse(localStorage.getItem('todos')) || [];
                schedules = JSON.parse(localStorage.getItem('schedules')) || [];
                accountData = JSON.parse(localStorage.getItem('accountData')) || []; // 가계부 데이터 추가
            } catch (e) {
                console.error('데이터 로드 중 오류 발생:', e);
                diaries = [];
                memos = [];
                todos = [];
                schedules = [];
                accountData = [];
            }
        }
        
        // 탭 전환 기능
        function showTab(tabId) {
            // 모든 탭 비활성화
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // 선택된 탭 활성화
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.nav-link[onclick="showTab('${tabId}')"]`).classList.add('active');
            
            // 필요한 경우 탭 초기화
            if (tabId === 'diary') loadDiaries();
            if (tabId === 'memo') loadMemos();
            if (tabId === 'todo') {
                renderTodos();
                renderTodoCalendar();
            }
            if (tabId === 'weight') {
                renderWeightCalendar();
                renderWeightList();
            }
            
if (tabId === 'schedule') {
    loadSchedules();
    renderScheduleCalendar();

    // 버튼 리스너 수동 재등록
    const calBtn = document.getElementById('viewCalendarBtn');
    const listBtn = document.getElementById('viewListBtn');
    if (calBtn) {
        calBtn.removeEventListener('click', showCalendarView);
        calBtn.addEventListener('click', showCalendarView);
    }
    if (listBtn) {
        listBtn.removeEventListener('click', showListView);
        listBtn.addEventListener('click', showListView);
    }

            }
            if (tabId === 'accountbook') {
                loadAccountData();
                
                // 달력이 표시되지 않는 문제 해결
                setTimeout(function() {
                    try {
                        const abCalendar = document.getElementById('ab-calendar');
                        if (abCalendar) {
                            // 달력이 제대로 렌더링되지 않았는지 확인
                            const fcContent = abCalendar.querySelector('.fc');
                            if (!fcContent || fcContent.offsetHeight < 10) {
                                console.log("달력 다시 초기화 중...");
                                initializeAccountCalendar();
                            }
                        }
                    } catch (e) {
                        console.error("달력 확인 오류:", e);
                        initializeAccountCalendar();
                    }
                }, 300);
            }
        }
        
        /********** 일기장 기능 **********/
        function saveDiary() {
            const date = document.getElementById('diaryDate').value;
            const content = document.getElementById('diaryContent').value;
            
            if (!date || !content) {
                alert('날짜와 내용을 모두 입력해주세요.');
                return;
            }
            
            // 같은 날짜의 일기가 있는지 확인
            const existingIndex = diaries.findIndex(diary => diary.date === date);
            
            if (existingIndex !== -1) {
                if (confirm('같은 날짜의 일기가 이미 존재합니다. 덮어쓰시겠습니까?')) {
                    diaries[existingIndex].content = content;
                    diaries[existingIndex].updatedAt = new Date().toISOString();
                } else {
                    return;
                }
            } else {
                const diary = {
                    id: Date.now(),
                    date,
                    content,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                diaries.push(diary);
            }
            
            try {
                localStorage.setItem('diaries', JSON.stringify(diaries));
                
                // 입력 필드 초기화
                document.getElementById('diaryContent').value = '';
                
                loadDiaries();
                alert('일기가 저장되었습니다.');
            } catch (e) {
                console.error('일기 저장 중 오류 발생:', e);
                alert('일기 저장 중 오류가 발생했습니다.');
            }
        }
        
        function loadDiaries() {
            const diaryEntries = document.getElementById('diaryEntries');
            if (!diaryEntries) return;
            
            diaryEntries.innerHTML = '';
            
            // 날짜 내림차순으로 정렬 (최신 일기가 위에 표시)
            diaries.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (diaries.length === 0) {
                diaryEntries.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">저장된 일기가 없습니다.</p>';
                return;
            }
            
            diaries.forEach(diary => {
                const entry = document.createElement('div');
                entry.className = 'diary-entry';
                entry.innerHTML = `
                    <div class="diary-date">${formatDate(diary.date)}</div>
                    <div class="diary-content">${diary.content}</div>
                    <div class="diary-meta">
                        마지막 수정: ${formatDateTime(diary.updatedAt)}
                        <div>
                            <button onclick="editDiary(${diary.id})">수정</button>
                            <button class="delete-btn" onclick="deleteDiary(${diary.id})">삭제</button>
                        </div>
                    </div>
                `;
                
                diaryEntries.appendChild(entry);
            });
        }
        
        function editDiary(id) {
            const diary = diaries.find(d => d.id === id);
            if (!diary) return;
            
            document.getElementById('diaryDate').value = diary.date;
            document.getElementById('diaryContent').value = diary.content;
            
            window.scrollTo(0, 0);
            
            // 원래 일기 삭제 (저장 시 새로 추가됨)
            deleteDiaryWithoutConfirm(id);
        }
        
        function deleteDiary(id) {
            if (confirm('이 일기를 삭제하시겠습니까?')) {
                deleteDiaryWithoutConfirm(id);
                alert('일기가 삭제되었습니다.');
            }
        }
        
        function deleteDiaryWithoutConfirm(id) {
            diaries = diaries.filter(diary => diary.id !== id);
            localStorage.setItem('diaries', JSON.stringify(diaries));
            loadDiaries();
        }
        
        /********** 메모 기능 **********/
        function saveMemo() {
            const title = document.getElementById('memoTitle').value;
            const content = document.getElementById('memoContent').value;
            
            if (!title || !content) {
                alert('제목과 내용을 모두 입력해주세요.');
                return;
            }
            
            const memo = {
                id: Date.now(),
                title,
                content,
                createdAt: new Date().toISOString()
            };
            
            memos.push(memo);
            
            try {
                localStorage.setItem('memos', JSON.stringify(memos));
                
                document.getElementById('memoTitle').value = '';
                document.getElementById('memoContent').value = '';
                
                loadMemos();
                alert('메모가 저장되었습니다.');
            } catch (e) {
                console.error('메모 저장 중 오류 발생:', e);
                alert('메모 저장 중 오류가 발생했습니다.');
            }
        }
        
        function loadMemos() {
            const memoList = document.getElementById('memoList');
            if (!memoList) return;
            
            memoList.innerHTML = '';
            
            memos.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            if (memos.length === 0) {
                memoList.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">저장된 메모가 없습니다.</p>';
                return;
            }
            
            memos.forEach(memo => {
                const memoDiv = document.createElement('div');
                memoDiv.className = 'diary-entry';
                memoDiv.innerHTML = `
                    <div class="diary-date">${memo.title}</div>
                    <div class="memo-content">${memo.content}</div>
                    <div class="diary-meta">
                        작성일: ${formatDateTime(memo.createdAt)}
                        <div>
                            <button onclick="editMemo(${memo.id})">수정</button>
                            <button class="delete-btn" onclick="deleteMemo(${memo.id})">삭제</button>
                        </div>
                    </div>
                `;
                
                memoList.appendChild(memoDiv);
            });
        }
        
        function editMemo(id) {
            const memo = memos.find(m => m.id === id);
            if (!memo) return;
            
            document.getElementById('memoTitle').value = memo.title;
            document.getElementById('memoContent').value = memo.content;
            
            window.scrollTo(0, 0);
            
            // 원래 메모 삭제 (저장 시 새로 추가됨)
            deleteMemoWithoutConfirm(id);
        }
        
        function deleteMemo(id) {
            if (confirm('이 메모를 삭제하시겠습니까?')) {
                deleteMemoWithoutConfirm(id);
                alert('메모가 삭제되었습니다.');
            }
        }
        
        function deleteMemoWithoutConfirm(id) {
            memos = memos.filter(memo => memo.id !== id);
            localStorage.setItem('memos', JSON.stringify(memos));
            loadMemos();
        }
        
        /********** 할일 기능 **********/
function addTodo() {
    const todoInput = document.getElementById('todoInput');
    const todoDateInput = document.getElementById('todoDate');
    const text = todoInput.value.trim();
    
    if (!text) {
        alert('할 일을 입력해주세요.');
        return;
    }
    
    // 사용자가 선택한 날짜 또는 오늘 날짜 사용
    const todoDate = todoDateInput && todoDateInput.value ? todoDateInput.value : new Date().toISOString().split('T')[0];
    
    const todo = {
        id: Date.now(),
        text: text,
        completed: false,
        date: todoDate, // 선택한 날짜 저장
        createdAt: new Date().toISOString()
    };
    
    todos.push(todo);
    
    try {
        localStorage.setItem('todos', JSON.stringify(todos));
        
        todoInput.value = '';
        // 날짜 필드는 초기화하지 않고 유지
        
        renderTodos();
        renderTodoCalendar();
        
        alert('할 일이 추가되었습니다.');
    } catch (e) {
        console.error('할일 저장 중 오류 발생:', e);
        alert('할일 저장 중 오류가 발생했습니다.');
    }
}
        
        function renderTodos() {
            const todoList = document.getElementById('todoList');
            if (!todoList) return;
            
            todoList.innerHTML = '';
            
            if (todos.length === 0) {
                todoList.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">할 일이 없습니다. 새로운 할 일을 추가해보세요!</p>';
                return;
            }
            
            todos.sort((a, b) => {
                // 완료되지 않은 항목 먼저
                if (a.completed !== b.completed) {
                    return a.completed ? 1 : -1;
                }
                // 그 다음으로는 최신순
                return new Date(b.createdAt) - new Date(a.createdAt);
            });
            
            todos.forEach(todo => {
                const todoItem = document.createElement('div');
                todoItem.className = 'todo-item';
                todoItem.innerHTML = `
                    <div class="todo-text ${todo.completed ? 'completed' : ''}">
                        <input type="checkbox" ${todo.completed ? 'checked' : ''} onchange="toggleTodo(${todo.id})">
                        <span>${todo.text}</span>
                    </div>
                    <div>
                        <button onclick="editTodo(${todo.id})">수정</button>
                        <button class="delete-btn" onclick="deleteTodo(${todo.id})">삭제</button>
                    </div>
                `;
                
                todoList.appendChild(todoItem);
            });
        }
        
       function renderTodoCalendar() {
    const todoCalendarBody = document.getElementById('todoCalendarBody');
    const todoCalendarHeader = document.getElementById('todoCalendarHeader');
    
    if (!todoCalendarBody || !todoCalendarHeader) return;
    
    todoCalendarHeader.textContent = `${currentTodoYear}년 ${currentTodoMonth + 1}월`;
    
    const firstDay = new Date(currentTodoYear, currentTodoMonth, 1).getDay();
    const daysInMonth = new Date(currentTodoYear, currentTodoMonth + 1, 0).getDate();
    
    todoCalendarBody.innerHTML = '';
    
    let row = document.createElement('tr');
    
    // 첫 주의 빈 셀 채우기
    for (let i = 0; i < firstDay; i++) {
        const td = document.createElement('td');
        row.appendChild(td);
    }
    
    // 날짜 채우기
    for (let day = 1; day <= daysInMonth; day++) {
        const td = document.createElement('td');
        
        // 해당 날짜 문자열
        const dateStr = `${currentTodoYear}-${String(currentTodoMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        // 클릭 이벤트 추가 - 해당 날짜를 할일 입력란에 설정
        td.addEventListener('click', function() {
            if (document.getElementById('todoDate')) {
                document.getElementById('todoDate').value = dateStr;
                document.getElementById('todoInput').focus();
            }
            
            // 모든 선택된 셀 초기화
            document.querySelectorAll('#todoCalendarBody td.selected').forEach(cell => {
                cell.classList.remove('selected');
            });
            
            // 현재 셀 선택 표시
            this.classList.add('selected');
        });
        
        // 오늘 날짜 강조
        const today = new Date().toISOString().split('T')[0];
        if (dateStr === today) {
            td.classList.add('today');
        }
        
        // 날짜 숫자 표시
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = day;
        td.appendChild(dayNumber);
        
        // 해당 날짜의 할일 체크
        const todosForDate = todos.filter(todo => todo.date === dateStr);
        
        // 할일이 있으면 체크박스로 표시
        if (todosForDate.length > 0) {
            const todoContainer = document.createElement('div');
            
            todosForDate.forEach(todo => {
                const todoDiv = document.createElement('div');
                todoDiv.className = 'todo-entry';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = todo.completed;

                checkbox.onclick = function(e) {
                    e.stopPropagation();
                    toggleTodoInCalendar(todo.id);
                };

                const textSpan = document.createElement('span');
                textSpan.textContent = todo.text;
                textSpan.style.overflow = 'hidden';
                textSpan.style.textOverflow = 'ellipsis';
                textSpan.style.whiteSpace = 'nowrap';

                if (todo.completed) {
                    textSpan.style.textDecoration = 'line-through';
                    textSpan.style.color = '#888';
                }

                todoDiv.appendChild(checkbox);
                todoDiv.appendChild(textSpan);
                todoContainer.appendChild(todoDiv);
            });
            
            td.appendChild(todoContainer);
        }
        
        row.appendChild(td);
        
        // 토요일이나 월의 마지막 날이면 새 행 시작
        if ((firstDay + day) % 7 === 0 || day === daysInMonth) {
            todoCalendarBody.appendChild(row);
            if (day !== daysInMonth) {
                row = document.createElement('tr');
            }
        }
    }
}
        
        function toggleTodo(id) {
            const todo = todos.find(t => t.id === id);
            if (todo) {
                todo.completed = !todo.completed;
                localStorage.setItem('todos', JSON.stringify(todos));
                renderTodos();
                renderTodoCalendar();
            }
        }
        
        function toggleTodoInCalendar(id) {
            const todo = todos.find(t => t.id === id);
            if (todo) {
                todo.completed = !todo.completed;
                localStorage.setItem('todos', JSON.stringify(todos));
                renderTodos();
                renderTodoCalendar();
            }
        }
        
function editTodo(id) {
    const todo = todos.find(t => t.id === id);
    if (!todo) return;
    
    const editForm = document.getElementById('editTodoForm');
    const editInput = document.getElementById('editTodoInput');
    const editId = document.getElementById('editTodoId');
    
    // 날짜 필드 확인 및 설정
    const editDateInput = document.getElementById('editTodoDate');
    
    editForm.style.display = 'block';
    editInput.value = todo.text;
    editId.value = todo.id;
    
    // 날짜 필드가 있으면 값 설정
    if (editDateInput) {
        editDateInput.value = todo.date;
    }
    
    editForm.scrollIntoView({ behavior: 'smooth' });
}
        
function updateTodo() {
    const editInput = document.getElementById('editTodoInput');
    const editId = document.getElementById('editTodoId');
    
    // 날짜 입력란 찾기
    const editDateInput = document.getElementById('editTodoDate');
    
    const text = editInput.value.trim();
    const id = parseInt(editId.value);
    
    if (!text) {
        alert('할 일을 입력해주세요.');
        return;
    }
    
    const todoIndex = todos.findIndex(t => t.id === id);
    if (todoIndex !== -1) {
        todos[todoIndex].text = text;
        
        // 날짜 필드가 있으면 값 업데이트
        if (editDateInput && editDateInput.value) {
            todos[todoIndex].date = editDateInput.value;
        }
        
        try {
            localStorage.setItem('todos', JSON.stringify(todos));
            
            document.getElementById('editTodoForm').style.display = 'none';
            
            renderTodos();
            renderTodoCalendar();
            
            alert('할 일이 수정되었습니다.');
        } catch (e) {
            console.error('할일 수정 중 오류 발생:', e);
            alert('할일 수정 중 오류가 발생했습니다.');
        }
    }
}
        
        function cancelEdit() {
            document.getElementById('editTodoForm').style.display = 'none';
        }
        
        function deleteTodo(id) {
            if (confirm('이 할 일을 삭제하시겠습니까?')) {
                todos = todos.filter(todo => todo.id !== id);
                localStorage.setItem('todos', JSON.stringify(todos));
                renderTodos();
                renderTodoCalendar();
                alert('할 일이 삭제되었습니다.');
            }
        }
        
        function prevTodoMonth() {
            currentTodoMonth--;
            if (currentTodoMonth < 0) {
                currentTodoMonth = 11;
                currentTodoYear--;
            }
            renderTodoCalendar();
        }
        
        function nextTodoMonth() {
            currentTodoMonth++;
            if (currentTodoMonth > 11) {
                currentTodoMonth = 0;
                currentTodoYear++;
            }
            renderTodoCalendar();
        }
        
        /********** 체중 기록 기능 **********/
        function saveWeight() {
            const date = document.getElementById('weightDate').value;
            const value = document.getElementById('weightValue').value;
            
            if (!date || !value) {
                alert('날짜와 체중을 모두 입력해주세요.');
                return;
            }
            
            let weightData = {};
            try {
                weightData = JSON.parse(localStorage.getItem('weightRecords') || '{}');
            } catch (e) {
                console.error('체중 데이터 로드 중 오류 발생:', e);
                weightData = {};
            }
            
            if (weightData[date] && !confirm(`${formatDate(date)}에 이미 체중이 기록되어 있습니다. 덮어쓰시겠습니까?`)) {
                return;
            }
            
            weightData[date] = parseFloat(value);
            
            try {
                localStorage.setItem('weightRecords', JSON.stringify(weightData));
                
                document.getElementById('weightValue').value = '';
                
                renderWeightCalendar();
                renderWeightList();
                
                alert('체중이 기록되었습니다.');
            } catch (e) {
                console.error('체중 저장 중 오류 발생:', e);
                alert('체중 저장 중 오류가 발생했습니다.');
            }
        }
        
        function renderWeightCalendar() {
            let weightData = {};
            try {
                weightData = JSON.parse(localStorage.getItem('weightRecords') || '{}');
            } catch (e) {
                console.error('체중 데이터 로드 중 오류 발생:', e);
                weightData = {};
            }
            
            const body = document.getElementById('calendarBody');
            const title = document.getElementById('calendarTitle');
            
            if (!body || !title) return;
            
            title.textContent = `${currentCalendarYear}년 ${currentCalendarMonth + 1}월`;
            
            body.innerHTML = '';
        
            const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1).getDay();
            const daysInMonth = new Date(currentCalendarYear, currentCalendarMonth + 1, 0).getDate();
        
            let row = document.createElement('tr');
            
            // 첫 주의 빈 셀 채우기
            for (let i = 0; i < firstDay; i++) {
                const td = document.createElement('td');
                row.appendChild(td);
            }
        
            // 날짜 채우기
            for (let day = 1; day <= daysInMonth; day++) {
                const td = document.createElement('td');
                const dateKey = `${currentCalendarYear}-${String(currentCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                // 날짜 표시
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                td.appendChild(dayNumber);
                
                // 체중 기록이 있으면 표시 (수정/삭제 버튼 없음)
                if (weightData[dateKey]) {
                    const weightDiv = document.createElement('div');
                    weightDiv.className = 'weight-entry';
                    weightDiv.textContent = weightData[dateKey] + "kg";
                    td.appendChild(weightDiv);
                }
                
                row.appendChild(td);
                
                // 토요일이나 월의 마지막 날이면 새 행 시작
                if ((firstDay + day) % 7 === 0 || day === daysInMonth) {
                    body.appendChild(row);
                    if (day !== daysInMonth) {
                        row = document.createElement('tr');
                    }
                }
            }
        }
        
        function renderWeightList() {
            const container = document.getElementById('weightListContainer');
            if (!container) return;
            
            let weightData = {};
            try {
                weightData = JSON.parse(localStorage.getItem('weightRecords') || '{}');
            } catch (e) {
                console.error('체중 데이터 로드 중 오류 발생:', e);
                weightData = {};
            }
            
            const entries = Object.entries(weightData).map(([date, weight]) => ({ date, weight }));
            
            if (entries.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888;">기록된 체중이 없습니다.</p>';
                return;
            }
            
            entries.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.marginBottom = '20px';
            table.style.background = 'white';
            
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr style="background-color: #f0f0f0;">
                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">날짜</th>
                    <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">체중</th>
                    <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">관리</th>
                </tr>
            `;
            table.appendChild(thead);
            
            const tbody = document.createElement('tbody');
            entries.forEach(entry => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding: 10px; border: 1px solid #ddd;">${formatDate(entry.date)}</td>
                    <td style="padding: 10px; text-align: center; border: 1px solid #ddd; font-weight: bold;">${entry.weight} kg</td>
                    <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">
                        <button onclick="editWeight('${entry.date}', ${entry.weight})">수정</button>
                        <button class="delete-btn" onclick="deleteWeight('${entry.date}')">삭제</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            
            container.innerHTML = '';
            container.appendChild(table);
        }
        
        function editWeight(dateKey, currentValue) {
            const newWeight = prompt(`${formatDate(dateKey)}의 체중을 수정합니다. 새 체중을 입력하세요:`, currentValue);
            
            if (newWeight !== null && !isNaN(newWeight) && newWeight.trim() !== '') {
                let weightData = {};
                try {
                    weightData = JSON.parse(localStorage.getItem('weightRecords') || '{}');
                } catch (e) {
                    console.error('체중 데이터 로드 중 오류 발생:', e);
                    weightData = {};
                }
                
                weightData[dateKey] = parseFloat(newWeight);
                
                try {
                    localStorage.setItem('weightRecords', JSON.stringify(weightData));
                    
                    renderWeightCalendar();
                    renderWeightList();
                    
                    alert('체중 기록이 수정되었습니다.');
                } catch (e) {
                    console.error('체중 수정 중 오류 발생:', e);
                    alert('체중 수정 중 오류가 발생했습니다.');
                }
            }
        }
        
        function deleteWeight(dateKey) {
            if (confirm(`${formatDate(dateKey)}의 체중 기록을 삭제하시겠습니까?`)) {
                let weightData = {};
                try {
                    weightData = JSON.parse(localStorage.getItem('weightRecords') || '{}');
                } catch (e) {
                    console.error('체중 데이터 로드 중 오류 발생:', e);
                    weightData = {};
                }
                
                delete weightData[dateKey];
                
                try {
                    localStorage.setItem('weightRecords', JSON.stringify(weightData));
                    
                    renderWeightCalendar();
                    renderWeightList();
                    
                    alert('체중 기록이 삭제되었습니다.');
                } catch (e) {
                    console.error('체중 삭제 중 오류 발생:', e);
                    alert('체중 삭제 중 오류가 발생했습니다.');
                }
            }
        }
        
        function prevWeightMonth() {
            currentCalendarMonth--;
            if (currentCalendarMonth < 0) {
                currentCalendarMonth = 11;
                currentCalendarYear--;
            }
            renderWeightCalendar();
        }
        
        function nextWeightMonth() {
            currentCalendarMonth++;
            if (currentCalendarMonth > 11) {
                currentCalendarMonth = 0;
                currentCalendarYear++;
            }
            renderWeightCalendar();
        }

        /********** 스케줄 관리 기능 **********/
        function addSchedule() {
            const title = document.getElementById('eventTitle').value;
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const description = document.getElementById('eventDescription').value;
            
            if (!title || !date) {
                alert('제목과 날짜는 필수입니다.');
                return;
            }
            
            const schedule = {
                id: Date.now(),
                title,
                date,
                time,
                description
            };
            
            schedules.push(schedule);
            localStorage.setItem('schedules', JSON.stringify(schedules));
            
            // 입력 필드 초기화
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventTime').value = '';
            document.getElementById('eventDescription').value = '';
            
            // 다양한 보기 모드 업데이트
            loadSchedules();
            renderScheduleCalendar();
            
            alert('일정이 추가되었습니다.');
        }

        function loadSchedules() {
            const tbody = document.querySelector('#scheduleTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // 날짜순으로 정렬
            schedules.sort((a, b) => new Date(a.date + ' ' + (a.time || '00:00')) - new Date(b.date + ' ' + (b.time || '00:00')));
            
            if (schedules.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">등록된 일정이 없습니다.</td></tr>';
                return;
            }
            
            schedules.forEach(schedule => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${formatDate(schedule.date)}</td>
                    <td>${schedule.time || '-'}</td>
                    <td>${schedule.title}</td>
                    <td>${schedule.description || '-'}</td>
                    <td>
                        <button onclick="editSchedule(${schedule.id})">수정</button>
                        <button class="delete-btn" onclick="deleteSchedule(${schedule.id})">삭제</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function editSchedule(id) {
            const schedule = schedules.find(s => s.id === id);
            if (!schedule) return;
            
            document.getElementById('eventTitle').value = schedule.title;
            document.getElementById('eventDate').value = schedule.date;
            document.getElementById('eventTime').value = schedule.time || '';
            document.getElementById('eventDescription').value = schedule.description || '';
            
            // 해당 일정 삭제 (저장 시 새로 추가됨)
            deleteScheduleWithoutConfirm(id);
            
            // 스크롤을 맨 위로 이동
            window.scrollTo(0, 0);
            
            // 탭 전환
            showTab('schedule');
        }

        function deleteSchedule(id) {
            if (confirm('이 일정을 삭제하시겠습니까?')) {
                deleteScheduleWithoutConfirm(id);
                alert('일정이 삭제되었습니다.');
            }
        }

        function deleteScheduleWithoutConfirm(id) {
            schedules = schedules.filter(schedule => schedule.id !== id);
            localStorage.setItem('schedules', JSON.stringify(schedules));
            loadSchedules();
            renderScheduleCalendar();
            
            // 선택된 날짜가 있다면 해당 날짜의 이벤트 목록 업데이트
            if (selectedDate) {
                const selectedDateObj = new Date(currentScheduleYear, currentScheduleMonth, selectedDate);
                showEventsForDate(selectedDateObj);
            }
        }

        
function showCalendarView() {
    document.getElementById('viewListBtn')?.classList.remove('active');
    document.getElementById('viewCalendarBtn')?.classList.add('active');
    document.getElementById('listView')?.classList.remove('active');
    document.getElementById('calendarView')?.classList.add('active');

    renderScheduleCalendar();
}


        function showListView() {
            document.getElementById('viewListBtn').classList.add('active');
            document.getElementById('viewCalendarBtn').classList.remove('active');
            document.getElementById('listView').classList.add('active');
            document.getElementById('calendarView').classList.remove('active');
        }

function renderScheduleCalendar() {
    const calendarDays = document.getElementById('calendarDays');
    const currentMonthYear = document.getElementById('currentMonthYear');
    
    if (!calendarDays || !currentMonthYear) return;
    
    // 월/년 헤더 설정
    currentMonthYear.textContent = `${currentScheduleYear}년 ${currentScheduleMonth + 1}월`;
    
    // 현재 월의 첫날
    const firstDay = new Date(currentScheduleYear, currentScheduleMonth, 1);
    
    // 현재 월의 마지막 날
    const lastDay = new Date(currentScheduleYear, currentScheduleMonth + 1, 0);
    
    // 첫날의 요일 (0: 일요일, 6: 토요일)
    const firstDayWeekday = firstDay.getDay();
    
    // 달력 셀 초기화
    calendarDays.innerHTML = '';
    
    // 이전 달 날짜 채우기
    for (let i = 0; i < firstDayWeekday; i++) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day other-month';
        dayDiv.innerHTML = `<div class="day-number"></div>`;
        calendarDays.appendChild(dayDiv);
    }
    
    // 오늘 날짜 정보
    const today = new Date();
    const todayDate = today.getDate();
    const todayMonth = today.getMonth();
    const todayYear = today.getFullYear();
    
    // 현재 달 날짜 채우기
    for (let i = 1; i <= lastDay.getDate(); i++) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day';
        
        // 오늘 날짜 표시
        if (i === todayDate && currentScheduleMonth === todayMonth && currentScheduleYear === todayYear) {
            dayDiv.classList.add('today');
        }
        
        // 선택된 날짜 표시
        if (i === selectedDate && currentScheduleMonth === currentScheduleMonth && currentScheduleYear === currentScheduleYear) {
            dayDiv.classList.add('selected');
        }
        
        // 날짜에 해당하는 이벤트 확인
        const dateString = `${currentScheduleYear}-${String(currentScheduleMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
        const dateEvents = schedules.filter(schedule => schedule.date === dateString);
        
        // 이벤트가 있으면 표시
        if (dateEvents.length > 0) {
            dayDiv.classList.add('has-events');
            
            // 이벤트 항목 추가 (모든 이벤트 표시)
            const eventListDiv = document.createElement('div');
            eventListDiv.className = 'event-list';
            
            // 모든 이벤트 표시 (제한 없음)
            for (let j = 0; j < dateEvents.length; j++) {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'event-item';
                eventDiv.textContent = dateEvents[j].title;
                eventListDiv.appendChild(eventDiv);
            }
            
            dayDiv.appendChild(eventListDiv);
        }
        
        // 날짜 번호 추가
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = i;
        dayDiv.appendChild(dayNumber);
        
        // 클릭 이벤트 추가
        dayDiv.addEventListener('click', function() {
            // 이전에 선택된 날짜 클래스 제거
            const selectedDays = document.querySelectorAll('.calendar-day.selected');
            selectedDays.forEach(day => day.classList.remove('selected'));
            
            // 현재 선택된 날짜 표시
            this.classList.add('selected');
            selectedDate = i;
            
            // 선택된 날짜의 이벤트 표시
            const selectedDateObj = new Date(currentScheduleYear, currentScheduleMonth, i);
            showEventsForDate(selectedDateObj);
        });
        
        calendarDays.appendChild(dayDiv);
    }
    
    // 다음 달 날짜 채우기 (6주 채우기)
    const usedCells = firstDayWeekday + lastDay.getDate();
    const remainingCells = 42 - usedCells; // 7일 * 6주 = 42
    
    for (let i = 1; i <= remainingCells; i++) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day other-month';
        dayDiv.innerHTML = `<div class="day-number"></div>`;
        calendarDays.appendChild(dayDiv);
    }
}

        function showEventsForDate(date) {
            const selectedDateEvents = document.getElementById('selectedDateEvents');
            if (!selectedDateEvents) return;
            
            const dateString = date.toISOString().split('T')[0];
            
            // 해당 날짜의 이벤트 필터링
            const dateEvents = schedules.filter(schedule => schedule.date === dateString);
            
            // 이벤트 목록 초기화
            selectedDateEvents.innerHTML = '';
            
            // 날짜 헤더 추가
            const dateHeader = document.createElement('h4');
            dateHeader.textContent = formatDate(dateString);
            selectedDateEvents.appendChild(dateHeader);
            
            if (dateEvents.length === 0) {
                const noEvents = document.createElement('p');
                noEvents.className = 'no-events';
                noEvents.textContent = '이 날짜에는 일정이 없습니다.';
                selectedDateEvents.appendChild(noEvents);
            } else {
                // 시간순으로 정렬
                dateEvents.sort((a, b) => {
                    if (!a.time) return 1;
                    if (!b.time) return -1;
                    return a.time.localeCompare(b.time);
                });
                
                // 이벤트 목록 생성
                dateEvents.forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = 'event-day-item';
                    
                    eventDiv.innerHTML = `
                        <div class="event-time">${event.time || '종일'}</div>
                        <div class="event-title">${event.title}</div>
                        ${event.description ? `<div class="event-desc">${event.description}</div>` : ''}
                        <div style="text-align: right; margin-top: 10px;">
                            <button onclick="editSchedule(${event.id})">수정</button>
                            <button class="delete-btn" onclick="deleteSchedule(${event.id})">삭제</button>
                        </div>
                    `;
                    
                    selectedDateEvents.appendChild(eventDiv);
                });
            }
        }

        function prevScheduleMonth() {
            currentScheduleMonth--;
            if (currentScheduleMonth < 0) {
                currentScheduleMonth = 11;
                currentScheduleYear--;
            }
            renderScheduleCalendar();
            
            // 선택된 날짜 초기화
            selectedDate = null;
            document.getElementById('selectedDateEvents').innerHTML = '<p class="no-events">날짜를 선택하면 일정이 표시됩니다.</p>';
        }

        function nextScheduleMonth() {
            currentScheduleMonth++;
            if (currentScheduleMonth > 11) {
                currentScheduleMonth = 0;
                currentScheduleYear++;
            }
            renderScheduleCalendar();
            
            // 선택된 날짜 초기화
            selectedDate = null;
            document.getElementById('selectedDateEvents').innerHTML = '<p class="no-events">날짜를 선택하면 일정이 표시됩니다.</p>';
        }

        /********** 가계부 기능 **********/
        function loadAccountData() {
            // 로컬 스토리지에서 가계부 데이터 로드
            let abData = JSON.parse(localStorage.getItem('accountData') || '[]');
            accountData = abData;
            
            // 가계부 목록 표시
            renderAccountList();
            
            // 가계부 요약 정보 업데이트
            updateAccountSummary();
            
            // 차트 업데이트 (Chart.js 사용)
            updateAccountCharts();
            
            // 가계부 달력 초기화 (FullCalendar 사용)
            // FullCalendar가 로드되면 호출됨
            if (typeof FullCalendar !== 'undefined') {
                initializeAccountCalendar();
            }
        }
        
        function addAccountItem() {
            const date = document.getElementById('ab-date').value;
            const amount = parseFloat(document.getElementById('ab-amount').value);
            const type = document.getElementById('ab-type').value;
            const category = document.getElementById('ab-category').value;
            const method = document.getElementById('ab-method').value;
            const memo = document.getElementById('ab-memo').value;
            
            if (!date || isNaN(amount) || amount <= 0) {
                alert('날짜와 금액은 필수입니다. 금액은 0보다 커야 합니다.');
                return;
            }
            
            const item = {
                id: Date.now(),
                date,
                amount,
                type,
                category,
                method,
                memo
            };
            
            // 새 항목 추가
            accountData.push(item);
            localStorage.setItem('accountData', JSON.stringify(accountData));
            
            // 입력 필드 초기화
            document.getElementById('ab-amount').value = '';
            document.getElementById('ab-memo').value = '';
            
            // 가계부 목록 및 요약 업데이트
            renderAccountList();
            updateAccountSummary();
            updateAccountCharts();
            
            // 달력 이벤트 업데이트 (FullCalendar 사용)
            const calendarEl = document.getElementById('ab-calendar');
            if (calendarEl && typeof FullCalendar !== 'undefined') {
                const calendar = FullCalendar.getCalendarById('account-calendar');
                if (calendar) {
                    // 기존 달력이 있으면 이벤트 추가
                    calendar.addEvent({
                        id: item.id.toString(),
                        title: `${item.type === 'income' ? '수입' : '지출'}: ${item.amount.toLocaleString()}원 (${item.category})`,
                        start: item.date,
                        color: item.type === 'income' ? '#4CAF50' : '#f44336',
                        extendedProps: {
                            amount: item.amount,
                            category: item.category,
                            method: item.method,
                            memo: item.memo
                        }
                    });
                } else {
                    // 달력이 없으면 초기화
                    initializeAccountCalendar();
                }
            }
            
            alert('가계부 항목이 추가되었습니다.');
        }
        
        function renderAccountList() {
            const tbody = document.querySelector('#ab-list tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // 날짜 내림차순으로 정렬 (최신 항목이 위로)
            accountData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (accountData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">등록된 내역이 없습니다.</td></tr>';
                return;
            }
            
            accountData.forEach(item => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${formatDate(item.date)}</td>
                    <td>${item.amount.toLocaleString()}원</td>
                    <td>${item.type === 'income' ? '수입' : '지출'}</td>
                    <td>${item.category}</td>
                    <td>${item.method}</td>
                    <td>${item.memo || '-'}</td>
                    <td>
                        <button class="delete-btn" onclick="deleteAccountItem(${item.id})">삭제</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        function deleteAccountItem(id) {
            if (confirm('이 항목을 삭제하시겠습니까?')) {
                accountData = accountData.filter(item => item.id !== id);
                localStorage.setItem('accountData', JSON.stringify(accountData));
                
                // 가계부 목록 및 요약 업데이트
                renderAccountList();
                updateAccountSummary();
                updateAccountCharts();
                
                alert('항목이 삭제되었습니다.');
            }
        }
        
        function updateAccountSummary() {
            const summaryEl = document.getElementById('ab-summary');
            if (!summaryEl) return;
            
            // 현재 월의 수입/지출 합계 계산
            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();
            
            let income = 0, expense = 0;
            
            accountData.forEach(item => {
                const itemDate = new Date(item.date);
                const itemMonth = itemDate.getMonth() + 1;
                const itemYear = itemDate.getFullYear();
                
                if (itemMonth === currentMonth && itemYear === currentYear) {
                    if (item.type === 'income') {
                        income += item.amount;
                    } else {
                        expense += item.amount;
                    }
                }
            });
            
            // 요약 정보 표시
            summaryEl.innerHTML = `
                <strong>이번 달 수입:</strong> ${income.toLocaleString()}원 | 
                <strong>지출:</strong> ${expense.toLocaleString()}원 |
                <strong>잔액:</strong> ${(income - expense).toLocaleString()}원
            `;
        }
        
        function updateAccountCharts() {
            // Chart.js와 FullCalendar 라이브러리가 로드되었는지 확인
            let requiredLibraries = [];
            
            if (typeof Chart === 'undefined') {
                requiredLibraries.push({
                    name: 'Chart.js',
                    src: 'https://cdn.jsdelivr.net/npm/chart.js'
                });
            }
            
            if (typeof FullCalendar === 'undefined') {
                requiredLibraries.push({
                    name: 'FullCalendar',
                    src: 'https://cdn.jsdelivr.net/npm/fullcalendar@5.10.0/main.min.js'
                });
                
                // FullCalendar CSS도 추가
                const style = document.createElement('link');
                style.rel = 'stylesheet';
                style.href = 'https://cdn.jsdelivr.net/npm/fullcalendar@5.10.0/main.min.css';
                document.head.appendChild(style);
            }
            
            if (requiredLibraries.length > 0) {
                loadLibraries(requiredLibraries, 0, function() {
                    createCharts();
                    initializeAccountCalendar();
                });
                return;
            }
            
            createCharts();
            initializeAccountCalendar();
        }
        
        // 라이브러리 순차적 로드 함수
        function loadLibraries(libraries, index, callback) {
            if (index >= libraries.length) {
                callback();
                return;
            }
            
            const library = libraries[index];
            const script = document.createElement('script');
            script.src = library.src;
            script.onload = function() {
                loadLibraries(libraries, index + 1, callback);
            };
            document.head.appendChild(script);
        }
        
        // 가계부 달력 초기화 함수
        function initializeAccountCalendar() {
            const calendarEl = document.getElementById('ab-calendar');
            if (!calendarEl) return;
            
            // 달력에 표시할 이벤트 데이터 생성
            const events = accountData.map(item => ({
                id: item.id.toString(),
                title: `${item.type === 'income' ? '수입' : '지출'}: ${item.amount.toLocaleString()}원 (${item.category})`,
                start: item.date,
                color: item.type === 'income' ? '#4CAF50' : '#f44336',
                extendedProps: {
                    amount: item.amount,
                    category: item.category,
                    method: item.method,
                    memo: item.memo
                }
            }));
            
            // 기존에 초기화된 달력이 있는지 확인
            if (calendarEl.innerHTML) {
                try {
                    // 기존 달력이 있으면 초기화
                    calendarEl.innerHTML = '';
                } catch (e) {
                    console.error("달력 초기화 오류:", e);
                }
            }
            
            try {
                // FullCalendar 인스턴스 생성
                const calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek'
                    },
                    events: events,
                    locale: 'ko',
                    height: '600px',
                    eventClick: function(info) {
                        // 이벤트 클릭 시 상세 정보 표시
                        const eventData = info.event;
                        const props = eventData.extendedProps;
                        
                        alert(`[${eventData.title}]
날짜: ${eventData.startStr}
금액: ${props.amount.toLocaleString()}원
카테고리: ${props.category}
결제방법: ${props.method}
메모: ${props.memo || '없음'}`);
                    },
                    datesSet: function(dateInfo) {
                        // 월 변경 시 해당 월의 수입/지출 합계 표시
                        const start = dateInfo.start;
                        const end = dateInfo.end;
                        
                        let monthIncome = 0, monthExpense = 0;
                        
                        accountData.forEach(item => {
                            const itemDate = new Date(item.date);
                            if (itemDate >= start && itemDate < end) {
                                if (item.type === 'income') {
                                    monthIncome += item.amount;
                                } else {
                                    monthExpense += item.amount;
                                }
                            }
                        });
                        
                        // 달력 위에 요약 정보 표시
                        const infoEl = document.createElement('div');
                        infoEl.className = 'fc-header-toolbar mt-2 mb-3';
                        infoEl.innerHTML = `
                            <div style="text-align:center; width:100%; font-weight:bold; padding:10px;">
                                ${dateInfo.view.title} - 
                                수입: <span style="color:#4CAF50">${monthIncome.toLocaleString()}원</span> | 
                                지출: <span style="color:#f44336">${monthExpense.toLocaleString()}원</span> | 
                                잔액: <span style="color:${monthIncome - monthExpense >= 0 ? '#4CAF50' : '#f44336'}">${(monthIncome - monthExpense).toLocaleString()}원</span>
                            </div>
                        `;
                        
                        // 기존 요약 정보가 있으면 제거
                        const existingInfo = calendarEl.querySelector('.fc-header-toolbar:not(:first-child)');
                        if (existingInfo) {
                            existingInfo.remove();
                        }
                        
                        // 새 요약 정보 추가
                        const header = calendarEl.querySelector('.fc-header-toolbar');
                        if (header) {
                            header.parentNode.insertBefore(infoEl, header.nextSibling);
                        }
                    }
                });
                
                // 달력 렌더링
                calendar.render();
            } catch (e) {
                console.error("FullCalendar 초기화 오류:", e);
                calendarEl.innerHTML = '<div style="padding: 20px; text-align: center; color: #f44336;">달력을 로드하는 중 오류가 발생했습니다.<br>페이지를 새로고침하거나 다른 탭을 클릭한 후 다시 시도해주세요.</div>';
            }
        }
        
        function createCharts() {
            // 차트 요소 가져오기
            const monthChart = document.getElementById('ab-month-summary');
            const categoryChart = document.getElementById('ab-category-summary');
            const methodChart = document.getElementById('ab-method-summary');
            
            if (!monthChart || !categoryChart || !methodChart) return;
            
            // 기존 차트 제거
            Chart.getChart(monthChart)?.destroy();
            Chart.getChart(categoryChart)?.destroy();
            Chart.getChart(methodChart)?.destroy();
            
            // 데이터 집계
            const monthData = { income: 0, expense: 0 };
            const categoryData = {};
            const methodData = {};
            
            accountData.forEach(item => {
                // 월별 수입/지출 집계
                monthData[item.type] += item.amount;
                
                // 지출 항목만 카테고리별 집계
                if (item.type === 'expense') {
                    if (!categoryData[item.category]) {
                        categoryData[item.category] = 0;
                    }
                    categoryData[item.category] += item.amount;
                    
                    // 결제 수단별 집계
                    if (!methodData[item.method]) {
                        methodData[item.method] = 0;
                    }
                    methodData[item.method] += item.amount;
                }
            });
            
            // 월별 수입/지출 차트
            new Chart(monthChart, {
                type: 'bar',
                data: {
                    labels: ['수입', '지출'],
                    datasets: [{
                        label: '금액',
                        data: [monthData.income, monthData.expense],
                        backgroundColor: ['#4CAF50', '#f44336']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '수입/지출 비교'
                        }
                    }
                }
            });
            
            // 카테고리별 지출 차트
            new Chart(categoryChart, {
                type: 'pie',
                data: {
                    labels: Object.keys(categoryData),
                    datasets: [{
                        data: Object.values(categoryData),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                            '#FF9F40', '#8AC249', '#EA80FC', '#607D8B', '#E53935'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '카테고리별 지출'
                        }
                    }
                }
            });
            
            // 결제 수단별 지출 차트
            new Chart(methodChart, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(methodData),
                    datasets: [{
                        data: Object.values(methodData),
                        backgroundColor: [
                            '#BCAAA4', '#90CAF9', '#FFE082', '#80DEEA', '#B0BEC5',
                            '#A5D6A7', '#F48FB1', '#CE93D8', '#FFF59D', '#FFAB91'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '결제 수단별 지출'
                        }
                    }
                }
            });
        }

        /********** 홈화면 설정 기능 **********/
        function saveCustomHome() {
            const text = document.getElementById('text-input').value;
            const font = document.getElementById('font-select').value;
            const size = document.getElementById('font-size').value;
            const color = document.getElementById('font-color').value;
            const align = document.getElementById('text-align').value;
            
            // 로컬 스토리지에 저장
            localStorage.setItem("home_text", text);
            localStorage.setItem("home_font", font);
            localStorage.setItem("home_size", size);
            localStorage.setItem("home_color", color);
            localStorage.setItem("home_align", align);
            
            // 이미지 파일 처리
            const imageFile = document.getElementById('image-upload').files[0];
            if (imageFile) {
                const reader = new FileReader();
                reader.onload = e => {
                    localStorage.setItem("home_img", e.target.result);
                    localStorage.removeItem("home_video");
                    applyCustomHome();
                };
                reader.readAsDataURL(imageFile);
            }
            
            // 비디오 파일 처리
            const videoFile = document.getElementById('video-upload').files[0];
            if (videoFile) {
                const reader = new FileReader();
                reader.onload = e => {
                    localStorage.setItem("home_video", e.target.result);
                    localStorage.removeItem("home_img");
                    applyCustomHome();
                };
                reader.readAsDataURL(videoFile);
            }
            
            // 오디오 파일 처리
            const audioFile = document.getElementById('audio-upload').files[0];
            if (audioFile) {
                const reader = new FileReader();
                reader.onload = e => {
                    localStorage.setItem("home_audio", e.target.result);
                    applyCustomHome();
                };
                reader.readAsDataURL(audioFile);
            }
            
            // 설정을 즉시 적용
            applyCustomHome();
            
            alert("홈화면이 저장되었습니다!");
        }

        function applyCustomHome() {
            const text = localStorage.getItem("home_text");
            const font = localStorage.getItem("home_font");
            const size = localStorage.getItem("home_size");
            const color = localStorage.getItem("home_color");
            const align = localStorage.getItem("home_align");
            const img = localStorage.getItem("home_img");
            const video = localStorage.getItem("home_video");
            const audioSrc = localStorage.getItem("home_audio");

            const el = document.getElementById("preview-text");
            if (el && text) {
                el.textContent = text;
                el.style.fontFamily = font || 'inherit';
                el.style.fontSize = size || 'inherit';
                el.style.color = color || 'inherit';
                el.style.textAlign = align || 'inherit';
            }

            // media-preview 요소를 찾고 없으면 생성
            let media = document.getElementById("media-preview");
            if (!media) {
                // 헤더 다음에 media-preview 요소 생성
                const header = document.querySelector('header');
                if (header && header.nextElementSibling) {
                    media = document.createElement('div');
                    media.id = 'media-preview';
                    media.style.textAlign = 'center';
                    media.style.margin = '20px 0';
                    header.parentNode.insertBefore(media, header.nextElementSibling);
                }
            }

            // 이미지나 비디오가 없으면 media-preview를 표시하지 않음
            if (media) {
                if (video) {
                    media.innerHTML = '';
                    media.style.display = 'block';
                } else if (img) {
                    media.innerHTML = '<img src="' + img + '" alt="이미지" style="max-width:100%;">';
                    media.style.display = 'block';
                } else {
                    // 이미지나 비디오가 없으면 미디어 영역 숨김
                    media.innerHTML = '';
                    media.style.display = 'none';
                }
            }

            const bgm = document.getElementById("bgm");
            if (bgm && audioSrc) {
                bgm.src = audioSrc;
                bgm.play().catch(e => console.log("오디오 자동 재생 실패:", e));
            }
        }
        
        /********** 유틸리티 함수 **********/
        function formatDate(dateString) {
            const date = new Date(dateString);
            return `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`;
        }
        
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일 ${date.getHours()}시 ${String(date.getMinutes()).padStart(2, '0')}분`;
        }

// 텍스트 에디터 CSS 스타일
const textEditorCSS = `
/* 텍스트 에디터 스타일 */
.text-editor-container {
    border: 1px solid #ddd;
    border-radius: 5px;
    overflow: hidden;
    margin-bottom: 15px;
}

.text-editor-toolbar {
    background-color: #f5f5f5;
    padding: 8px;
    border-bottom: 1px solid #ddd;
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
}

.text-editor-toolbar button {
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 3px;
    padding: 5px 8px;
    margin: 0;
    cursor: pointer;
    color: #333;
    font-size: 14px;
}

.text-editor-toolbar button:hover {
    background-color: #f0f0f0;
}

.text-editor-toolbar button.active {
    background-color: #e8e8e8;
    color: #000;
}

.text-editor-toolbar select {
    height: 30px;
    border: 1px solid #ddd;
    border-radius: 3px;
    background-color: #fff;
    padding: 0 5px;
    min-width: 100px;
}

.text-editor-toolbar .color-picker {
    height: 30px;
    width: 30px;
    padding: 0;
    border: 1px solid #ddd;
    border-radius: 3px;
    cursor: pointer;
}

.text-editor-content {
    min-height: 150px;
    padding: 10px;
    background-color: #fff;
    overflow-y: auto;
    line-height: 1.6;
}

.text-editor-content:focus {
    outline: none;
    box-shadow: 0 0 3px rgba(0, 0, 0, 0.2) inset;
}

/* 툴바 그룹 스타일 */
.toolbar-group {
    display: flex;
    align-items: center;
    gap: 5px;
    padding-right: 8px;
    margin-right: 8px;
    border-right: 1px solid #ddd;
}

.toolbar-group:last-child {
    border-right: none;
}

/* 폰트 미리보기 스타일 */
.font-preview {
    font-size: 14px;
}

/* 각 폰트 패밀리에 대한 스타일 */
.arial { font-family: Arial, sans-serif; }
.nanum-gothic { font-family: "Nanum Gothic", "맑은 고딕", sans-serif; }
.malgun-gothic { font-family: "Malgun Gothic", "맑은 고딕", sans-serif; }
.gulim { font-family: "Gulim", sans-serif; }
.batang { font-family: "Batang", serif; }
.times { font-family: "Times New Roman", serif; }
.georgia { font-family: "Georgia", serif; }
.courier { font-family: "Courier New", monospace; }

/* 웹 폰트 로드 */

`;

// 일기장과 메모장에 텍스트 에디터를 추가하는 함수
function addTextEditorFunctionality() {
    // 텍스트 에디터 CSS 스타일 추가
    const styleElement = document.createElement('style');
    styleElement.textContent = textEditorCSS;
    document.head.appendChild(styleElement);
    
    // 일기장 텍스트 에디터 추가
    setupTextEditor('diaryContent', 'diary-editor', 6);
    
    // 메모장 텍스트 에디터 추가
    setupTextEditor('memoContent', 'memo-editor', 4);
    
    // 텍스트 에디터 저장 시 HTML 내용을 hidden input에 저장하도록 훅 추가
    const originalSaveDiary = window.saveDiary;
    window.saveDiary = function() {
        const diaryEditor = document.getElementById('diary-editor');
        if (diaryEditor) {
            const diaryContent = document.getElementById('diaryContent');
            diaryContent.value = diaryEditor.innerHTML;
        }
        originalSaveDiary();
    };
    
    const originalSaveMemo = window.saveMemo;
    window.saveMemo = function() {
        const memoEditor = document.getElementById('memo-editor');
        if (memoEditor) {
            const memoContent = document.getElementById('memoContent');
            memoContent.value = memoEditor.innerHTML;
        }
        originalSaveMemo();
    };
    
    // 일기와 메모 로드 시 HTML 내용을 에디터에 표시하도록 훅 추가
    const originalEditDiary = window.editDiary;
    window.editDiary = function(id) {
        originalEditDiary(id);
        const diary = diaries.find(d => d.id === id);
        if (diary && document.getElementById('diary-editor')) {
            document.getElementById('diary-editor').innerHTML = diary.content;
        }
    };
    
    const originalEditMemo = window.editMemo;
    window.editMemo = function(id) {
        originalEditMemo(id);
        const memo = memos.find(m => m.id === id);
        if (memo && document.getElementById('memo-editor')) {
            document.getElementById('memo-editor').innerHTML = memo.content;
        }
    };
}

// 텍스트 에디터 설정 함수
function setupTextEditor(textareaId, editorId, rows) {
    const textarea = document.getElementById(textareaId);
    if (!textarea) return;
    
    // textarea를 숨기고 에디터 컨테이너 생성
    textarea.style.display = 'none';
    
    const editorContainer = document.createElement('div');
    editorContainer.className = 'text-editor-container';
    textarea.parentNode.insertBefore(editorContainer, textarea);
    
    // 툴바 생성
    const toolbar = document.createElement('div');
    toolbar.className = 'text-editor-toolbar';
    
    // 폰트 스타일 그룹
    const styleGroup = document.createElement('div');
    styleGroup.className = 'toolbar-group';
    
    // 볼드 버튼
    const boldBtn = document.createElement('button');
    boldBtn.innerHTML = '<b>B</b>';
    boldBtn.title = '굵게';
    boldBtn.onclick = function(e) { 
        e.preventDefault(); 
        document.getElementById(editorId).focus();
        document.execCommand('bold', false, null); 
    };
    
    // 이탤릭 버튼
    const italicBtn = document.createElement('button');
    italicBtn.innerHTML = '<i>I</i>';
    italicBtn.title = '기울임';
    italicBtn.onclick = function(e) { 
        e.preventDefault(); 
        document.getElementById(editorId).focus();
        document.execCommand('italic', false, null); 
    };
    
    // 밑줄 버튼
    const underlineBtn = document.createElement('button');
    underlineBtn.innerHTML = '<u>U</u>';
    underlineBtn.title = '밑줄';
    underlineBtn.onclick = function(e) { 
        e.preventDefault(); 
        document.getElementById(editorId).focus();
        document.execCommand('underline', false, null); 
    };
    
    // 취소선 버튼
    const strikeBtn = document.createElement('button');
    strikeBtn.innerHTML = '<s>S</s>';
    strikeBtn.title = '취소선';
    strikeBtn.onclick = function(e) { 
        e.preventDefault(); 
        document.getElementById(editorId).focus();
        document.execCommand('strikethrough', false, null); 
    };
    
    styleGroup.appendChild(boldBtn);
    styleGroup.appendChild(italicBtn);
    styleGroup.appendChild(underlineBtn);
    styleGroup.appendChild(strikeBtn);
    
    // 정렬 그룹
    const alignGroup = document.createElement('div');
    alignGroup.className = 'toolbar-group';
    
    // 왼쪽 정렬 버튼
    const alignLeftBtn = document.createElement('button');
    alignLeftBtn.innerHTML = '◀ 왼쪽';
    alignLeftBtn.title = '왼쪽 정렬';
    alignLeftBtn.onclick = function(e) { 
        e.preventDefault(); 
        document.getElementById(editorId).focus();
        document.execCommand('justifyLeft', false, null); 
    };
    
    // 가운데 정렬 버튼
    const alignCenterBtn = document.createElement('button');
    alignCenterBtn.innerHTML = '■ 가운데';
    alignCenterBtn.title = '가운데 정렬';
    alignCenterBtn.onclick = function(e) { 
        e.preventDefault(); 
        document.getElementById(editorId).focus();
        document.execCommand('justifyCenter', false, null); 
    };
    
    // 오른쪽 정렬 버튼
    const alignRightBtn = document.createElement('button');
    alignRightBtn.innerHTML = '▶ 오른쪽';
    alignRightBtn.title = '오른쪽 정렬';
    alignRightBtn.onclick = function(e) { 
        e.preventDefault(); 
        document.getElementById(editorId).focus();
        document.execCommand('justifyRight', false, null); 
    };
    
    alignGroup.appendChild(alignLeftBtn);
    alignGroup.appendChild(alignCenterBtn);
    alignGroup.appendChild(alignRightBtn);
    
    // 폰트 그룹
    const fontGroup = document.createElement('div');
    fontGroup.className = 'toolbar-group';
    
    // 폰트 종류 선택기 (개선된 버전)
    const fontSelector = document.createElement('select');
    fontSelector.title = '글꼴';
    fontSelector.id = editorId + '-font-selector';
    fontSelector.style.minWidth = '120px'; // 충분한 너비 확보
    
    // 폰트 선택 이벤트 핸들러 수정
    fontSelector.onchange = function() {
        applyFontToEditor(editorId, this.value);
    };
    
    // 폰트 옵션 - CSS 클래스와 함께 정의
    const fontOptions = [
        { value: 'Arial, sans-serif', text: 'Arial', className: 'arial' },
        { value: '"Nanum Gothic", "맑은 고딕", sans-serif', text: '나눔 고딕', className: 'nanum-gothic' },
        { value: '"Malgun Gothic", "맑은 고딕", sans-serif', text: '맑은 고딕', className: 'malgun-gothic' },
        { value: '"Gulim", sans-serif', text: '굴림', className: 'gulim' },
        { value: '"Batang", serif', text: '바탕', className: 'batang' },
        { value: '"Times New Roman", serif', text: 'Times New Roman', className: 'times' },
        { value: '"Georgia", serif', text: 'Georgia', className: 'georgia' },
        { value: '"Courier New", monospace', text: 'Courier New', className: 'courier' }
    ];
    
    // 옵션 추가 - 폰트 미리보기와 함께
    fontOptions.forEach(option => {
        const opt = document.createElement('option');
        opt.value = option.value;
        opt.textContent = option.text;
        opt.className = 'font-preview ' + option.className;
        // 기본값 설정 (Arial로 설정)
        if (option.text === 'Arial') opt.selected = true;
        fontSelector.appendChild(opt);
    });
    
    // 폰트 크기 선택기
    const sizeSelector = document.createElement('select');
    sizeSelector.title = '글자 크기';
    sizeSelector.id = editorId + '-size-selector';
    
    // 크기 선택 이벤트 핸들러 수정
    sizeSelector.onchange = function() {
        document.getElementById(editorId).focus();
        document.execCommand('fontSize', false, this.value);
        
        // 추가적인 스타일 적용 (일부 브라우저에서 더 잘 작동)
        const sizeStyles = {
            '1': '10px',
            '2': '13px',
            '3': '16px',
            '4': '18px',
            '5': '24px',
            '6': '32px',
            '7': '48px'
        };
        
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
            const fontElements = document.querySelectorAll(`font[size="${this.value}"]`);
            fontElements.forEach(el => {
                el.style.fontSize = sizeStyles[this.value];
            });
        }
    };
    
    const sizeOptions = [
        { value: '1', text: '아주 작게' },
        { value: '2', text: '작게' },
        { value: '3', text: '보통' },
        { value: '4', text: '크게' },
        { value: '5', text: '더 크게' },
        { value: '6', text: '아주 크게' },
        { value: '7', text: '최대 크게' }
    ];
    
    sizeOptions.forEach(option => {
        const opt = document.createElement('option');
        opt.value = option.value;
        opt.textContent = option.text;
        if (option.value === '3') opt.selected = true;
        sizeSelector.appendChild(opt);
    });
    
    fontGroup.appendChild(fontSelector);
    fontGroup.appendChild(sizeSelector);
    
    // 색상 그룹
    const colorGroup = document.createElement('div');
    colorGroup.className = 'toolbar-group';
    
    // 글자 색상 선택기
    const colorPicker = document.createElement('input');
    colorPicker.type = 'color';
    colorPicker.className = 'color-picker';
    colorPicker.title = '글자 색상';
    colorPicker.value = '#000000';
    colorPicker.onchange = function() { 
        document.getElementById(editorId).focus();
        document.execCommand('foreColor', false, this.value); 
    };
    
    // 배경 색상 선택기
    const bgColorPicker = document.createElement('input');
    bgColorPicker.type = 'color';
    bgColorPicker.className = 'color-picker';
    bgColorPicker.title = '배경 색상';
    bgColorPicker.value = '#ffffff';
    bgColorPicker.onchange = function() { 
        document.getElementById(editorId).focus();
        document.execCommand('hiliteColor', false, this.value); 
    };
    
    colorGroup.appendChild(colorPicker);
    colorGroup.appendChild(bgColorPicker);
    
    // 모든 그룹을 툴바에 추가
    toolbar.appendChild(styleGroup);
    toolbar.appendChild(alignGroup);
    toolbar.appendChild(fontGroup);
    toolbar.appendChild(colorGroup);
    
    // 편집 영역 생성
    const editorContent = document.createElement('div');
    editorContent.className = 'text-editor-content';
    editorContent.id = editorId;
    editorContent.contentEditable = 'true';
    editorContent.style.minHeight = (rows * 24) + 'px'; // 기존 textarea의 줄 수와 비슷한 높이
    editorContent.innerHTML = textarea.value;
    
    // 기본 글꼴 설정 (Arial)
    editorContent.style.fontFamily = 'Arial, sans-serif';
    
    // 에디터 컨테이너에 툴바와 편집 영역 추가
    editorContainer.appendChild(toolbar);
    editorContainer.appendChild(editorContent);
    
    // 편집 내용 변경 시 textarea 값 업데이트
    editorContent.oninput = function() {
        textarea.value = this.innerHTML;
    };
}

// 글꼴 적용 helper 함수
function applyFontToEditor(editorId, fontValue) {
    // 에디터에 포커스 주기
    const editor = document.getElementById(editorId);
    editor.focus();
    
    // 선택된 텍스트가 있는지 확인
    const selection = window.getSelection();
    const hasSelection = selection.toString().length > 0;
    
    try {
        if (hasSelection) {
            // 선택된 텍스트가 있으면 fontName 명령 실행
            document.execCommand('fontName', false, fontValue);
        } else {
            // 1. 현재 커서 위치의 텍스트 노드 찾기
            const range = selection.getRangeAt(0);
            const startNode = range.startContainer;
            
            // 2. 부모 요소에 직접 스타일 적용 (텍스트 노드의 경우)
            if (startNode.nodeType === Node.TEXT_NODE) {
                // 현재 부모 요소 찾기
                let parentElement = startNode.parentNode;
                
                // span으로 감싸고 스타일 적용
                const span = document.createElement('span');
                span.style.fontFamily = fontValue;
                
                // 현재 텍스트 노드를 새 span으로 감싸기
                const newRange = document.createRange();
                newRange.selectNode(startNode);
                newRange.surroundContents(span);
            } else {
                // 에디터 전체에 적용
                editor.style.fontFamily = fontValue;
                
                // 또는 새로운 텍스트를 입력할 위치를 마크하고 스팬으로 감싸기
                const span = document.createElement('span');
                span.style.fontFamily = fontValue;
                span.innerHTML = '​'; // 영 너비 공백 문자
                
                range.insertNode(span);
                range.setStart(span, 0);
                range.setEnd(span, 1);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        }
        
        // font 태그에 직접 스타일 추가하여 강화
        setTimeout(() => {
            const fontElements = editor.querySelectorAll(`font[face="${fontValue}"]`);
            fontElements.forEach(el => {
                el.style.fontFamily = fontValue;
            });
        }, 10);
    } catch (e) {
        console.error('폰트 적용 중 오류 발생:', e);
        // 예비 방법: 선택 영역이 없거나 문제가 있으면 전체 적용
        editor.style.fontFamily = fontValue;
    }
}

// 페이지 로드 시 텍스트 에디터 기능 추가
document.addEventListener('DOMContentLoaded', function() {
    addTextEditorFunctionality();
});
    </script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    // 달력 선택 스타일 추가
    const styleEl = document.createElement('style');
    styleEl.textContent = `
        /* 달력에서 선택된 날짜 스타일 */
        .calendar-table td.selected {
            background-color: #e8f4f1;
            border: 2px solid #5f7561;
            box-shadow: 0 0 8px rgba(95, 117, 97, 0.3);
        }
        
        /* 호버 효과 */
        .calendar-table td:hover {
            background-color: #f9f9f9;
            cursor: pointer;
            transform: scale(1.05);
            transition: all 0.2s ease;
            z-index: 5;
        }
    `;
    document.head.appendChild(styleEl);
    
    loadInitialData();
});
</script>

<script>
  function checkPassword() {
    const input = document.getElementById('password-input').value;
    const correct = '1234';  // 원하는 비밀번호로 변경 가능
    if (input === correct) {
      document.getElementById('password-screen').style.display = 'none';
      document.getElementById('main-content').style.display = 'block';
      console.log("비밀번호 인증 성공");
    } else {
      document.getElementById('error-msg').innerText = "비밀번호가 틀렸습니다.";
    }
  }
</script>

</body></html>
</div>
<script>
  function checkPassword(event) {
  event.preventDefault();
    const input = document.getElementById('password').value;
    const errorMsg = document.getElementById('error-msg');
    if (input === 'sik282') {
      document.getElementById('password-screen').style.display = 'none';
      document.getElementById('main-content').style.display = 'block';
    } else {
      errorMsg.textContent = '비밀번호가 틀렸습니다';
    }
  }
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    loadInitialData();
});
</script>
<script>
/********** 할일 기능 **********/
function addTodo() {
    const todoInput = document.getElementById('todoInput');
    const todoDateInput = document.getElementById('todoDate');
    const text = todoInput.value.trim();
    
    if (!text) {
        alert('할 일을 입력해주세요.');
        return;
    }
    
    // 사용자가 선택한 날짜 또는 오늘 날짜 사용
    const todoDate = todoDateInput.value || new Date().toISOString().split('T')[0];
    
    const todo = {
        id: Date.now(),
        text: text,
        completed: false,
        date: todoDate, // 선택한 날짜 저장
        createdAt: new Date().toISOString()
    };
    
    todos.push(todo);
    
    try {
        localStorage.setItem('todos', JSON.stringify(todos));
        
        todoInput.value = '';
        // 날짜 필드는 초기화하지 않고 유지
        
        renderTodos();
        renderTodoCalendar();
    } catch (e) {
        console.error('할일 저장 중 오류 발생:', e);
        alert('할일 저장 중 오류가 발생했습니다.');
    }
}

function renderTodos() {
    const todoList = document.getElementById('todoList');
    if (!todoList) return;
    
    todoList.innerHTML = '';
    
    if (todos.length === 0) {
        todoList.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">할 일이 없습니다. 새로운 할 일을 추가해보세요!</p>';
        return;
    }
    
    todos.sort((a, b) => {
        // 날짜순 정렬 (가까운 날짜 먼저)
        if (a.date !== b.date) {
            return new Date(a.date) - new Date(b.date);
        }
        // 완료되지 않은 항목 먼저
        if (a.completed !== b.completed) {
            return a.completed ? 1 : -1;
        }
        // 최신 생성순
        return new Date(b.createdAt) - new Date(a.createdAt);
    });
    
    todos.forEach(todo => {
        const todoItem = document.createElement('div');
        todoItem.className = 'todo-item';
        todoItem.innerHTML = `
            <div class="todo-text ${todo.completed ? 'completed' : ''}">
                <input type="checkbox" ${todo.completed ? 'checked' : ''} onchange="toggleTodo(${todo.id})">
                <span>${todo.text} <small style="color: #888;">(${formatDate(todo.date)})</small></span>
            </div>
            <div>
                <button onclick="editTodo(${todo.id})">수정</button>
                <button class="delete-btn" onclick="deleteTodo(${todo.id})">삭제</button>
            </div>
        `;
        
        todoList.appendChild(todoItem);
    });
}

function renderTodoCalendar() {
    const todoCalendarBody = document.getElementById('todoCalendarBody');
    const todoCalendarHeader = document.getElementById('todoCalendarHeader');
    
    if (!todoCalendarBody || !todoCalendarHeader) return;
    
    todoCalendarHeader.textContent = `${currentTodoYear}년 ${currentTodoMonth + 1}월`;
    
    const firstDay = new Date(currentTodoYear, currentTodoMonth, 1).getDay();
    const daysInMonth = new Date(currentTodoYear, currentTodoMonth + 1, 0).getDate();
    
    todoCalendarBody.innerHTML = '';
    
    let row = document.createElement('tr');
    
    // 첫 주의 빈 셀 채우기
    for (let i = 0; i < firstDay; i++) {
        const td = document.createElement('td');
        row.appendChild(td);
    }
    
    // 날짜 채우기
    for (let day = 1; day <= daysInMonth; day++) {
        const td = document.createElement('td');
        
        // 해당 날짜 문자열
        const dateStr = `${currentTodoYear}-${String(currentTodoMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        // 클릭 이벤트 추가 - 해당 날짜를 할일 입력란에 설정
        td.addEventListener('click', function() {
            document.getElementById('todoDate').value = dateStr;
            document.getElementById('todoInput').focus();
            
            // 모든 선택된 셀 초기화
            document.querySelectorAll('#todoCalendarBody td.selected').forEach(cell => {
                cell.classList.remove('selected');
            });
            
            // 현재 셀 선택 표시
            this.classList.add('selected');
        });
        
        // 오늘 날짜 강조
        const today = new Date().toISOString().split('T')[0];
        if (dateStr === today) {
            td.classList.add('today');
        }
        
        // 날짜 숫자 표시
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = day;
        td.appendChild(dayNumber);
        
        // 해당 날짜의 할일 체크
        const todosForDate = todos.filter(todo => todo.date === dateStr);
        
        // 할일이 있으면 체크박스로 표시
        if (todosForDate.length > 0) {
            const todoContainer = document.createElement('div');
            
            todosForDate.forEach(todo => {
                const todoDiv = document.createElement('div');
                todoDiv.className = 'todo-entry';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = todo.completed;

                checkbox.onclick = function(e) {
                    e.stopPropagation();
                    toggleTodoInCalendar(todo.id);
                };

                const textSpan = document.createElement('span');
                textSpan.textContent = todo.text;
                textSpan.style.overflow = 'hidden';
                textSpan.style.textOverflow = 'ellipsis';
                textSpan.style.whiteSpace = 'nowrap';

                if (todo.completed) {
                    textSpan.style.textDecoration = 'line-through';
                    textSpan.style.color = '#888';
                }

                todoDiv.appendChild(checkbox);
                todoDiv.appendChild(textSpan);
                todoContainer.appendChild(todoDiv);
            });
            
            td.appendChild(todoContainer);
        }
        
        row.appendChild(td);
        
        // 토요일이나 월의 마지막 날이면 새 행 시작
        if ((firstDay + day) % 7 === 0 || day === daysInMonth) {
            todoCalendarBody.appendChild(row);
            if (day !== daysInMonth) {
                row = document.createElement('tr');
            }
        }
    }
}

function editTodo(id) {
    const todo = todos.find(t => t.id === id);
    if (!todo) return;
    
    const editForm = document.getElementById('editTodoForm');
    const editInput = document.getElementById('editTodoInput');
    const editDateInput = document.getElementById('editTodoDate'); // 날짜 입력란 추가
    const editId = document.getElementById('editTodoId');
    
    editForm.style.display = 'block';
    editInput.value = todo.text;
    editDateInput.value = todo.date; // 날짜 설정
    editId.value = todo.id;
    
    editForm.scrollIntoView({ behavior: 'smooth' });
}

function updateTodo() {
    const editInput = document.getElementById('editTodoInput');
    const editDateInput = document.getElementById('editTodoDate'); // 날짜 입력란 추가
    const editId = document.getElementById('editTodoId');
    
    const text = editInput.value.trim();
    const date = editDateInput.value; // 날짜 가져오기
    const id = parseInt(editId.value);
    
    if (!text) {
        alert('할 일을 입력해주세요.');
        return;
    }
    
    const todoIndex = todos.findIndex(t => t.id === id);
    if (todoIndex !== -1) {
        todos[todoIndex].text = text;
        todos[todoIndex].date = date; // 날짜 업데이트
        
        try {
            localStorage.setItem('todos', JSON.stringify(todos));
            
            document.getElementById('editTodoForm').style.display = 'none';
            
            renderTodos();
            renderTodoCalendar();
            
            alert('할 일이 수정되었습니다.');
        } catch (e) {
            console.error('할일 수정 중 오류 발생:', e);
            alert('할일 수정 중 오류가 발생했습니다.');
        }
    }
}

/********** 체중 기록 기능 **********/
function renderWeightCalendar() {
    let weightData = {};
    try {
        weightData = JSON.parse(localStorage.getItem('weightRecords') || '{}');
    } catch (e) {
        console.error('체중 데이터 로드 중 오류 발생:', e);
        weightData = {};
    }
    
    const body = document.getElementById('calendarBody');
    const title = document.getElementById('calendarTitle');
    
    if (!body || !title) return;
    
    title.textContent = `${currentCalendarYear}년 ${currentCalendarMonth + 1}월`;
    
    body.innerHTML = '';

    const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1).getDay();
    const daysInMonth = new Date(currentCalendarYear, currentCalendarMonth + 1, 0).getDate();

    let row = document.createElement('tr');
    
    // 첫 주의 빈 셀 채우기
    for (let i = 0; i < firstDay; i++) {
        const td = document.createElement('td');
        row.appendChild(td);
    }

    // 날짜 채우기
    for (let day = 1; day <= daysInMonth; day++) {
        const td = document.createElement('td');
        const dateKey = `${currentCalendarYear}-${String(currentCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        // 날짜 표시
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = day;
        td.appendChild(dayNumber);
        
        // 클릭 이벤트 추가 - 해당 날짜를 체중 입력란에 설정
        td.addEventListener('click', function() {
            document.getElementById('weightDate').value = dateKey;
            document.getElementById('weightValue').focus();
            
            // 모든 선택된 셀 초기화
            document.querySelectorAll('#calendarBody td.selected').forEach(cell => {
                cell.classList.remove('selected');
            });
            
            // 현재 셀 선택 표시
            this.classList.add('selected');
        });
        
        // 체중 기록이 있으면 표시
        if (weightData[dateKey]) {
            const weightDiv = document.createElement('div');
            weightDiv.className = 'weight-entry';
            weightDiv.textContent = weightData[dateKey] + "kg";
            td.appendChild(weightDiv);
        }
        
        row.appendChild(td);
        
        // 토요일이나 월의 마지막 날이면 새 행 시작
        if ((firstDay + day) % 7 === 0 || day === daysInMonth) {
            body.appendChild(row);
            if (day !== daysInMonth) {
                row = document.createElement('tr');
            }
        }
    }
}

/********** 스케줄 관리 기능 **********/
function renderScheduleCalendar() {
    const calendarDays = document.getElementById('calendarDays');
    const currentMonthYear = document.getElementById('currentMonthYear');
    
    if (!calendarDays || !currentMonthYear) return;
    
    // 월/년 헤더 설정
    currentMonthYear.textContent = `${currentScheduleYear}년 ${currentScheduleMonth + 1}월`;
    
    // 현재 월의 첫날
    const firstDay = new Date(currentScheduleYear, currentScheduleMonth, 1);
    
    // 현재 월의 마지막 날
    const lastDay = new Date(currentScheduleYear, currentScheduleMonth + 1, 0);
    
    // 첫날의 요일 (0: 일요일, 6: 토요일)
    const firstDayWeekday = firstDay.getDay();
    
    // 달력 셀 초기화
    calendarDays.innerHTML = '';
    
    // 이전 달 날짜 채우기
    for (let i = 0; i < firstDayWeekday; i++) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day other-month';
        dayDiv.innerHTML = `<div class="day-number"></div>`;
        calendarDays.appendChild(dayDiv);
    }
    
    // 오늘 날짜 정보
    const today = new Date();
    const todayDate = today.getDate();
    const todayMonth = today.getMonth();
    const todayYear = today.getFullYear();
    
    // 현재 달 날짜 채우기
    for (let i = 1; i <= lastDay.getDate(); i++) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day';
        
        // 오늘 날짜 표시
        if (i === todayDate && currentScheduleMonth === todayMonth && currentScheduleYear === todayYear) {
            dayDiv.classList.add('today');
        }
        
        // 선택된 날짜 표시
        if (i === selectedDate && currentScheduleMonth === currentScheduleMonth && currentScheduleYear === currentScheduleYear) {
            dayDiv.classList.add('selected');
        }
        
        // 날짜에 해당하는 이벤트 확인
        const dateString = `${currentScheduleYear}-${String(currentScheduleMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
        const dateEvents = schedules.filter(schedule => schedule.date === dateString);
        
        // 이벤트가 있으면 표시
        if (dateEvents.length > 0) {
            dayDiv.classList.add('has-events');
            
            // 이벤트 항목 추가 (모든 이벤트 표시)
            const eventListDiv = document.createElement('div');
            eventListDiv.className = 'event-list';
            
            // 모든 이벤트 표시 (제한 없음)
            for (let j = 0; j < dateEvents.length; j++) {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'event-item';
                eventDiv.textContent = dateEvents[j].title;
                eventListDiv.appendChild(eventDiv);
            }
            
            dayDiv.appendChild(eventListDiv);
        }
        
        // 날짜 번호 추가
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = i;
        dayDiv.appendChild(dayNumber);
        
        // 클릭 이벤트 추가
        dayDiv.addEventListener('click', function() {
            // 이전에 선택된 날짜 클래스 제거
            const selectedDays = document.querySelectorAll('.calendar-day.selected');
            selectedDays.forEach(day => day.classList.remove('selected'));
            
            // 현재 선택된 날짜 표시
            this.classList.add('selected');
            selectedDate = i;
            
            // 선택된 날짜의 이벤트 표시
            const selectedDateObj = new Date(currentScheduleYear, currentScheduleMonth, i);
            showEventsForDate(selectedDateObj);
            
            // 날짜 입력란에 선택한 날짜 설정
            const dateString = `${currentScheduleYear}-${String(currentScheduleMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            document.getElementById('eventDate').value = dateString;
        });
        
        calendarDays.appendChild(dayDiv);
    }
    
    // 다음 달 날짜 채우기 (6주 채우기)
    const usedCells = firstDayWeekday + lastDay.getDate();
    const remainingCells = 42 - usedCells; // 7일 * 6주 = 42
    
    for (let i = 1; i <= remainingCells; i++) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day other-month';
        dayDiv.innerHTML = `<div class="day-number"></div>`;
        calendarDays.appendChild(dayDiv);
    }
}

// 초기 데이터 로드 함수 업데이트
function loadInitialData() {
    document.getElementById("ab-submit")?.addEventListener("click", addAccountItem);
    document.getElementById("addScheduleBtn")?.addEventListener("click", addSchedule);
    
    // 로컬 스토리지에서 데이터 로드
    loadDataFromLocalStorage();
    
    loadDiaries();
    loadMemos();
    renderTodos();
    renderTodoCalendar();
    renderWeightCalendar();
    renderWeightList();
    loadSchedules();
    renderScheduleCalendar();
    loadAccountData(); // 가계부 데이터 로드
    applyCustomHome();
    
    // 기본 날짜 설정 - 모든 날짜 입력 필드에 오늘 날짜 설정
    const today = new Date().toISOString().split('T')[0];
    if (document.getElementById('diaryDate')) document.getElementById('diaryDate').value = today;
    if (document.getElementById('weightDate')) document.getElementById('weightDate').value = today;
    if (document.getElementById('eventDate')) document.getElementById('eventDate').value = today;
    if (document.getElementById('ab-date')) document.getElementById('ab-date').value = today;
    if (document.getElementById('todoDate')) document.getElementById('todoDate').value = today;
    
    // 이벤트 리스너 설정
    document.getElementById('addScheduleBtn')?.addEventListener('click', addSchedule);
    document.getElementById('viewListBtn')?.addEventListener('click', showListView);
    document.getElementById('viewCalendarBtn')?.addEventListener('click', showCalendarView);
    document.getElementById('prevMonthBtn')?.addEventListener('click', prevScheduleMonth);
    document.getElementById('nextMonthBtn')?.addEventListener('click', nextScheduleMonth);
    
    // 가계부 이벤트 리스너 설정
    if (document.getElementById('ab-submit')) {
        document.getElementById('ab-submit').addEventListener('click', addAccountItem);
    }
    
    // 필요한 외부 라이브러리 로드
    loadRequiredLibraries();
}
// 가계부 달력 초기화 함수 (FullCalendar) 업데이트
function initializeAccountCalendar() {
    const calendarEl = document.getElementById('ab-calendar');
    if (!calendarEl) return;
    
    // 달력에 표시할 이벤트 데이터 생성
    const events = accountData.map(item => ({
        id: item.id.toString(),
        title: `${item.type === 'income' ? '수입' : '지출'}: ${item.amount.toLocaleString()}원 (${item.category})`,
        start: item.date,
        color: item.type === 'income' ? '#4CAF50' : '#f44336',
        extendedProps: {
            amount: item.amount,
            category: item.category,
            method: item.method,
            memo: item.memo
        }
    }));
    
    // 기존에 초기화된 달력이 있는지 확인
    if (calendarEl.innerHTML) {
        try {
            // 기존 달력이 있으면 초기화
            calendarEl.innerHTML = '';
        } catch (e) {
            console.error("달력 초기화 오류:", e);
        }
    }
    
    try {
        // FullCalendar 인스턴스 생성
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek'
            },
            events: events,
            locale: 'ko',
            height: '600px',
            dateClick: function(info) {
                // 날짜 클릭 시 입력란에 해당 날짜 설정
                document.getElementById('ab-date').value = info.dateStr;
                document.getElementById('ab-amount').focus();
            },
            eventClick: function(info) {
                // 이벤트 클릭 시 상세 정보 표시
                const eventData = info.event;
                const props = eventData.extendedProps;
                
                alert(`[${eventData.title}]
날짜: ${eventData.startStr}
금액: ${props.amount.toLocaleString()}원
카테고리: ${props.category}
결제방법: ${props.method}
메모: ${props.memo || '없음'}`);
            },
            datesSet: function(dateInfo) {
                // 월 변경 시 해당 월의 수입/지출 합계 표시
                const start = dateInfo.start;
                const end = dateInfo.end;
                
                let monthIncome = 0, monthExpense = 0;
                
                accountData.forEach(item => {
                    const itemDate = new Date(item.date);
                    if (itemDate >= start && itemDate < end) {
                        if (item.type === 'income') {
                            monthIncome += item.amount;
                        } else {
                            monthExpense += item.amount;
                        }
                    }
                });
                
                // 달력 위에 요약 정보 표시
                const infoEl = document.createElement('div');
                infoEl.className = 'fc-header-toolbar mt-2 mb-3';
                infoEl.innerHTML = `
                    <div style="text-align:center; width:100%; font-weight:bold; padding:10px;">
                        ${dateInfo.view.title} - 
                        수입: <span style="color:#4CAF50">${monthIncome.toLocaleString()}원</span> | 
                        지출: <span style="color:#f44336">${monthExpense.toLocaleString()}원</span> | 
                        잔액: <span style="color:${monthIncome - monthExpense >= 0 ? '#4CAF50' : '#f44336'}">${(monthIncome - monthExpense).toLocaleString()}원</span>
                    </div>
                `;
                
                // 기존 요약 정보가 있으면 제거
                const existingInfo = calendarEl.querySelector('.fc-header-toolbar:not(:first-child)');
                if (existingInfo) {
                    existingInfo.remove();
                }
                
                // 새 요약 정보 추가
                const header = calendarEl.querySelector('.fc-header-toolbar');
                if (header) {
                    header.parentNode.insertBefore(infoEl, header.nextSibling);
                }
            }
        });
        
        // 달력 렌더링
        calendar.render();
    } catch (e) {
        console.error("FullCalendar 초기화 오류:", e);
        calendarEl.innerHTML = '<div style="padding: 20px; text-align: center; color: #f44336;">달력을 로드하는 중 오류가 발생했습니다.<br>페이지를 새로고침하거나 다른 탭을 클릭한 후 다시 시도해주세요.</div>';
    }
}

// CSS 스타일 추가 (달력 날짜 선택 관련)
function addCalendarSelectionStyles() {
    const styleEl = document.createElement('style');
    styleEl.textContent = `
        /* 달력에서 선택된 날짜 스타일 */
        .calendar-table td.selected {
            background-color: #e8f4f1;
            border: 2px solid #5f7561;
            box-shadow: 0 0 8px rgba(95, 117, 97, 0.3);
        }
        
        .calendar-day.selected {
            background-color: #e8f4f1;
            border: 2px solid #5f7561 !important;
            box-shadow: 0 0 8px rgba(95, 117, 97, 0.3);
        }
        
        /* 오늘 날짜 스타일 */
        .calendar-table td.today {
            background-color: #f5f0e5;
            border: 2px solid #e3b587;
        }
    `;
    document.head.appendChild(styleEl);
}

// 페이지 로드 시 스타일 추가
document.addEventListener('DOMContentLoaded', function() {
    addCalendarSelectionStyles();
});
// ===== 검색 관련 함수 =====
function performSearch() {
  const searchInput = document.getElementById('searchInput');
  const searchType = document.getElementById('searchType');
  const searchResults = document.getElementById('searchResults');
  
  const query = searchInput.value.trim().toLowerCase();
  const type = searchType.value;
  
  if (!query) {
    alert('검색어를 입력해주세요.');
    return;
  }
  
  searchResults.innerHTML = '<p>검색 중...</p>';
  
  // 검색 결과 배열
  let results = [];
  
  // 검색 유형에 따라 다른 데이터 소스 검색
  if (type === 'all' || type === 'diary') {
    results = results.concat(searchDiaries(query));
  }
  
  if (type === 'all' || type === 'memo') {
    results = results.concat(searchMemos(query));
  }
  
  if (type === 'all' || type === 'todo') {
    results = results.concat(searchTodos(query));
  }
  
  if (type === 'all' || type === 'schedule') {
    results = results.concat(searchSchedules(query));
  }
  
  if (type === 'all' || type === 'accountbook') {
    results = results.concat(searchAccountbook(query));
  }
  
  // 최신 항목순으로 정렬
  results.sort((a, b) => new Date(b.date) - new Date(a.date));
  
  // 검색 결과 표시
  renderSearchResults(results, query);
}

// 일기 검색
function searchDiaries(query) {
  const results = [];
  
  diaries.forEach(diary => {
    if (diary.content.toLowerCase().includes(query)) {
      results.push({
        id: diary.id,
        type: 'diary',
        title: `${formatDate(diary.date)} 일기`,
        content: diary.content,
        date: diary.updatedAt || diary.createdAt,
        originalDate: diary.date
      });
    }
  });
  
  return results;
}

// 메모 검색
function searchMemos(query) {
  const results = [];
  
  memos.forEach(memo => {
    if (memo.title.toLowerCase().includes(query) || memo.content.toLowerCase().includes(query)) {
      results.push({
        id: memo.id,
        type: 'memo',
        title: memo.title,
        content: memo.content,
        date: memo.createdAt,
        originalDate: memo.createdAt
      });
    }
  });
  
  return results;
}

// 할일 검색
function searchTodos(query) {
  const results = [];
  
  todos.forEach(todo => {
    if (todo.text.toLowerCase().includes(query)) {
      results.push({
        id: todo.id,
        type: 'todo',
        title: todo.text,
        content: `할일 상태: ${todo.completed ? '완료' : '미완료'}`,
        date: todo.createdAt,
        originalDate: todo.date,
        completed: todo.completed
      });
    }
  });
  
  return results;
}

// 일정 검색
function searchSchedules(query) {
  const results = [];
  
  schedules.forEach(schedule => {
    if (schedule.title.toLowerCase().includes(query) || 
        (schedule.description && schedule.description.toLowerCase().includes(query))) {
      results.push({
        id: schedule.id,
        type: 'schedule',
        title: schedule.title,
        content: schedule.description || '(상세 내용 없음)',
        date: new Date(schedule.date).toISOString(),
        originalDate: schedule.date,
        time: schedule.time
      });
    }
  });
  
  return results;
}

// 가계부 검색
function searchAccountbook(query) {
  const results = [];
  
  accountData.forEach(item => {
    if ((item.memo && item.memo.toLowerCase().includes(query)) || 
        item.category.toLowerCase().includes(query) ||
        item.method.toLowerCase().includes(query)) {
      results.push({
        id: item.id,
        type: 'accountbook',
        title: `${item.type === 'income' ? '수입' : '지출'}: ${item.amount.toLocaleString()}원`,
        content: `카테고리: ${item.category}, 결제방법: ${item.method}${item.memo ? ', 메모: ' + item.memo : ''}`,
        date: new Date(item.date).toISOString(),
        originalDate: item.date
      });
    }
  });
  
  return results;
}

// 검색 결과 렌더링
function renderSearchResults(results, query) {
  const searchResults = document.getElementById('searchResults');
  
  if (results.length === 0) {
    searchResults.innerHTML = '<p class="no-results">검색 결과가 없습니다.</p>';
    return;
  }
  
  searchResults.innerHTML = `<p>총 ${results.length}개의 검색 결과</p>`;
  
  results.forEach(result => {
    const resultItem = document.createElement('div');
    resultItem.className = 'search-result-item';
    
    let typeName = '';
    let typeAction = '';
    
    switch(result.type) {
      case 'diary':
        typeName = '일기';
        typeAction = `showTab('diary'); setTimeout(() => { editDiary(${result.id}); }, 100);`;
        break;
      case 'memo':
        typeName = '메모';
        typeAction = `showTab('memo'); setTimeout(() => { editMemo(${result.id}); }, 100);`;
        break;
      case 'todo':
        typeName = '할일';
        typeAction = `showTab('todo'); setTimeout(() => { editTodo(${result.id}); }, 100);`;
        break;
      case 'schedule':
        typeName = '일정';
        typeAction = `showTab('schedule'); setTimeout(() => { editSchedule(${result.id}); }, 100);`;
        break;
      case 'accountbook':
        typeName = '가계부';
        typeAction = `showTab('accountbook');`;
        break;
    }
    
    // 검색어 강조 표시
    const highlightedContent = highlightSearchQuery(result.content, query);
    const highlightedTitle = highlightSearchQuery(result.title, query);
    
    resultItem.innerHTML = `
      <div class="search-result-header">
        <span class="search-result-category">${typeName}</span>
        <span class="search-result-date">${result.originalDate ? formatDate(result.originalDate) : ''}</span>
      </div>
      <div class="search-result-title">${highlightedTitle}</div>
      <div class="search-result-content">${highlightedContent}</div>
      <div class="search-result-controls">
        <button onclick="${typeAction}">보기</button>
      </div>
    `;
    
    searchResults.appendChild(resultItem);
  });
}

// 검색어 강조 표시
function highlightSearchQuery(text, query) {
  if (!text) return '';
  
  const regex = new RegExp(query, 'gi');
  return text.replace(regex, match => `<span class="search-result-highlight">${match}</span>`);
}

// ===== 목표 관련 함수 =====
let goals = [];
let goalProgress = [];

// 목표 추가
function addGoal() {
  const title = document.getElementById('goalTitle').value.trim();
  const category = document.getElementById('goalCategory').value;
  const startValue = parseFloat(document.getElementById('goalStartValue').value);
  const targetValue = parseFloat(document.getElementById('goalTargetValue').value);
  const unit = document.getElementById('goalUnit').value.trim();
  const startDate = document.getElementById('goalStartDate').value;
  const endDate = document.getElementById('goalEndDate').value;
  const description = document.getElementById('goalDescription').value.trim();
  
  // 기본 유효성 검사
  if (!title) {
    alert('목표 제목을 입력해주세요.');
    return;
  }
  
  if (isNaN(startValue) || isNaN(targetValue)) {
    alert('시작 값과 목표 값은 숫자로 입력해주세요.');
    return;
  }
  
  if (!startDate || !endDate) {
    alert('시작일과 목표일을 모두 입력해주세요.');
    return;
  }
  
  // 날짜 유효성 검사
  if (new Date(endDate) <= new Date(startDate)) {
    alert('목표일은 시작일보다 이후여야 합니다.');
    return;
  }
  
  // 목표 생성
  const goal = {
    id: Date.now(),
    title,
    category,
    startValue,
    targetValue,
    currentValue: startValue, // 초기값은 시작값과 동일
    unit,
    startDate,
    endDate,
    description,
    createdAt: new Date().toISOString()
  };
  
  // 목표 진행 기록 초기 항목 추가
  const initialProgress = {
    goalId: goal.id,
    date: startDate,
    value: startValue
  };
  
  // 데이터 저장
  goals.push(goal);
  goalProgress.push(initialProgress);
  
  saveGoals();
  
  // 입력 필드 초기화
  document.getElementById('goalTitle').value = '';
  document.getElementById('goalStartValue').value = '';
  document.getElementById('goalTargetValue').value = '';
  document.getElementById('goalUnit').value = '';
  document.getElementById('goalDescription').value = '';
  
  // 목표 목록 렌더링
  renderGoals();
  alert('새로운 목표가 추가되었습니다.');
}

// 목표 저장
function saveGoals() {
  localStorage.setItem('goals', JSON.stringify(goals));
  localStorage.setItem('goalProgress', JSON.stringify(goalProgress));
}

// 목표 로드
function loadGoals() {
  try {
    const savedGoals = localStorage.getItem('goals');
    const savedProgress = localStorage.getItem('goalProgress');
    
    if (savedGoals) goals = JSON.parse(savedGoals);
    if (savedProgress) goalProgress = JSON.parse(savedProgress);
    
    renderGoals();
  } catch (e) {
    console.error('목표 데이터 로드 중 오류 발생:', e);
    goals = [];
    goalProgress = [];
  }
}

// 목표 렌더링
function renderGoals() {
  const goalsList = document.getElementById('goalsList');
  
  if (!goalsList) return;
  
  if (goals.length === 0) {
    goalsList.innerHTML = '<p class="no-goals" style="text-align: center; color: #888; padding: 20px;">아직 설정된 목표가 없습니다. 새로운 목표를 추가해보세요!</p>';
    return;
  }
  
  goalsList.innerHTML = '';
  
  // 목표일 기준 정렬 (가까운 목표 먼저)
  goals.sort((a, b) => new Date(a.endDate) - new Date(b.endDate));
  
  goals.forEach(goal => {
    // 현재 진행 상황 계산
    const progress = calculateGoalProgress(goal);
    
    // 남은 일수 계산
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const endDate = new Date(goal.endDate);
    endDate.setHours(0, 0, 0, 0);
    
    const daysRemaining = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
    
    const goalItem = document.createElement('div');
    goalItem.className = 'goal-item';
    
    // 증가/감소에 따른 방향 및 텍스트 색상
    const isIncreasing = goal.targetValue > goal.startValue;
    const directionText = isIncreasing ? '늘리기' : '줄이기';
    const valueColor = isIncreasing ? 
                        (goal.currentValue >= goal.targetValue ? '#4CAF50' : '#333') : 
                        (goal.currentValue <= goal.targetValue ? '#4CAF50' : '#333');
    
    goalItem.innerHTML = `
      <div class="goal-header">
        <div class="goal-title">${goal.title}</div>
        <div class="goal-category">${getCategoryName(goal.category)}</div>
      </div>
      
      <div class="goal-info">
        <div class="goal-info-item">
          <div class="goal-info-label">시작 값</div>
          <div class="goal-info-value">${goal.startValue} ${goal.unit}</div>
        </div>
        <div class="goal-info-item">
          <div class="goal-info-label">현재 값</div>
          <div class="goal-info-value" style="color: ${valueColor}">
            ${goal.currentValue} ${goal.unit}
          </div>
        </div>
        <div class="goal-info-item">
          <div class="goal-info-label">목표 값</div>
          <div class="goal-info-value">${goal.targetValue} ${goal.unit}</div>
        </div>
      </div>
      
      <div class="goal-info">
        <div class="goal-info-item">
          <div class="goal-info-label">시작일</div>
          <div class="goal-info-value">${formatDate(goal.startDate)}</div>
        </div>
        <div class="goal-info-item">
          <div class="goal-info-label">목표일</div>
          <div class="goal-info-value">${formatDate(goal.endDate)}</div>
        </div>
        <div class="goal-info-item">
          <div class="goal-info-label">남은 기간</div>
          <div class="goal-info-value">
            ${daysRemaining <= 0 ? '기간 종료' : `${daysRemaining}일 남음`}
          </div>
        </div>
      </div>
      
      <div class="goal-progress">
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
          <span>진행 상황: ${progress}%</span>
          <span>${directionText}</span>
        </div>
        <div class="goal-progress-bar">
          <div class="goal-progress-fill" style="width: ${progress}%;"></div>
        </div>
      </div>
      
      ${goal.description ? `<div style="margin-bottom: 15px; color: #666;">${goal.description}</div>` : ''}
      
      <div class="goal-controls">
        <button onclick="showGoalUpdateForm(${goal.id})">업데이트</button>
        <button onclick="viewGoalHistory(${goal.id})">기록 보기</button>
        <button class="delete-btn" onclick="deleteGoal(${goal.id})">삭제</button>
      </div>
    `;
    
    goalsList.appendChild(goalItem);
  });
}

// 목표 진행 상황 계산
function calculateGoalProgress(goal) {
  // 목표가 증가인지 감소인지 확인
  const isIncreasing = goal.targetValue > goal.startValue;
  
  // 목표 값과 시작 값의 차이
  const totalDifference = Math.abs(goal.targetValue - goal.startValue);
  
  // 현재까지 달성한 차이
  const currentDifference = Math.abs(goal.currentValue - goal.startValue);
  
  // 진행 상황 계산 (퍼센트)
  let progress = (currentDifference / totalDifference) * 100;
  
  // 이미 목표를 달성했다면 100%로 고정
  if (isIncreasing && goal.currentValue >= goal.targetValue) {
    progress = 100;
  } else if (!isIncreasing && goal.currentValue <= goal.targetValue) {
    progress = 100;
  }
  
  // 범위 제한 (0~100%)
  progress = Math.min(Math.max(progress, 0), 100);
  
  return Math.round(progress);
}

// 목표 업데이트 폼 표시
function showGoalUpdateForm(goalId) {
  const goal = goals.find(g => g.id === goalId);
  if (!goal) return;
  
  const form = document.getElementById('goalUpdateForm');
  const valueInput = document.getElementById('goalUpdateValue');
  const dateInput = document.getElementById('goalUpdateDate');
  const idInput = document.getElementById('goalUpdateId');
  
  valueInput.value = goal.currentValue;
  dateInput.value = new Date().toISOString().split('T')[0]; // 오늘 날짜
  idInput.value = goal.id;
  
  form.style.display = 'block';
  form.scrollIntoView({ behavior: 'smooth' });
}

// 목표 업데이트 폼 닫기
function closeGoalUpdateForm() {
  document.getElementById('goalUpdateForm').style.display = 'none';
}

// 목표 진행 상황 업데이트
function updateGoalProgress() {
  const value = parseFloat(document.getElementById('goalUpdateValue').value);
  const date = document.getElementById('goalUpdateDate').value;
  const goalId = parseInt(document.getElementById('goalUpdateId').value);
  
  if (isNaN(value)) {
    alert('유효한 값을 입력해주세요.');
    return;
  }
  
  if (!date) {
    alert('날짜를 선택해주세요.');
    return;
  }
  
  // 목표 찾기
  const goalIndex = goals.findIndex(g => g.id === goalId);
  if (goalIndex === -1) return;
  
  // 목표 진행 기록 추가
  const newProgress = {
    goalId,
    date,
    value
  };
  
  goalProgress.push(newProgress);
  
  // 목표의 현재 값 업데이트
  goals[goalIndex].currentValue = value;
  
  // 저장 및 업데이트
  saveGoals();
  renderGoals();
  closeGoalUpdateForm();
  
  alert('목표 진행 상황이 업데이트되었습니다.');
}

// 목표 기록 보기
function viewGoalHistory(goalId) {
  const goal = goals.find(g => g.id === goalId);
  if (!goal) return;
  
  // 해당 목표의 진행 기록 가져오기
  const history = goalProgress.filter(p => p.goalId === goalId);
  
  // 날짜순 정렬
  history.sort((a, b) => new Date(a.date) - new Date(b.date));
  
  // 테이블 형태로 표시
  let historyHtml = `
    <h3>${goal.title} 진행 기록</h3>
    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
      <thead>
        <tr style="background-color: #f0f0f0;">
          <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">날짜</th>
          <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">값 (${goal.unit})</th>
        </tr>
      </thead>
      <tbody>
  `;
  
  history.forEach(item => {
    historyHtml += `
      <tr>
        <td style="padding: 8px; border: 1px solid #ddd;">${formatDate(item.date)}</td>
        <td style="padding: 8px; border: 1px solid #ddd;">${item.value} ${goal.unit}</td>
      </tr>
    `;
  });
  
  historyHtml += `
      </tbody>
    </table>
  `;
  
  alert(historyHtml);
}

// 목표 삭제
function deleteGoal(goalId) {
  if (!confirm('이 목표를 삭제하시겠습니까?')) return;
  
  // 목표 삭제
  goals = goals.filter(g => g.id !== goalId);
  
  // 관련 진행 기록도 함께 삭제
  goalProgress = goalProgress.filter(p => p.goalId !== goalId);
  
  // 저장 및 업데이트
  saveGoals();
  renderGoals();
  
  alert('목표가 삭제되었습니다.');
}

// 카테고리 이름 가져오기
function getCategoryName(category) {
  const categories = {
    'weight': '체중',
    'finance': '재정',
    'study': '공부',
    'fitness': '운동',
    'custom': '직접 입력'
  };
  
  return categories[category] || category;
}

// ===== 습관 관련 함수 =====
let habits = [];
let habitRecords = [];
let currentHabitYear = new Date().getFullYear();
let currentHabitMonth = new Date().getMonth();

// 습관 빈도 변경 이벤트 처리
document.addEventListener('DOMContentLoaded', function() {
  const habitFrequency = document.getElementById('habitFrequency');
  const weekDaysContainer = document.getElementById('habitWeekDaysContainer');
  
  if (habitFrequency && weekDaysContainer) {
    habitFrequency.addEventListener('change', function() {
      if (this.value === 'weekly') {
        weekDaysContainer.style.display = 'block';
      } else {
        weekDaysContainer.style.display = 'none';
      }
    });
  }
  
  // 초기 데이터 로드
  loadGoals();
  loadHabits();
});

// 습관 추가 함수 수정 - 주5일(월-금)과 특정일 선택 처리
function addHabit() {
  const title = document.getElementById('habitTitle').value.trim();
  const category = document.getElementById('habitCategory').value;
  const customCategory = document.getElementById('habitCustomCategory')?.value.trim();
  const frequency = document.getElementById('habitFrequency').value;
  const description = document.getElementById('habitDescription').value.trim();
  
  if (!title) {
    alert('습관 이름을 입력해주세요.');
    return;
  }
  
  // 실제 사용할 카테고리 (직접 입력 선택 시 customCategory 사용)
  const finalCategory = category === 'custom' ? (customCategory || '직접 입력') : category;
  
  // 주간 습관인 경우 선택한 요일 또는 주 5일(월-금) 옵션 처리
  let weekDays = [];
  if (frequency === 'weekly') {
    const weekdayOption = document.querySelector('input[name="weekdayOption"]:checked')?.value;
    
    if (weekdayOption === 'weekdays' || !weekdayOption) {
      // 주 5일(월-금) 선택 (디폴트)
      weekDays = [1, 2, 3, 4, 5]; // 월화수목금 (1-5)
    } else if (weekdayOption === 'custom') {
      // 직접 선택
      const checkboxes = document.querySelectorAll('.habitWeekDay:checked');
      weekDays = Array.from(checkboxes).map(cb => parseInt(cb.value));
      
      if (weekDays.length === 0) {
        alert('하나 이상의 요일을 선택해주세요.');
        return;
      }
    }
  }
  
  const habit = {
    id: Date.now(),
    title,
    category: finalCategory,
    frequency,
    weekDays, // 주간인 경우만 사용됨
    description,
    createdAt: new Date().toISOString(),
    streak: 0, // 초기 연속 기록은 0
    color: getRandomHabitColor() // 랜덤 색상 지정
  };
  
  habits.push(habit);
  saveHabits();
  
  // 입력 필드 초기화
  document.getElementById('habitTitle').value = '';
  document.getElementById('habitCategory').value = 'health';
  if (document.getElementById('habitCustomCategory')) {
    document.getElementById('habitCustomCategory').value = '';
    document.getElementById('habitCustomCategory').style.display = 'none';
  }
  document.getElementById('habitFrequency').value = 'daily';
  
  // 주간 옵션 초기화
  const weekdayOptionContainer = document.getElementById('weekdayOptionContainer');
  const customWeekdaysContainer = document.getElementById('customWeekdaysContainer');
  if (weekdayOptionContainer) weekdayOptionContainer.style.display = 'none';
  if (customWeekdaysContainer) customWeekdaysContainer.style.display = 'none';
  
  // 요일 체크박스 초기화
  document.querySelectorAll('.habitWeekDay').forEach(cb => cb.checked = false);
  
  // 주 5일 옵션이 기본값이 되도록 설정
  const weekdaysOption = document.getElementById('weekdaysOption');
  if (weekdaysOption) weekdaysOption.checked = true;
  
  document.getElementById('habitDescription').value = '';
  
  // 습관 목록 및 달력 렌더링
  renderHabits();
  renderHabitCalendar();
  
  alert('새로운 습관이 추가되었습니다.');
}
// 랜덤 습관 색상 생성
function getRandomHabitColor() {
  const colors = [
    '#5f7561', '#4CAF50', '#8BC34A', '#2196F3', '#9C27B0',
    '#FF9800', '#9E9E9E', '#607D8B', '#795548', '#FF5722'
  ];
  
  return colors[Math.floor(Math.random() * colors.length)];
}

// 습관 저장
function saveHabits() {
  localStorage.setItem('habits', JSON.stringify(habits));
  localStorage.setItem('habitRecords', JSON.stringify(habitRecords));
}

// 습관 로드
function loadHabits() {
  try {
    const savedHabits = localStorage.getItem('habits');
    const savedRecords = localStorage.getItem('habitRecords');
    
    if (savedHabits) habits = JSON.parse(savedHabits);
    if (savedRecords) habitRecords = JSON.parse(savedRecords);
    
    renderHabits();
    renderHabitCalendar();
  } catch (e) {
    console.error('습관 데이터 로드 중 오류 발생:', e);
    habits = [];
    habitRecords = [];
  }
}

// 습관 목록 렌더링
function renderHabits() {
  const habitsList = document.getElementById('habitsList');
  
  if (!habitsList) return;
  
  if (habits.length === 0) {
    habitsList.innerHTML = '<p class="no-habits" style="text-align: center; color: #888; padding: 20px;">아직 추가된 습관이 없습니다. 새로운 습관을 추가해보세요!</p>';
    return;
  }
  
  habitsList.innerHTML = '';
  
  // 생성일 기준 정렬 (최신 순)
  habits.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  
  habits.forEach(habit => {
    const habitItem = document.createElement('div');
    habitItem.className = 'habit-list-item';
    
    // 습관 빈도 텍스트
    let frequencyText = '매일';
    if (habit.frequency === 'weekly') {
      const days = ['일', '월', '화', '수', '목', '금', '토'];
      const selectedDays = habit.weekDays.map(day => days[day]).join(', ');
      frequencyText = `매주 ${selectedDays}요일`;
    } else if (habit.frequency === 'monthly') {
      frequencyText = '매월';
    }
    
    // 연속 달성 일수 계산
    const streak = calculateHabitStreak(habit);
    
    habitItem.innerHTML = `
      <div class="habit-list-header">
        <div class="habit-list-title">${habit.title}</div>
        <div class="habit-list-category">${getHabitCategoryName(habit.category)}</div>
      </div>
      
      <div>${frequencyText}</div>
      ${habit.description ? `<div style="margin-top: 8px; color: #666;">${habit.description}</div>` : ''}
      
      <div class="habit-streak">
        <span class="habit-streak-number">${streak}</span> 일 연속 달성 중
      </div>
      
      <div class="habit-list-controls">
        <button onclick="checkHabitToday(${habit.id})">오늘 체크</button>
        <button onclick="viewHabitHistory(${habit.id})">기록 보기</button>
        <button class="delete-btn" onclick="deleteHabit(${habit.id})">삭제</button>
      </div>
    `;
    
    habitsList.appendChild(habitItem);
  });
}

// 습관 달력 렌더링
function renderHabitCalendar() {
  const habitCalendar = document.getElementById('habitCalendar');
  const habitCalendarHeader = document.getElementById('habitCalendarHeader');
  
  if (!habitCalendar || !habitCalendarHeader) return;
  
  habitCalendarHeader.textContent = `${currentHabitYear}년 ${currentHabitMonth + 1}월`;
  
  // 현재 월의 첫날과 마지막 날
  const firstDay = new Date(currentHabitYear, currentHabitMonth, 1);
  const lastDay = new Date(currentHabitYear, currentHabitMonth + 1, 0);
  
  // 첫째 날의 요일 (0: 일요일, 6: 토요일)
  const firstDayOfWeek = firstDay.getDay();
  
  // 마지막 날짜
  const lastDate = lastDay.getDate();
  
  // 오늘 날짜
  const today = new Date();
  const isCurrentMonth = today.getFullYear() === currentHabitYear && today.getMonth() === currentHabitMonth;
  const todayDate = today.getDate();
  
  // 달력 생성
  let calendarHTML = '<div class="habit-calendar-header">';
  const days = ['일', '월', '화', '수', '목', '금', '토'];
  
  // 요일 헤더
  for (let i = 0; i < 7; i++) {
    calendarHTML += `<div class="habit-calendar-day-name">${days[i]}</div>`;
  }
  
  calendarHTML += '</div><div class="habit-calendar-body">';
  
  // 첫째 날 이전의 빈 셀
  for (let i = 0; i < firstDayOfWeek; i++) {
    calendarHTML += '<div class="habit-calendar-day other-month"></div>';
  }
  
  // 날짜 채우기
  for (let day = 1; day <= lastDate; day++) {
    const date = new Date(currentHabitYear, currentHabitMonth, day);
    const dateStr = date.toISOString().split('T')[0];
    const isToday = isCurrentMonth && day === todayDate;
    
    calendarHTML += `
      <div class="habit-calendar-day ${isToday ? 'today' : ''}">
        <div class="habit-day-number">${day}</div>
        <div class="habit-items" data-date="${dateStr}">
    `;
    
    // 오늘과 그 이전 날짜에만 습관 체크 항목 표시
    const isPastOrToday = new Date(dateStr) <= today;
    
    if (isPastOrToday) {
      // 해당 날짜에 체크 가능한 습관 목록 표시
      habits.forEach(habit => {
        // 해당 날짜에 이 습관이 체크 가능한지 확인
        if (isHabitScheduledForDate(habit, date)) {
          // 이 날짜에 습관이 완료되었는지 확인
          const isCompleted = isHabitCompletedOnDate(habit.id, dateStr);
          
          calendarHTML += `
            <div class="habit-item">
              <span class="habit-circle ${isCompleted ? 'completed' : 'missed'}" 
                    style="background-color: ${isCompleted ? habit.color : '#eee'}; border-color: ${habit.color};"
                    title="${habit.title}"></span>
              <span>${habit.title}</span>
            </div>
          `;
        }
      });
    }
    
    calendarHTML += '</div></div>';
  }
  
  // 마지막 주 이후의 빈 셀 채우기
  const lastDayOfWeek = lastDay.getDay();
  const remainingCells = 6 - lastDayOfWeek;
  
  for (let i = 0; i < remainingCells; i++) {
    calendarHTML += '<div class="habit-calendar-day other-month"></div>';
  }
  
  calendarHTML += '</div>';
  habitCalendar.innerHTML = calendarHTML;
}

// 습관이 특정 날짜에 예정되어 있는지 확인
function isHabitScheduledForDate(habit, date) {
  const dayOfWeek = date.getDay(); // 0(일) ~ 6(토)
  
  switch (habit.frequency) {
    case 'daily':
      return true;
    case 'weekly':
      return habit.weekDays.includes(dayOfWeek);
    case 'monthly':
      // 매월 같은 날짜에 습관 체크
      const habitStartDate = new Date(habit.createdAt);
      return date.getDate() === habitStartDate.getDate();
    default:
      return false;
  }
}

// 습관이 특정 날짜에 완료되었는지 확인
function isHabitCompletedOnDate(habitId, dateStr) {
  return habitRecords.some(record => 
    record.habitId === habitId && 
    record.date === dateStr && 
    record.completed
  );
}

// 습관 카테고리 이름 가져오기
function getHabitCategoryName(category) {
  const categories = {
    'health': '건강',
    'study': '공부',
    'selfcare': '자기관리',
    'work': '업무',
    'custom': '직접 입력'
  };
  
  return categories[category] || category;
}

// 오늘 습관 체크
function checkHabitToday(habitId) {
  const habit = habits.find(h => h.id === habitId);
  if (!habit) return;
  
  const today = new Date();
  const dateStr = today.toISOString().split('T')[0];
  
  // 해당 습관이 오늘 체크 가능한지 확인
  if (!isHabitScheduledForDate(habit, today)) {
    alert('오늘은 이 습관의 체크 날짜가 아닙니다.');
    return;
  }
  
  // 이미 체크한 경우
  const existingRecord = habitRecords.find(r => 
    r.habitId === habitId && r.date === dateStr
  );
  
  if (existingRecord) {
    // 토글: 체크되어 있으면 체크 해제, 아니면 체크
    existingRecord.completed = !existingRecord.completed;
    
    if (existingRecord.completed) {
      alert('오늘의 습관을 완료했습니다! 👍');
    } else {
      alert('습관 체크가 취소되었습니다.');
    }
  } else {
    // 새로운 기록 추가
    const newRecord = {
      habitId,
      date: dateStr,
      completed: true
    };
    
    habitRecords.push(newRecord);
    alert('오늘의 습관을 완료했습니다! 👍');
  }
  
  // 연속 달성 일수 업데이트
  updateHabitStreak(habit);
  
  // 저장 및 업데이트
  saveHabits();
  renderHabits();
  renderHabitCalendar();
}

// 습관 연속 달성 일수 계산
function calculateHabitStreak(habit) {
  // 역순으로 날짜 확인 (오늘부터 과거로)
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  let streak = 0;
  let date = new Date(today);
  
  // 최대 365일까지만 체크 (무한 루프 방지)
  for (let i = 0; i < 365; i++) {
    const dateStr = date.toISOString().split('T')[0];
    
    // 해당 날짜에 습관 체크가 예정되어 있는지 확인
    if (isHabitScheduledForDate(habit, date)) {
      // 습관이 완료되었는지 확인
      const completed = isHabitCompletedOnDate(habit.id, dateStr);
      
      if (completed) {
        streak++;
      } else {
        // 완료되지 않은 날짜가 있으면 중단
        break;
      }
    }
    
    // 이전 날짜로 이동
    date.setDate(date.getDate() - 1);
  }
  
  return streak;
}

// 습관 연속 달성 일수 업데이트
function updateHabitStreak(habit) {
  const habitIndex = habits.findIndex(h => h.id === habit.id);
  if (habitIndex === -1) return;
  
  const streak = calculateHabitStreak(habit);
  habits[habitIndex].streak = streak;
}

// 습관 기록 보기
function viewHabitHistory(habitId) {
  const habit = habits.find(h => h.id === habitId);
  if (!habit) return;
  
  // 해당 습관의 모든 기록 가져오기
  const records = habitRecords.filter(r => r.habitId === habitId);
  
  // 날짜순 정렬
  records.sort((a, b) => new Date(b.date) - new Date(a.date));
  
  // 테이블 형태로 표시
  let historyHtml = `
    <h3>${habit.title} 기록</h3>
    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
      <thead>
        <tr style="background-color: #f0f0f0;">
          <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">날짜</th>
          <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">완료 여부</th>
        </tr>
      </thead>
      <tbody>
  `;
  
  if (records.length === 0) {
    historyHtml += `
      <tr>
        <td colspan="2" style="padding: 8px; border: 1px solid #ddd; text-align: center;">
          기록이 없습니다.
        </td>
      </tr>
    `;
  } else {
    records.forEach(record => {
      historyHtml += `
        <tr>
          <td style="padding: 8px; border: 1px solid #ddd;">${formatDate(record.date)}</td>
          <td style="padding: 8px; border: 1px solid #ddd;">
            ${record.completed ? 
              '<span style="color: #4CAF50; font-weight: bold;">✓ 완료</span>' : 
              '<span style="color: #e74c3c;">✗ 미완료</span>'}
          </td>
        </tr>
      `;
    });
  }
  
  historyHtml += `
      </tbody>
    </table>
  `;
  
  alert(historyHtml);
}

// 습관 삭제
function deleteHabit(habitId) {
  if (!confirm('이 습관을 삭제하시겠습니까?')) return;
  
  // 습관 삭제
  habits = habits.filter(h => h.id !== habitId);
  
  // 관련 기록도 함께 삭제
  habitRecords = habitRecords.filter(r => r.habitId !== habitId);
  
  // 저장 및 업데이트
  saveHabits();
  renderHabits();
  renderHabitCalendar();
  
  alert('습관이 삭제되었습니다.');
}

// 습관 달력: 이전달/다음달 이동 함수
function prevHabitMonth() {
  currentHabitMonth--;
  if (currentHabitMonth < 0) {
    currentHabitMonth = 11;
    currentHabitYear--;
  }
  renderHabitCalendar();
}

function nextHabitMonth() {
  currentHabitMonth++;
  if (currentHabitMonth > 11) {
    currentHabitMonth = 0;
    currentHabitYear++;
  }
  renderHabitCalendar();
}

// 기존 loadInitialData 함수 수정 (새로운 탭 초기화 및 데이터 로드)
function loadInitialData() {
  // 기존 코드 유지
  document.getElementById("ab-submit")?.addEventListener("click", addAccountItem);
  document.getElementById("addScheduleBtn")?.addEventListener("click", addSchedule);

  // 로컬 스토리지에서 데이터 로드
  loadDataFromLocalStorage();
  
  loadDiaries();
  loadMemos();
  renderTodos();
  renderTodoCalendar();
  renderWeightCalendar();
  renderWeightList();
  loadSchedules();
  renderScheduleCalendar();
  loadAccountData(); // 가계부 데이터 로드
  
  // 새로운 기능 데이터 로드
  loadGoals();
  loadHabits();
  
  applyCustomHome();
  
  // 기본 날짜 설정 - 모든 날짜 입력 필드에 오늘 날짜 설정
  const today = new Date().toISOString().split('T')[0];
  if (document.getElementById('diaryDate')) document.getElementById('diaryDate').value = today;
  if (document.getElementById('weightDate')) document.getElementById('weightDate').value = today;
  if (document.getElementById('eventDate')) document.getElementById('eventDate').value = today;
  if (document.getElementById('ab-date')) document.getElementById('ab-date').value = today;
  if (document.getElementById('todoDate')) document.getElementById('todoDate').value = today;
  if (document.getElementById('goalStartDate')) document.getElementById('goalStartDate').value = today;
  if (document.getElementById('goalEndDate')) {
    // 목표일은 기본적으로 한 달 뒤로 설정
    const endDate = new Date();
    endDate.setMonth(endDate.getMonth() + 1);
    document.getElementById('goalEndDate').value = endDate.toISOString().split('T')[0];
  }
  if (document.getElementById('goalUpdateDate')) document.getElementById('goalUpdateDate').value = today;
  
  // 습관 빈도 변경 이벤트 리스너 설정
  const habitFrequency = document.getElementById('habitFrequency');
  const weekDaysContainer = document.getElementById('habitWeekDaysContainer');
  
  if (habitFrequency && weekDaysContainer) {
    habitFrequency.addEventListener('change', function() {
      if (this.value === 'weekly') {
        weekDaysContainer.style.display = 'block';
      } else {
        weekDaysContainer.style.display = 'none';
      }
    });
  }

  // 이벤트 리스너 설정
  document.getElementById('save-button')?.addEventListener('click', saveCustomHome);
  document.getElementById('addScheduleBtn')?.addEventListener('click', addSchedule);
  document.getElementById('viewListBtn')?.addEventListener('click', showListView);
  document.getElementById('viewCalendarBtn')?.addEventListener('click', showCalendarView);
  document.getElementById('prevMonthBtn')?.addEventListener('click', prevScheduleMonth);
  document.getElementById('nextMonthBtn')?.addEventListener('click', nextScheduleMonth);
  
  // 가계부 이벤트 리스너 설정
  if (document.getElementById('ab-submit')) {
    document.getElementById('ab-submit').addEventListener('click', addAccountItem);
  }
  
  // 필요한 외부 라이브러리 로드
  loadRequiredLibraries();
}

// 탭 전환 함수 업데이트
function showTab(tabId) {
  // 모든 탭 비활성화
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  document.querySelectorAll('.nav-link').forEach(link => {
    link.classList.remove('active');
  });
  
  // 선택된 탭 활성화
  document.getElementById(tabId).classList.add('active');
  document.querySelector(`.nav-link[onclick="showTab('${tabId}')"]`).classList.add('active');
  
  // 필요한 경우 탭 초기화
  if (tabId === 'diary') loadDiaries();
  if (tabId === 'memo') loadMemos();
  if (tabId === 'todo') {
    renderTodos();
    renderTodoCalendar();
  }
  if (tabId === 'weight') {
    renderWeightCalendar();
    renderWeightList();
  }
  if (tabId === 'schedule') {
    loadSchedules();
    renderScheduleCalendar();

    // 버튼 리스너 수동 재등록
    const calBtn = document.getElementById('viewCalendarBtn');
    const listBtn = document.getElementById('viewListBtn');
    if (calBtn) {
      calBtn.removeEventListener('click', showCalendarView);
      calBtn.addEventListener('click', showCalendarView);
    }
    if (listBtn) {
      listBtn.removeEventListener('click', showListView);
      listBtn.addEventListener('click', showListView);
    }
  }
  if (tabId === 'accountbook') {
    loadAccountData();
    
    // 달력이 표시되지 않는 문제 해결
    setTimeout(function() {
      try {
        const abCalendar = document.getElementById('ab-calendar');
        if (abCalendar) {
          // 달력이 제대로 렌더링되지 않았는지 확인
          const fcContent = abCalendar.querySelector('.fc');
          if (!fcContent || fcContent.offsetHeight < 10) {
            console.log("달력 다시 초기화 중...");
            initializeAccountCalendar();
          }
        }
      } catch (e) {
        console.error("달력 확인 오류:", e);
        initializeAccountCalendar();
      }
    }, 300);
  }
  
  // 새로운 탭 처리
  if (tabId === 'goals') {
    renderGoals();
  }
  if (tabId === 'habits') {
    renderHabits();
    renderHabitCalendar();
  }
}

// 로컬 스토리지 로드 함수 업데이트
function loadDataFromLocalStorage() {
  try {
    diaries = JSON.parse(localStorage.getItem('diaries')) || [];
    memos = JSON.parse(localStorage.getItem('memos')) || [];
    todos = JSON.parse(localStorage.getItem('todos')) || [];
    schedules = JSON.parse(localStorage.getItem('schedules')) || [];
    accountData = JSON.parse(localStorage.getItem('accountData')) || []; // 가계부 데이터 추가
    
    // 새로운 데이터 추가
    goals = JSON.parse(localStorage.getItem('goals')) || [];
    goalProgress = JSON.parse(localStorage.getItem('goalProgress')) || [];
    habits = JSON.parse(localStorage.getItem('habits')) || [];
    habitRecords = JSON.parse(localStorage.getItem('habitRecords')) || [];
  } catch (e) {
    console.error('데이터 로드 중 오류 발생:', e);
    diaries = [];
    memos = [];
    todos = [];
    schedules = [];
    accountData = [];
    goals = [];
    goalProgress = [];
    habits = [];
    habitRecords = [];
  }
}
// ===== 1. 목표 관련 함수 업데이트 =====
let goalSubTasks = []; // 목표 세부 항목을 저장할 배열 추가

// 목표 추가 함수 업데이트
function addGoal() {
  const title = document.getElementById('goalTitle').value.trim();
  const category = document.getElementById('goalCategory').value;
  const customCategory = document.getElementById('goalCustomCategory')?.value.trim();
  const startValue = parseFloat(document.getElementById('goalStartValue').value);
  const targetValue = parseFloat(document.getElementById('goalTargetValue').value);
  const unit = document.getElementById('goalUnit').value.trim();
  const startDate = document.getElementById('goalStartDate').value;
  const endDate = document.getElementById('goalEndDate').value;
  const description = document.getElementById('goalDescription').value.trim();
  
  // 기본 유효성 검사
  if (!title) {
    alert('목표 제목을 입력해주세요.');
    return;
  }
  
  if (isNaN(startValue) || isNaN(targetValue)) {
    alert('시작 값과 목표 값은 숫자로 입력해주세요.');
    return;
  }
  
  if (!startDate || !endDate) {
    alert('시작일과 목표일을 모두 입력해주세요.');
    return;
  }
  
  // 날짜 유효성 검사
  if (new Date(endDate) <= new Date(startDate)) {
    alert('목표일은 시작일보다 이후여야 합니다.');
    return;
  }
  
  // 실제 사용할 카테고리 (직접 입력 선택 시 customCategory 사용)
  const finalCategory = category === 'custom' ? customCategory : category;
  
  // 목표 생성
  const goal = {
    id: Date.now(),
    title,
    category: finalCategory,
    startValue,
    targetValue,
    currentValue: startValue, // 초기값은 시작값과 동일
    unit,
    startDate,
    endDate,
    description,
    createdAt: new Date().toISOString(),
    hasSubTasks: false // 세부 항목 사용 여부
  };
  
  // 목표 진행 기록 초기 항목 추가
  const initialProgress = {
    goalId: goal.id,
    date: startDate,
    value: startValue
  };
  
  // 데이터 저장
  goals.push(goal);
  goalProgress.push(initialProgress);
  
  saveGoals();
  
  // 입력 필드 초기화
  document.getElementById('goalTitle').value = '';
  document.getElementById('goalStartValue').value = '';
  document.getElementById('goalTargetValue').value = '';
  document.getElementById('goalUnit').value = '';
  document.getElementById('goalDescription').value = '';
  if (document.getElementById('goalCustomCategory')) {
    document.getElementById('goalCustomCategory').value = '';
  }
  
  // 목표 목록 렌더링
  renderGoals();
  alert('새로운 목표가 추가되었습니다.');
}

// 목표 저장 함수 업데이트
function saveGoals() {
  localStorage.setItem('goals', JSON.stringify(goals));
  localStorage.setItem('goalProgress', JSON.stringify(goalProgress));
  localStorage.setItem('goalSubTasks', JSON.stringify(goalSubTasks));
}

// 목표 로드 함수 업데이트
function loadGoals() {
  try {
    const savedGoals = localStorage.getItem('goals');
    const savedProgress = localStorage.getItem('goalProgress');
    const savedSubTasks = localStorage.getItem('goalSubTasks');
    
    if (savedGoals) goals = JSON.parse(savedGoals);
    if (savedProgress) goalProgress = JSON.parse(savedProgress);
    if (savedSubTasks) goalSubTasks = JSON.parse(savedSubTasks);
    
    renderGoals();
  } catch (e) {
    console.error('목표 데이터 로드 중 오류 발생:', e);
    goals = [];
    goalProgress = [];
    goalSubTasks = [];
  }
}

// 목표 진행 상황 계산 함수 업데이트 (세부 항목 반영)
function calculateGoalProgress(goal) {
  // 목표에 세부 항목이 있는지 확인
  if (goal.hasSubTasks) {
    // 세부 항목 진행률로 계산
    const subTasks = goalSubTasks.filter(task => task.goalId === goal.id);
    
    if (subTasks.length === 0) return 0; // 세부 항목이 없으면 0% 진행
    
    // 완료된 세부 항목 비율 계산
    const completedTasks = subTasks.filter(task => task.completed);
    return Math.round((completedTasks.length / subTasks.length) * 100);
  } else {
    // 기존 방식 (시작 값과 목표 값 기반)
    // 목표가 증가인지 감소인지 확인
    const isIncreasing = goal.targetValue > goal.startValue;
    
    // 목표 값과 시작 값의 차이
    const totalDifference = Math.abs(goal.targetValue - goal.startValue);
    
    // 현재까지 달성한 차이
    const currentDifference = Math.abs(goal.currentValue - goal.startValue);
    
    // 진행 상황 계산 (퍼센트)
    let progress = (currentDifference / totalDifference) * 100;
    
    // 이미 목표를 달성했다면 100%로 고정
    if (isIncreasing && goal.currentValue >= goal.targetValue) {
      progress = 100;
    } else if (!isIncreasing && goal.currentValue <= goal.targetValue) {
      progress = 100;
    }
    
    // 범위 제한 (0~100%)
    progress = Math.min(Math.max(progress, 0), 100);
    
    return Math.round(progress);
  }
}

// 목표 렌더링 함수 업데이트 (세부 항목 표시)
function renderGoals() {
  const goalsList = document.getElementById('goalsList');
  
  if (!goalsList) return;
  
  if (goals.length === 0) {
    goalsList.innerHTML = '<p class="no-goals" style="text-align: center; color: #888; padding: 20px;">아직 설정된 목표가 없습니다. 새로운 목표를 추가해보세요!</p>';
    return;
  }
  
  goalsList.innerHTML = '';
  
  // 목표일 기준 정렬 (가까운 목표 먼저)
  goals.sort((a, b) => new Date(a.endDate) - new Date(b.endDate));
  
  goals.forEach(goal => {
    // 현재 진행 상황 계산
    const progress = calculateGoalProgress(goal);
    
    // 남은 일수 계산
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const endDate = new Date(goal.endDate);
    endDate.setHours(0, 0, 0, 0);
    
    const daysRemaining = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
    
    const goalItem = document.createElement('div');
    goalItem.className = 'goal-item';
    
    // 증가/감소에 따른 방향 및 텍스트 색상
    const isIncreasing = goal.targetValue > goal.startValue;
    const directionText = isIncreasing ? '늘리기' : '줄이기';
    const valueColor = isIncreasing ? 
                        (goal.currentValue >= goal.targetValue ? '#4CAF50' : '#333') : 
                        (goal.currentValue <= goal.targetValue ? '#4CAF50' : '#333');
    
    // 기본 목표 정보 표시
    let goalHTML = `
      <div class="goal-header">
        <div class="goal-title">${goal.title}</div>
        <div class="goal-category">${goal.category}</div>
      </div>
      
      <div class="goal-info">
        <div class="goal-info-item">
          <div class="goal-info-label">시작 값</div>
          <div class="goal-info-value">${goal.startValue} ${goal.unit}</div>
        </div>
        <div class="goal-info-item">
          <div class="goal-info-label">현재 값</div>
          <div class="goal-info-value" style="color: ${valueColor}">
            ${goal.currentValue} ${goal.unit}
          </div>
        </div>
        <div class="goal-info-item">
          <div class="goal-info-label">목표 값</div>
          <div class="goal-info-value">${goal.targetValue} ${goal.unit}</div>
        </div>
      </div>
      
      <div class="goal-info">
        <div class="goal-info-item">
          <div class="goal-info-label">시작일</div>
          <div class="goal-info-value">${formatDate(goal.startDate)}</div>
        </div>
        <div class="goal-info-item">
          <div class="goal-info-label">목표일</div>
          <div class="goal-info-value">${formatDate(goal.endDate)}</div>
        </div>
        <div class="goal-info-item">
          <div class="goal-info-label">남은 기간</div>
          <div class="goal-info-value">
            ${daysRemaining <= 0 ? '기간 종료' : `${daysRemaining}일 남음`}
          </div>
        </div>
      </div>
      
      <div class="goal-progress">
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
          <span>진행 상황: ${progress}%</span>
          ${goal.hasSubTasks ? '<span>세부 항목 기반</span>' : `<span>${directionText}</span>`}
        </div>
        <div class="goal-progress-bar">
          <div class="goal-progress-fill" style="width: ${progress}%;"></div>
        </div>
      </div>
      
      ${goal.description ? `<div style="margin-bottom: 15px; color: #666;">${goal.description}</div>` : ''}
    `;
    
    // 세부 항목 표시 (있는 경우)
if (goal.hasSubTasks) {
  const subTasks = goalSubTasks.filter(task => task.goalId === goal.id);
  
  goalHTML += `<div class="goal-subtasks" style="margin: 15px 0;">
    <h4 style="margin-bottom: 10px;">세부 항목</h4>`;
  
  if (subTasks.length > 0) {
    goalHTML += `<ul style="padding-left: 20px;">`;
    
    subTasks.forEach(task => {
      goalHTML += `
        <li style="margin-bottom: 8px;">
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <label style="display: flex; align-items: center; flex-grow: 1;">
              <input type="checkbox" ${task.completed ? 'checked' : ''} 
                     onchange="toggleSubTask(${goal.id}, ${task.id})" 
                     style="margin-right: 8px;">
              <span ${task.completed ? 'style="text-decoration: line-through; color: #888;"' : ''}>
                ${task.title}
              </span>
            </label>
            <div style="margin-left: 10px;">
              <button onclick="editSubTask(${goal.id}, ${task.id})" 
                      style="background-color: #5f7561; font-size: 0.8rem; padding: 3px 8px; margin-right: 5px;">
                수정
              </button>
              <button onclick="deleteSubTask(${goal.id}, ${task.id})" 
                      style="background-color: #e74c3c; font-size: 0.8rem; padding: 3px 8px;">
                삭제
              </button>
            </div>
          </div>
        </li>`;
    });
    
    goalHTML += `</ul>`;
  } else {
    goalHTML += `<p style="color: #888; font-style: italic; margin-left: 10px;">항목이 없습니다. '항목 추가' 버튼을 클릭하여 세부 항목을 추가하세요.</p>`;
  }
  
  goalHTML += `
    <button onclick="showAddSubTaskForm(${goal.id})" 
            style="margin-top: 10px; background-color: #8fa88e; font-size: 0.9rem; padding: 5px 10px;">
      항목 추가
    </button>
  </div>`;
}
    
    // 목표 조작 버튼
    goalHTML += `
      <div class="goal-controls">
        ${!goal.hasSubTasks ? `<button onclick="showGoalUpdateForm(${goal.id})">업데이트</button>` : ''}
        <button onclick="toggleSubTasks(${goal.id})">${goal.hasSubTasks ? '세부항목 사용 중지' : '세부항목 사용'}</button>
        <button onclick="viewGoalHistory(${goal.id})">기록 보기</button>
        <button class="delete-btn" onclick="deleteGoal(${goal.id})">삭제</button>
      </div>
    `;
    
    goalItem.innerHTML = goalHTML;
    goalsList.appendChild(goalItem);
  });
  
// 세부 항목 추가/수정 폼 (동적으로 추가)
const subTaskForm = document.getElementById('subTaskForm');
if (!subTaskForm) {
  const form = document.createElement('div');
  form.id = 'subTaskForm';
  form.style.display = 'none';
  form.style.background = '#d7d5cb';
  form.style.padding = '15px';
  form.style.borderRadius = '8px';
  form.style.margin = '20px 0';
  form.innerHTML = `
    <h3 id="subTaskFormTitle" style="margin-top: 0;">세부 항목 추가</h3>
    <div style="margin-bottom: 15px;">
      <label for="subTaskTitle">항목 이름</label>
      <input id="subTaskTitle" type="text" style="width: 100%; margin-top: 5px; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
    </div>
    <input id="subTaskGoalId" type="hidden">
    <input id="subTaskId" type="hidden">
    <div style="text-align: right;">
      <button id="subTaskFormButton" onclick="addSubTask()">추가</button>
      <button onclick="closeSubTaskForm()" style="background-color: #95a5a6;">취소</button>
    </div>
  `;    
    const goalsList = document.getElementById('goalsList');
    if (goalsList) {
      goalsList.parentNode.insertBefore(form, goalsList.nextSibling);
    }
  }
}

// 세부 항목 관련 함수들
function toggleSubTasks(goalId) {
  const goalIndex = goals.findIndex(g => g.id === goalId);
  if (goalIndex === -1) return;
  
  // 세부 항목 사용 상태 토글
  goals[goalIndex].hasSubTasks = !goals[goalIndex].hasSubTasks;
  
  // 처음 세부 항목을 활성화하는 경우, 예제 항목 추가
  if (goals[goalIndex].hasSubTasks && !goalSubTasks.some(task => task.goalId === goalId)) {
    // 예제 세부 항목 3개 추가
    addDefaultSubTasks(goalId);
  }
  
  saveGoals();
  renderGoals();
}

// 기본 세부 항목 추가 함수 수정 - 기본 항목 추가하지 않음
function addDefaultSubTasks(goalId) {
  // 사용자가 직접 항목 추가할 수 있도록 비워두기
  // 기본 항목 없음
}
// 세부 항목 추가 폼 표시
function showAddSubTaskForm(goalId) {
  const form = document.getElementById('subTaskForm');
  if (!form) return;
  
  document.getElementById('subTaskTitle').value = '';
  document.getElementById('subTaskGoalId').value = goalId;
  document.getElementById('subTaskId').value = ''; // 새 항목 추가 시에는 ID 비움
  
  // 제목과 버튼 텍스트 업데이트
  document.getElementById('subTaskFormTitle').textContent = '세부 항목 추가';
  document.getElementById('subTaskFormButton').textContent = '추가';
  
  form.style.display = 'block';
  form.scrollIntoView({ behavior: 'smooth' });
}
// 세부 항목 추가 폼 닫기
function closeSubTaskForm() {
  const form = document.getElementById('subTaskForm');
  if (form) form.style.display = 'none';
}

// 세부 항목 추가 함수 수정 - 추가와 수정 모두 처리
function addSubTask() {
  const title = document.getElementById('subTaskTitle').value.trim();
  const goalId = parseInt(document.getElementById('subTaskGoalId').value);
  const taskId = document.getElementById('subTaskId').value; // 수정 시 사용
  
  if (!title) {
    alert('항목 이름을 입력해주세요.');
    return;
  }
  
  // 수정 모드인 경우
  if (taskId) {
    const taskIndex = goalSubTasks.findIndex(t => t.id === parseInt(taskId));
    if (taskIndex !== -1) {
      goalSubTasks[taskIndex].title = title;
      
      saveGoals();
      renderGoals();
      closeSubTaskForm();
      return;
    }
  }
  
  // 새 항목 추가
  const subTask = {
    id: Date.now(),
    goalId: goalId,
    title: title,
    completed: false,
    createdAt: new Date().toISOString()
  };
  
  goalSubTasks.push(subTask);
  saveGoals();
  renderGoals();
  closeSubTaskForm();
}
// 세부 항목 토글 (완료/미완료)
function toggleSubTask(goalId, taskId) {
  const taskIndex = goalSubTasks.findIndex(t => t.id === taskId);
  if (taskIndex === -1) return;
  
  // 상태 토글
  goalSubTasks[taskIndex].completed = !goalSubTasks[taskIndex].completed;
  
  saveGoals();
  renderGoals();
}

// ===== 2. 습관 관련 함수 업데이트 =====

// 습관 추가 함수 업데이트
function addHabit() {
  const title = document.getElementById('habitTitle').value.trim();
  const category = document.getElementById('habitCategory').value;
  const customCategory = document.getElementById('habitCustomCategory')?.value.trim();
  const frequency = document.getElementById('habitFrequency').value;
  const description = document.getElementById('habitDescription').value.trim();
  
  if (!title) {
    alert('습관 이름을 입력해주세요.');
    return;
  }
  
  // 실제 사용할 카테고리 (직접 입력 선택 시 customCategory 사용)
  const finalCategory = category === 'custom' ? customCategory : category;
  
  // 주간 습관인 경우 선택한 요일 또는 주 5일(월-금) 옵션 처리
  let weekDays = [];
  if (frequency === 'weekly') {
    const weekdayOption = document.querySelector('input[name="weekdayOption"]:checked')?.value;
    
    if (weekdayOption === 'weekdays') {
      // 주 5일(월-금) 선택
      weekDays = [1, 2, 3, 4, 5]; // 월화수목금 (1-5)
    } else if (weekdayOption === 'custom') {
      // 직접 선택
      const checkboxes = document.querySelectorAll('.habitWeekDay:checked');
      weekDays = Array.from(checkboxes).map(cb => parseInt(cb.value));
      
      if (weekDays.length === 0) {
        alert('하나 이상의 요일을 선택해주세요.');
        return;
      }
    }
  }
  
  const habit = {
    id: Date.now(),
    title,
    category: finalCategory,
    frequency,
    weekDays, // 주간인 경우만 사용됨
    description,
    createdAt: new Date().toISOString(),
    streak: 0, // 초기 연속 기록은 0
    color: getRandomHabitColor() // 랜덤 색상 지정
  };
  
  habits.push(habit);
  saveHabits();
  
  // 입력 필드 초기화
  document.getElementById('habitTitle').value = '';
  document.getElementById('habitCategory').value = 'health';
  if (document.getElementById('habitCustomCategory')) {
    document.getElementById('habitCustomCategory').value = '';
    document.getElementById('habitCustomCategory').style.display = 'none';
  }
  document.getElementById('habitFrequency').value = 'daily';
  document.getElementById('habitWeekDaysContainer').style.display = 'none';
  document.querySelectorAll('.habitWeekDay').forEach(cb => cb.checked = false);
  document.getElementById('habitDescription').value = '';
  
  // 습관 목록 및 달력 렌더링
  renderHabits();
  renderHabitCalendar();
  
  alert('새로운 습관이 추가되었습니다.');
}

// 습관이 특정 날짜에 예정되어 있는지 확인하는 함수 업데이트
function isHabitScheduledForDate(habit, date) {
  const dayOfWeek = date.getDay(); // 0(일) ~ 6(토)
  
  switch (habit.frequency) {
    case 'daily':
      return true;
    case 'weekly':
      return habit.weekDays.includes(dayOfWeek);
    case 'monthly':
      // 매월 같은 날짜에 습관 체크
      const habitStartDate = new Date(habit.createdAt);
      return date.getDate() === habitStartDate.getDate();
    default:
      return false;
  }
}

// 습관 렌더링 함수 업데이트 (카테고리 직접 입력 표시)
function renderHabits() {
  const habitsList = document.getElementById('habitsList');
  
  if (!habitsList) return;
  
  if (habits.length === 0) {
    habitsList.innerHTML = '<p class="no-habits" style="text-align: center; color: #888; padding: 20px;">아직 추가된 습관이 없습니다. 새로운 습관을 추가해보세요!</p>';
    return;
  }
  
  habitsList.innerHTML = '';
  
  // 생성일 기준 정렬 (최신 순)
  habits.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  
  habits.forEach(habit => {
    const habitItem = document.createElement('div');
    habitItem.className = 'habit-list-item';
    
    // 습관 빈도 텍스트
    let frequencyText = '매일';
    if (habit.frequency === 'weekly') {
      const days = ['일', '월', '화', '수', '목', '금', '토'];
      
      // 주 5일(월-금) 여부 확인
      if (JSON.stringify(habit.weekDays.sort()) === JSON.stringify([1, 2, 3, 4, 5])) {
        frequencyText = '주 5일 (월-금)';
      } else {
        const selectedDays = habit.weekDays.map(day => days[day]).join(', ');
        frequencyText = `매주 ${selectedDays}요일`;
      }
    } else if (habit.frequency === 'monthly') {
      frequencyText = '매월';
    }
    
    // 연속 달성 일수 계산
    const streak = calculateHabitStreak(habit);
    
    habitItem.innerHTML = `
      <div class="habit-list-header">
        <div class="habit-list-title">${habit.title}</div>
        <div class="habit-list-category">${habit.category}</div>
      </div>
      
      <div>${frequencyText}</div>
      ${habit.description ? `<div style="margin-top: 8px; color: #666;">${habit.description}</div>` : ''}
      
      <div class="habit-streak">
        <span class="habit-streak-number">${streak}</span> 일 연속 달성 중
      </div>
      
      <div class="habit-list-controls">
        <button onclick="checkHabitToday(${habit.id})">오늘 체크</button>
        <button onclick="viewHabitHistory(${habit.id})">기록 보기</button>
        <button class="delete-btn" onclick="deleteHabit(${habit.id})">삭제</button>
      </div>
    `;
    
    habitsList.appendChild(habitItem);
  });
}

// ===== 3. 통합 검색 함수 업데이트 =====
function performSearch() {
  const searchInput = document.getElementById('searchInput');
  const searchType = document.getElementById('searchType');
  const searchResults = document.getElementById('searchResults');
  
  const query = searchInput.value.trim().toLowerCase();
  const type = searchType.value;
  
  if (!query) {
    alert('검색어를 입력해주세요.');
    return;
  }
  
  searchResults.innerHTML = '<p>검색 중...</p>';
  
  // 검색 결과 배열
  let results = [];
  
  // 검색 유형에 따라 다른 데이터 소스 검색
  if (type === 'all' || type === 'diary') {
    results = results.concat(searchDiaries(query));
  }
  
  if (type === 'all' || type === 'memo') {
    results = results.concat(searchMemos(query));
  }
  
  if (type === 'all' || type === 'todo') {
    results = results.concat(searchTodos(query));
  }
  
  if (type === 'all' || type === 'schedule') {
    results = results.concat(searchSchedules(query));
  }
  
  if (type === 'all' || type === 'accountbook') {
    results = results.concat(searchAccountbook(query));
  }
  
  // 추가: 목표와 습관 검색 (전체 검색 시 포함)
  if (type === 'all' || type === 'goals') {
    results = results.concat(searchGoals(query));
  }
  
  if (type === 'all' || type === 'habits') {
    results = results.concat(searchHabits(query));
  }
  
  // 최신 항목순으로 정렬
  results.sort((a, b) => new Date(b.date) - new Date(a.date));
  
  // 검색 결과 표시
  renderSearchResults(results, query);
}

// 목표 검색 함수 추가
function searchGoals(query) {
  const results = [];
  
  goals.forEach(goal => {
    if (goal.title.toLowerCase().includes(query) || 
        goal.description?.toLowerCase().includes(query) ||
        goal.category.toLowerCase().includes(query)) {
      results.push({
        id: goal.id,
        type: 'goals',
        title: goal.title,
        content: `목표: ${goal.startValue} ${goal.unit} → ${goal.targetValue} ${goal.unit}, ${goal.description || ''}`,
        date: goal.createdAt,
        originalDate: goal.startDate
      });
    }
    
    // 세부 항목 검색
    const subTasks = goalSubTasks.filter(task => task.goalId === goal.id);
    
    subTasks.forEach(task => {
      if (task.title.toLowerCase().includes(query)) {
        results.push({
          id: goal.id,
          type: 'goals',
          title: `${goal.title} (세부항목: ${task.title})`,
          content: `세부항목: ${task.title}, 상태: ${task.completed ? '완료' : '미완료'}`,
          date: task.createdAt,
          originalDate: goal.startDate
        });
      }
    });
  });
  
  return results;
}

// 습관 검색 함수 추가
function searchHabits(query) {
  const results = [];
  
  habits.forEach(habit => {
    if (habit.title.toLowerCase().includes(query) || 
        habit.description?.toLowerCase().includes(query) ||
        habit.category.toLowerCase().includes(query)) {
      
      // 습관 빈도 텍스트
      let frequencyText = '매일';
      if (habit.frequency === 'weekly') {
        const days = ['일', '월', '화', '수', '목', '금', '토'];
        
        // 주 5일(월-금) 여부 확인
        if (JSON.stringify(habit.weekDays.sort()) === JSON.stringify([1, 2, 3, 4, 5])) {
          frequencyText = '주 5일 (월-금)';
        } else {
          const selectedDays = habit.weekDays.map(day => days[day]).join(', ');
          frequencyText = `매주 ${selectedDays}요일`;
        }
      } else if (habit.frequency === 'monthly') {
        frequencyText = '매월';
      }
      
      results.push({
        id: habit.id,
        type: 'habits',
        title: habit.title,
        content: `카테고리: ${habit.category}, 빈도: ${frequencyText}, ${habit.description || ''}`,
        date: habit.createdAt,
        originalDate: habit.createdAt
      });
    }
  });
  
  return results;
}

// 카테고리 직접 입력 및 주 5일 옵션 토글 함수
function toggleCategoryInput() {
  const category = document.getElementById('goalCategory');
  const customCategory = document.getElementById('goalCustomCategory');
  
  if (category.value === 'custom') {
    if (customCategory) {
      customCategory.style.display = 'block';
      customCategory.focus();
    }
  } else {
    if (customCategory) customCategory.style.display = 'none';
  }
}

function toggleHabitCategoryInput() {
  const category = document.getElementById('habitCategory');
  const customCategory = document.getElementById('habitCustomCategory');
  
  if (category.value === 'custom') {
    if (customCategory) {
      customCategory.style.display = 'block';
      customCategory.focus();
    }
  } else {
    if (customCategory) customCategory.style.display = 'none';
  }
}

function toggleWeekdayOptions() {
  const frequency = document.getElementById('habitFrequency');
  const weekdayOptionContainer = document.getElementById('weekdayOptionContainer');
  const customWeekdaysContainer = document.getElementById('customWeekdaysContainer');
  
  if (frequency.value === 'weekly') {
    if (weekdayOptionContainer) weekdayOptionContainer.style.display = 'block';
    
    // 기본으로 주 5일(월-금) 선택
    const weekdaysOption = document.getElementById('weekdaysOption');
    if (weekdaysOption) weekdaysOption.checked = true;
    
    // 커스텀 요일 숨기기
    if (customWeekdaysContainer) customWeekdaysContainer.style.display = 'none';
  } else {
    if (weekdayOptionContainer) weekdayOptionContainer.style.display = 'none';
    if (customWeekdaysContainer) customWeekdaysContainer.style.display = 'none';
  }
}

function toggleCustomWeekdays() {
  const weekdayOption = document.querySelector('input[name="weekdayOption"]:checked')?.value;
  const customWeekdaysContainer = document.getElementById('customWeekdaysContainer');
  
  if (weekdayOption === 'custom') {
    if (customWeekdaysContainer) customWeekdaysContainer.style.display = 'block';
  } else {
    if (customWeekdaysContainer) customWeekdaysContainer.style.display = 'none';
  }
}

// 로컬 스토리지 로드 함수 업데이트
function loadDataFromLocalStorage() {
  try {
    diaries = JSON.parse(localStorage.getItem('diaries')) || [];
    memos = JSON.parse(localStorage.getItem('memos')) || [];
    todos = JSON.parse(localStorage.getItem('todos')) || [];
    schedules = JSON.parse(localStorage.getItem('schedules')) || [];
    accountData = JSON.parse(localStorage.getItem('accountData')) || [];
    
    // 새로운 데이터 추가
    goals = JSON.parse(localStorage.getItem('goals')) || [];
    goalProgress = JSON.parse(localStorage.getItem('goalProgress')) || [];
    goalSubTasks = JSON.parse(localStorage.getItem('goalSubTasks')) || []; // 목표 세부 항목 로드
    habits = JSON.parse(localStorage.getItem('habits')) || [];
    habitRecords = JSON.parse(localStorage.getItem('habitRecords')) || [];
  } catch (e) {
    console.error('데이터 로드 중 오류 발생:', e);
    diaries = [];
    memos = [];
    todos = [];
    schedules = [];
    accountData = [];
    goals = [];
    goalProgress = [];
    goalSubTasks = [];
    habits = [];
    habitRecords = [];
  }
}

// 문서 로드 시 이벤트 리스너 설정
document.addEventListener('DOMContentLoaded', function() {
  // 목표 카테고리 변경 이벤트
  const goalCategory = document.getElementById('goalCategory');
  if (goalCategory) {
    goalCategory.addEventListener('change', toggleCategoryInput);
  }
  
  // 습관 카테고리 변경 이벤트
  const habitCategory = document.getElementById('habitCategory');
  if (habitCategory) {
    habitCategory.addEventListener('change', toggleHabitCategoryInput);
  }
  
  // 습관 빈도 변경 이벤트
  const habitFrequency = document.getElementById('habitFrequency');
  if (habitFrequency) {
    habitFrequency.addEventListener('change', toggleWeekdayOptions);
  }
  
  // 주간 옵션 라디오 버튼 변경 이벤트
  const weekdayOptions = document.querySelectorAll('input[name="weekdayOption"]');
  weekdayOptions.forEach(option => {
    option.addEventListener('change', toggleCustomWeekdays);
  });
  
  // 초기 데이터 로드
  loadGoals();
  loadHabits();
});
// 세부 항목 수정 함수 추가
function editSubTask(goalId, taskId) {
  const task = goalSubTasks.find(t => t.id === taskId);
  if (!task) return;
  
  const form = document.getElementById('subTaskForm');
  if (!form) return;
  
  document.getElementById('subTaskTitle').value = task.title;
  document.getElementById('subTaskGoalId').value = goalId;
  document.getElementById('subTaskId').value = taskId;
  
  // 제목과 버튼 텍스트 업데이트
  document.getElementById('subTaskFormTitle').textContent = '세부 항목 수정';
  document.getElementById('subTaskFormButton').textContent = '수정';
  
  form.style.display = 'block';
  form.scrollIntoView({ behavior: 'smooth' });
}

// 세부 항목 삭제 함수 추가
function deleteSubTask(goalId, taskId) {
  if (!confirm('이 항목을 삭제하시겠습니까?')) return;
  
  goalSubTasks = goalSubTasks.filter(task => task.id !== taskId);
  
  saveGoals();
  renderGoals();
}
// 습관 HTML 수정을 위한 코드
function updateHabitHTML() {
  // 습관 추가 폼의 HTML이 제대로 적용되었는지 확인
  const habitFrequency = document.getElementById('habitFrequency');
  const weekdayOptionContainer = document.getElementById('weekdayOptionContainer');
  const customWeekdaysContainer = document.getElementById('customWeekdaysContainer');
  const habitCategory = document.getElementById('habitCategory');
  const habitCustomCategory = document.getElementById('habitCustomCategory');
  
  // 요소들이 없으면 생성
  if (!weekdayOptionContainer) {
    const habitForm = document.querySelector('.tab-content#habits .form-group');
    if (habitForm) {
      // 기존 습관 주기 폼 찾기
      const frequencyField = habitForm.querySelector('div:has(#habitFrequency)');
      
      if (frequencyField) {
        // 주간 옵션 컨테이너 추가
        const weekdayOptions = document.createElement('div');
        weekdayOptions.id = 'weekdayOptionContainer';
        weekdayOptions.style.display = 'none';
        weekdayOptions.style.flex = '2';
        weekdayOptions.style.minWidth = '300px';
        weekdayOptions.innerHTML = `
          <label>주간 옵션</label>
          <div style="display: flex; gap: 15px; margin-top: 5px;">
            <label style="display: flex; align-items: center;">
              <input type="radio" name="weekdayOption" id="weekdaysOption" value="weekdays" checked onchange="toggleCustomWeekdays()"> 
              주 5일 (월-금)
            </label>
            <label style="display: flex; align-items: center;">
              <input type="radio" name="weekdayOption" id="customDaysOption" value="custom" onchange="toggleCustomWeekdays()"> 
              직접 선택
            </label>
          </div>
        `;
        
        // 주기 필드 다음에 삽입
        frequencyField.parentNode.insertBefore(weekdayOptions, frequencyField.nextSibling);
      }
      
      // 요일 직접 선택 컨테이너 추가
      if (!customWeekdaysContainer) {
        const customWeekdays = document.createElement('div');
        customWeekdays.id = 'customWeekdaysContainer';
        customWeekdays.style.marginTop = '15px';
        customWeekdays.style.display = 'none';
        customWeekdays.innerHTML = `
          <label>요일 선택</label>
          <div style="display: flex; gap: 8px; margin-top: 5px;">
            <label style="display: flex; align-items: center;"><input type="checkbox" value="0" class="habitWeekDay"> 일</label>
            <label style="display: flex; align-items: center;"><input type="checkbox" value="1" class="habitWeekDay"> 월</label>
            <label style="display: flex; align-items: center;"><input type="checkbox" value="2" class="habitWeekDay"> 화</label>
            <label style="display: flex; align-items: center;"><input type="checkbox" value="3" class="habitWeekDay"> 수</label>
            <label style="display: flex; align-items: center;"><input type="checkbox" value="4" class="habitWeekDay"> 목</label>
            <label style="display: flex; align-items: center;"><input type="checkbox" value="5" class="habitWeekDay"> 금</label>
            <label style="display: flex; align-items: center;"><input type="checkbox" value="6" class="habitWeekDay"> 토</label>
          </div>
        `;
        
        // 최소한 주기 필드가 있는 부모 요소에 삽입
        if (frequencyField && frequencyField.parentNode) {
          frequencyField.parentNode.insertBefore(customWeekdays, 
            weekdayOptionContainer ? weekdayOptionContainer.nextSibling : frequencyField.nextSibling);
        } else {
          // 폼 자체에 추가
          habitForm.appendChild(customWeekdays);
        }
      }
    }
  }
  
  // 카테고리 직접 입력 필드 확인
  if (!habitCustomCategory && habitCategory) {
    const categoryContainer = habitCategory.parentElement;
    if (categoryContainer) {
      const customInput = document.createElement('input');
      customInput.id = 'habitCustomCategory';
      customInput.type = 'text';
      customInput.placeholder = '카테고리 직접 입력';
      customInput.style.display = 'none';
      customInput.style.marginTop = '8px';
      customInput.style.width = '100%';
      
      categoryContainer.appendChild(customInput);
    }
  }
  
  // 이벤트 리스너 재설정
  if (habitFrequency) {
    habitFrequency.removeEventListener('change', toggleWeekdayOptions);
    habitFrequency.addEventListener('change', toggleWeekdayOptions);
  }
  
  if (habitCategory) {
    habitCategory.removeEventListener('change', toggleHabitCategoryInput);
    habitCategory.addEventListener('change', toggleHabitCategoryInput);
  }
  
  const weekdayOptions = document.querySelectorAll('input[name="weekdayOption"]');
  weekdayOptions.forEach(option => {
    option.removeEventListener('change', toggleCustomWeekdays);
    option.addEventListener('change', toggleCustomWeekdays);
  });
}
// 페이지 로드 시 호출할 함수
document.addEventListener('DOMContentLoaded', function() {
  // 기존 이벤트 리스너를 유지하면서 추가
  const existingLoad = window.onload;
  window.onload = function() {
    if (existingLoad) existingLoad();
    
    // 습관 HTML 업데이트
    setTimeout(updateHabitHTML, 500);
  };
});
// 습관 관련 함수 개선
function initializeHabitFunctions() {
  // 이벤트 리스너 재설정
  const habitFrequency = document.getElementById('habitFrequency');
  const habitCategory = document.getElementById('habitCategory');
  
  if (habitFrequency) {
    habitFrequency.addEventListener('change', function() {
      toggleWeekdayOptions();
    });
  }
  
  if (habitCategory) {
    habitCategory.addEventListener('change', function() {
      toggleHabitCategoryInput();
    });
  }
  
  // 주간 옵션 라디오 버튼에 이벤트 리스너 추가
  const weekdayOptions = document.querySelectorAll('input[name="weekdayOption"]');
  weekdayOptions.forEach(option => {
    option.addEventListener('change', function() {
      toggleCustomWeekdays();
    });
  });
}

// 습관 추가 함수 개선
function addHabit() {
  const title = document.getElementById('habitTitle').value.trim();
  const category = document.getElementById('habitCategory').value;
  const customCategory = document.getElementById('habitCustomCategory')?.value.trim();
  const frequency = document.getElementById('habitFrequency').value;
  const description = document.getElementById('habitDescription').value.trim();
  
  if (!title) {
    alert('습관 이름을 입력해주세요.');
    return;
  }
  
  // 실제 사용할 카테고리 (직접 입력 선택 시 customCategory 사용)
  let finalCategory = category;
  if (category === 'custom' && customCategory) {
    finalCategory = customCategory;
  }
  
  // 주간 습관인 경우 선택한 요일 또는 주 5일(월-금) 옵션 처리
  let weekDays = [];
  if (frequency === 'weekly') {
    const weekdayOption = document.querySelector('input[name="weekdayOption"]:checked')?.value;
    
    if (weekdayOption === 'weekdays' || !weekdayOption) {
      // 주 5일(월-금) 선택 (디폴트)
      weekDays = [1, 2, 3, 4, 5]; // 월화수목금 (1-5)
      console.log("주 5일 선택됨:", weekDays);
    } else if (weekdayOption === 'custom') {
      // 직접 선택
      const checkboxes = document.querySelectorAll('.habitWeekDay:checked');
      weekDays = Array.from(checkboxes).map(cb => parseInt(cb.value));
      console.log("직접 선택된 요일:", weekDays);
      
      if (weekDays.length === 0) {
        alert('하나 이상의 요일을 선택해주세요.');
        return;
      }
    }
  }
  
  const habit = {
    id: Date.now(),
    title,
    category: finalCategory,
    frequency,
    weekDays, // 주간인 경우만 사용됨
    description,
    createdAt: new Date().toISOString(),
    streak: 0, // 초기 연속 기록은 0
    color: getRandomHabitColor() // 랜덤 색상 지정
  };
  
  console.log("추가될 습관:", habit);
  habits.push(habit);
  saveHabits();
  
  // 입력 필드 초기화
  document.getElementById('habitTitle').value = '';
  document.getElementById('habitCategory').value = 'health';
  if (document.getElementById('habitCustomCategory')) {
    document.getElementById('habitCustomCategory').value = '';
    document.getElementById('habitCustomCategory').style.display = 'none';
  }
  document.getElementById('habitFrequency').value = 'daily';
  
  // 주간 옵션 초기화
  const weekdayOptionContainer = document.getElementById('weekdayOptionContainer');
  const customWeekdaysContainer = document.getElementById('customWeekdaysContainer');
  if (weekdayOptionContainer) weekdayOptionContainer.style.display = 'none';
  if (customWeekdaysContainer) customWeekdaysContainer.style.display = 'none';
  
  // 요일 체크박스 초기화
  document.querySelectorAll('.habitWeekDay').forEach(cb => cb.checked = false);
  
  // 주 5일 옵션이 기본값이 되도록 설정
  const weekdaysOption = document.getElementById('weekdaysOption');
  if (weekdaysOption) weekdaysOption.checked = true;
  
  document.getElementById('habitDescription').value = '';
  
  // 습관 목록 및 달력 렌더링
  renderHabits();
  renderHabitCalendar();
  
  alert('새로운 습관이 추가되었습니다.');
}

// 토글 함수 개선
function toggleHabitCategoryInput() {
  console.log("카테고리 토글 실행");
  const category = document.getElementById('habitCategory');
  const customCategory = document.getElementById('habitCustomCategory');
  
  if (category && customCategory) {
    if (category.value === 'custom') {
      customCategory.style.display = 'block';
      customCategory.focus();
      console.log("직접 입력 필드 표시");
    } else {
      customCategory.style.display = 'none';
      console.log("직접 입력 필드 숨김");
    }
  } else {
    console.log("카테고리 요소 찾을 수 없음:", category, customCategory);
  }
}

function toggleWeekdayOptions() {
  console.log("주간 옵션 토글 실행");
  const frequency = document.getElementById('habitFrequency');
  const weekdayOptionContainer = document.getElementById('weekdayOptionContainer');
  const customWeekdaysContainer = document.getElementById('customWeekdaysContainer');
  
  if (frequency && weekdayOptionContainer) {
    if (frequency.value === 'weekly') {
      weekdayOptionContainer.style.display = 'block';
      
      // 기본으로 주 5일(월-금) 선택
      const weekdaysOption = document.getElementById('weekdaysOption');
      if (weekdaysOption) {
        weekdaysOption.checked = true;
        console.log("주 5일 옵션 기본 선택됨");
      }
      
      // 커스텀 요일 숨기기
      if (customWeekdaysContainer) customWeekdaysContainer.style.display = 'none';
    } else {
      if (weekdayOptionContainer) weekdayOptionContainer.style.display = 'none';
      if (customWeekdaysContainer) customWeekdaysContainer.style.display = 'none';
    }
  } else {
    console.log("주간 옵션 요소 찾을 수 없음");
  }
}

function toggleCustomWeekdays() {
  console.log("커스텀 요일 토글 실행");
  const weekdayOption = document.querySelector('input[name="weekdayOption"]:checked')?.value;
  console.log("선택된 옵션:", weekdayOption);
  const customWeekdaysContainer = document.getElementById('customWeekdaysContainer');
  
  if (customWeekdaysContainer) {
    if (weekdayOption === 'custom') {
      customWeekdaysContainer.style.display = 'block';
      console.log("커스텀 요일 컨테이너 표시");
    } else {
      customWeekdaysContainer.style.display = 'none';
      console.log("커스텀 요일 컨테이너 숨김");
    }
  } else {
    console.log("커스텀 요일 컨테이너 찾을 수 없음");
  }
}

// 페이지 로드 시 함수 실행
document.addEventListener('DOMContentLoaded', function() {
  console.log("DOM 로드됨, 습관 기능 초기화");
  
  // 초기 설정
  const existingLoad = window.onload;
  window.onload = function() {
    if (existingLoad) existingLoad();
    
    console.log("습관 HTML 업데이트 실행");
    updateHabitHTML();
    
    // 이벤트 리스너 설정
    setTimeout(function() {
      initializeHabitFunctions();
      console.log("습관 이벤트 리스너 설정 완료");
    }, 1000);
  };
  
  // 탭 변경 시 재초기화
  const habitTab = document.querySelector('.nav-link[onclick="showTab(\'habits\')"]');
  if (habitTab) {
    habitTab.addEventListener('click', function() {
      console.log("습관 탭 클릭됨");
      setTimeout(function() {
        updateHabitHTML();
        initializeHabitFunctions();
      }, 500);
    });
  }
});
// 날짜 선택 기능 추가
function addDateSelectionUI() {
  // 기존 주간 옵션 컨테이너 찾기
  const weekdayOptionContainer = document.getElementById('weekdayOptionContainer');
  
  if (weekdayOptionContainer && !document.getElementById('dateSelectionContainer')) {
    // 날짜 선택 컨테이너 생성
    const dateSelectionContainer = document.createElement('div');
    dateSelectionContainer.id = 'dateSelectionContainer';
    dateSelectionContainer.style.marginTop = '15px';
    dateSelectionContainer.style.display = 'none';
    dateSelectionContainer.innerHTML = `
      <label>날짜 선택</label>
      <div id="dateSelectionCalendar" style="margin-top: 10px; background-color: white; border: 1px solid #ddd; border-radius: 5px; padding: 10px;">
        <!-- 달력이 여기에 동적으로 생성됩니다 -->
        <div style="text-align: center; color: #888; padding: 10px;">
          매월 선택 시 특정 날짜를 선택할 수 있습니다.
        </div>
      </div>
    `;
    
    // 습관 폼에 추가
    const habitForm = document.querySelector('.tab-content#habits .form-group');
    if (habitForm) {
      habitForm.appendChild(dateSelectionContainer);
    }
    
    // 주기 선택 이벤트 업데이트
    const habitFrequency = document.getElementById('habitFrequency');
    if (habitFrequency) {
      habitFrequency.addEventListener('change', function() {
        if (this.value === 'monthly') {
          document.getElementById('dateSelectionContainer').style.display = 'block';
          document.getElementById('weekdayOptionContainer').style.display = 'none';
          document.getElementById('customWeekdaysContainer').style.display = 'none';
          
          // 여기에 달력 렌더링 코드를 추가하세요
          renderDateSelectionCalendar();
        } else {
          document.getElementById('dateSelectionContainer').style.display = 'none';
        }
      });
    }
  }
}

// 날짜 선택용 달력 렌더링
function renderDateSelectionCalendar() {
  const calendar = document.getElementById('dateSelectionCalendar');
  if (!calendar) return;
  
  // 간단한 달력 UI 생성
  const today = new Date();
  const month = today.getMonth();
  const year = today.getFullYear();
  
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  
  let calendarHTML = `
    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
      <button type="button" style="background-color: #5f7561; color: white; border: none; padding: 5px 10px; border-radius: 3px;">◀</button>
      <div>${year}년 ${month + 1}월</div>
      <button type="button" style="background-color: #5f7561; color: white; border: none; padding: 5px 10px; border-radius: 3px;">▶</button>
    </div>
    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;">
      <div style="text-align: center; font-weight: bold;">일</div>
      <div style="text-align: center; font-weight: bold;">월</div>
      <div style="text-align: center; font-weight: bold;">화</div>
      <div style="text-align: center; font-weight: bold;">수</div>
      <div style="text-align: center; font-weight: bold;">목</div>
      <div style="text-align: center; font-weight: bold;">금</div>
      <div style="text-align: center; font-weight: bold;">토</div>
  `;
  
  // 첫 주 빈 셀
  for (let i = 0; i < firstDay; i++) {
    calendarHTML += `<div></div>`;
  }
  
  // 날짜 채우기
  for (let day = 1; day <= daysInMonth; day++) {
    calendarHTML += `
      <div class="date-selection-day" data-day="${day}" style="text-align: center; padding: 8px; border: 1px solid #ddd; border-radius: 3px; cursor: pointer;">
        ${day}
      </div>
    `;
  }
  
  calendarHTML += `</div>`;
  calendar.innerHTML = calendarHTML;
  
  // 날짜 클릭 이벤트 추가
  document.querySelectorAll('.date-selection-day').forEach(day => {
    day.addEventListener('click', function() {
      this.classList.toggle('selected');
      if (this.classList.contains('selected')) {
        this.style.backgroundColor = '#e8f4f1';
        this.style.border = '2px solid #5f7561';
      } else {
        this.style.backgroundColor = '';
        this.style.border = '1px solid #ddd';
      }
    });
  });
}

// 날짜 선택 UI 추가 함수 호출
setTimeout(function() {
  addDateSelectionUI();
}, 1500);
// 목표 세부 항목 관련 기능 개선
function fixGoalSubtaskFunctions() {
  console.log("목표 세부 항목 기능 수정 시작");
  
  // 세부 항목 토글 함수 수정
  window.toggleSubTasks = function(goalId) {
    console.log("세부 항목 토글 호출:", goalId);
    const goalIndex = goals.findIndex(g => g.id === goalId);
    if (goalIndex === -1) return;
    
    // 세부 항목 사용 상태 토글
    goals[goalIndex].hasSubTasks = !goals[goalIndex].hasSubTasks;
    console.log(`목표 ID ${goalId}의 세부 항목 상태: ${goals[goalIndex].hasSubTasks}`);
    
    // 처음 세부 항목을 활성화하는 경우 기본 항목 추가 안함
    saveGoals();
    renderGoals();
  };
  
  // 세부 항목 추가 폼 표시 함수 수정
  window.showAddSubTaskForm = function(goalId) {
    console.log("세부 항목 추가 폼 표시:", goalId);
    const form = document.getElementById('subTaskForm');
    if (!form) {
      console.error("세부 항목 폼을 찾을 수 없음");
      createSubTaskForm();
      return setTimeout(() => showAddSubTaskForm(goalId), 500);
    }
    
    document.getElementById('subTaskTitle').value = '';
    document.getElementById('subTaskGoalId').value = goalId;
    document.getElementById('subTaskId').value = ''; // 새 항목 추가 시에는 ID 비움
    
    // 제목과 버튼 텍스트 업데이트
    document.getElementById('subTaskFormTitle').textContent = '세부 항목 추가';
    
    // 버튼 onclick 직접 설정
    const addButton = document.getElementById('subTaskFormButton');
    if (addButton) {
      addButton.textContent = '추가';
      addButton.onclick = function() { addSubTask(); };
    }
    
    form.style.display = 'block';
    form.scrollIntoView({ behavior: 'smooth' });
  };
  
  // 세부 항목 추가 함수 수정
  window.addSubTask = function() {
    console.log("세부 항목 추가 함수 호출");
    const title = document.getElementById('subTaskTitle').value.trim();
    const goalId = parseInt(document.getElementById('subTaskGoalId').value);
    const taskId = document.getElementById('subTaskId').value; // 수정 시 사용
    
    if (!title) {
      alert('항목 이름을 입력해주세요.');
      return;
    }
    
    console.log(`세부 항목 추가/수정: 목표 ID ${goalId}, 항목 ID ${taskId || '신규'}`);
    
    // 수정 모드인 경우
    if (taskId) {
      const taskIndex = goalSubTasks.findIndex(t => t.id === parseInt(taskId));
      if (taskIndex !== -1) {
        goalSubTasks[taskIndex].title = title;
        
        saveGoals();
        renderGoals();
        closeSubTaskForm();
        console.log("세부 항목 수정 완료");
        return;
      }
    }
    
    // 새 항목 추가
    const subTask = {
      id: Date.now(),
      goalId: goalId,
      title: title,
      completed: false,
      createdAt: new Date().toISOString()
    };
    
    console.log("새 세부 항목 생성:", subTask);
    goalSubTasks.push(subTask);
    saveGoals();
    renderGoals();
    closeSubTaskForm();
    console.log("세부 항목 추가 완료");
  };
  
  // 세부 항목 폼 닫기 함수 수정
  window.closeSubTaskForm = function() {
    console.log("세부 항목 폼 닫기");
    const form = document.getElementById('subTaskForm');
    if (form) form.style.display = 'none';
  };
  
  // 세부 항목 토글 함수 수정 (완료/미완료)
  window.toggleSubTask = function(goalId, taskId) {
    console.log(`세부 항목 토글: 목표 ID ${goalId}, 항목 ID ${taskId}`);
    const taskIndex = goalSubTasks.findIndex(t => t.id === taskId);
    if (taskIndex === -1) return;
    
    // 상태 토글
    goalSubTasks[taskIndex].completed = !goalSubTasks[taskIndex].completed;
    console.log(`세부 항목 완료 상태: ${goalSubTasks[taskIndex].completed}`);
    
    saveGoals();
    renderGoals();
  };
  
  // 세부 항목 폼 생성 (없을 경우)
  function createSubTaskForm() {
    console.log("세부 항목 폼 생성");
    const form = document.createElement('div');
    form.id = 'subTaskForm';
    form.style.display = 'none';
    form.style.background = '#d7d5cb';
    form.style.padding = '15px';
    form.style.borderRadius = '8px';
    form.style.margin = '20px 0';
    form.innerHTML = `
      <h3 id="subTaskFormTitle" style="margin-top: 0;">세부 항목 추가</h3>
      <div style="margin-bottom: 15px;">
        <label for="subTaskTitle">항목 이름</label>
        <input id="subTaskTitle" type="text" style="width: 100%; margin-top: 5px; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
      </div>
      <input id="subTaskGoalId" type="hidden">
      <input id="subTaskId" type="hidden">
      <div style="text-align: right;">
        <button id="subTaskFormButton" style="background-color: #5f7561; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">추가</button>
        <button onclick="closeSubTaskForm()" style="background-color: #95a5a6; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-left: 5px;">취소</button>
      </div>
    `;
    
    const goalsList = document.getElementById('goalsList');
    if (goalsList) {
      goalsList.parentNode.insertBefore(form, goalsList.nextSibling);
      console.log("세부 항목 폼 생성 완료");
    } else {
      console.error("목표 목록을 찾을 수 없어 세부 항목 폼을 추가할 수 없습니다");
      
      // 대안으로 goals 탭에 추가
      const goalsTab = document.getElementById('goals');
      if (goalsTab) {
        goalsTab.appendChild(form);
        console.log("세부 항목 폼을 goals 탭에 직접 추가함");
      }
    }
  }
  
  // 목표 수정 기능 추가
  window.editGoal = function(goalId) {
    console.log("목표 수정 시작:", goalId);
    const goal = goals.find(g => g.id === goalId);
    if (!goal) return;
    
    // 목표 폼 필드에 값 채우기
    document.getElementById('goalTitle').value = goal.title;
    document.getElementById('goalCategory').value = goal.category;
    document.getElementById('goalStartValue').value = goal.startValue;
    document.getElementById('goalTargetValue').value = goal.targetValue;
    document.getElementById('goalUnit').value = goal.unit;
    document.getElementById('goalStartDate').value = goal.startDate;
    document.getElementById('goalEndDate').value = goal.endDate;
    document.getElementById('goalDescription').value = goal.description || '';
    
    // 카테고리가 custom인 경우 처리
    if (!['weight', 'finance', 'study', 'fitness'].includes(goal.category)) {
      document.getElementById('goalCategory').value = 'custom';
      const customCategory = document.getElementById('goalCustomCategory');
      if (customCategory) {
        customCategory.value = goal.category;
        customCategory.style.display = 'block';
      }
    }
    
    // 화면 상단으로 스크롤
    window.scrollTo(0, 0);
    
    // 추가 버튼 텍스트 변경 및 이벤트 재설정
    const addButton = document.querySelector('.tab-content#goals .form-group button');
    if (addButton) {
      addButton.textContent = '목표 수정';
      addButton.dataset.originalOnclick = addButton.getAttribute('onclick');
      addButton.setAttribute('onclick', `updateGoalFromForm(${goalId})`);
    }
    
    console.log("목표 수정 폼 준비 완료");
  };
  
  // 수정된 목표 저장
  window.updateGoalFromForm = function(goalId) {
    console.log("목표 폼에서 업데이트:", goalId);
    const goalIndex = goals.findIndex(g => g.id === goalId);
    if (goalIndex === -1) return;
    
    const title = document.getElementById('goalTitle').value.trim();
    const category = document.getElementById('goalCategory').value;
    const customCategory = document.getElementById('goalCustomCategory')?.value.trim();
    const startValue = parseFloat(document.getElementById('goalStartValue').value);
    const targetValue = parseFloat(document.getElementById('goalTargetValue').value);
    const unit = document.getElementById('goalUnit').value.trim();
    const startDate = document.getElementById('goalStartDate').value;
    const endDate = document.getElementById('goalEndDate').value;
    const description = document.getElementById('goalDescription').value.trim();
    
    // 기본 유효성 검사
    if (!title) {
      alert('목표 제목을 입력해주세요.');
      return;
    }
    
    if (isNaN(startValue) || isNaN(targetValue)) {
      alert('시작 값과 목표 값은 숫자로 입력해주세요.');
      return;
    }
    
    if (!startDate || !endDate) {
      alert('시작일과 목표일을 모두 입력해주세요.');
      return;
    }
    
    // 실제 사용할 카테고리
    const finalCategory = category === 'custom' ? customCategory : category;
    
    // 목표 업데이트
    goals[goalIndex].title = title;
    goals[goalIndex].category = finalCategory;
    goals[goalIndex].startValue = startValue;
    goals[goalIndex].targetValue = targetValue;
    goals[goalIndex].unit = unit;
    goals[goalIndex].startDate = startDate;
    goals[goalIndex].endDate = endDate;
    goals[goalIndex].description = description;
    
    // 저장 및 UI 업데이트
    saveGoals();
    resetGoalForm();
    renderGoals();
    
    alert('목표가 성공적으로 수정되었습니다.');
    
    console.log("목표 업데이트 완료");
  };
  
  // 목표 폼 초기화
  function resetGoalForm() {
    document.getElementById('goalTitle').value = '';
    document.getElementById('goalCategory').value = 'weight';
    document.getElementById('goalStartValue').value = '';
    document.getElementById('goalTargetValue').value = '';
    document.getElementById('goalUnit').value = '';
    document.getElementById('goalDescription').value = '';
    
    const customCategory = document.getElementById('goalCustomCategory');
    if (customCategory) {
      customCategory.value = '';
      customCategory.style.display = 'none';
    }
    
    // 버튼 원래대로 복원
    const addButton = document.querySelector('.tab-content#goals .form-group button');
    if (addButton) {
      addButton.textContent = '목표 추가';
      if (addButton.dataset.originalOnclick) {
        addButton.setAttribute('onclick', addButton.dataset.originalOnclick);
        delete addButton.dataset.originalOnclick;
      } else {
        addButton.setAttribute('onclick', 'addGoal()');
      }
    }
  }
  
  // 목표 렌더링 함수 수정 (수정 버튼 추가)
  const originalRenderGoals = window.renderGoals;
  window.renderGoals = function() {
    console.log("수정된 목표 렌더링 함수 호출");
    
    if (typeof originalRenderGoals === 'function') {
      originalRenderGoals();
      
      // 각 목표 항목에 수정 버튼 추가
      document.querySelectorAll('.goal-controls').forEach(controlsDiv => {
        if (!controlsDiv.querySelector('button[onclick^="editGoal"]')) {
          // goalId 추출
          const deleteBtn = controlsDiv.querySelector('button[onclick^="deleteGoal"]');
          if (deleteBtn) {
            const onclickAttr = deleteBtn.getAttribute('onclick');
            const matches = onclickAttr.match(/deleteGoal\((\d+)\)/);
            if (matches && matches[1]) {
              const goalId = matches[1];
              
              // 수정 버튼 생성 및 추가 (첫 번째 자식으로)
              const editButton = document.createElement('button');
              editButton.textContent = '수정';
              editButton.setAttribute('onclick', `editGoal(${goalId})`);
              controlsDiv.prepend(editButton);
              
              console.log(`목표 ID ${goalId}에 수정 버튼 추가`);
            }
          }
        }
      });
    } else {
      console.error("원본 renderGoals 함수를 찾을 수 없음");
    }
  };
  
  console.log("목표 세부 항목 기능 수정 완료");
}

// 함수 즉시 실행 및 이벤트 리스너 추가
(function() {
  console.log("목표 기능 개선 초기화");
  
  // DOM 로드 후 실행
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      fixGoalSubtaskFunctions();
    });
  } else {
    fixGoalSubtaskFunctions();
  }
  
  // 탭 변경 시에도 실행
  const originalShowTab = window.showTab;
  if (typeof originalShowTab === 'function') {
    window.showTab = function(tabId) {
      originalShowTab(tabId);
      
      if (tabId === 'goals') {
        setTimeout(fixGoalSubtaskFunctions, 300);
      }
    };
  }
})();
// 습관 추적 관련 기능 개선
function fixHabitFunctions() {
  console.log("습관 추적 기능 개선 시작");
  
  // 주기 옵션에 '특정일' 추가
  const habitFrequency = document.getElementById('habitFrequency');
  if (habitFrequency && !Array.from(habitFrequency.options).some(opt => opt.value === 'specific')) {
    const specificOption = document.createElement('option');
    specificOption.value = 'specific';
    specificOption.textContent = '특정일';
    habitFrequency.appendChild(specificOption);
    console.log("'특정일' 옵션 추가됨");
  }
  
  // 특정일 선택 컨테이너 추가
  if (!document.getElementById('specificDatesContainer')) {
    const habitForm = document.querySelector('.tab-content#habits .form-group');
    if (habitForm) {
      const container = document.createElement('div');
      container.id = 'specificDatesContainer';
      container.style.display = 'none';
      container.style.marginTop = '15px';
      container.innerHTML = `
        <label>특정 날짜 선택 (달력에서 원하는 날짜를 클릭하세요)</label>
        <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">
          특정일을 선택하면 해당 날짜에만 습관이 표시됩니다.
        </p>
      `;
      
      habitForm.appendChild(container);
      console.log("특정일 선택 컨테이너 추가됨");
    }
  }
  
  // 기존 함수 수정
  
  // 습관 추가 함수 수정
  window.addHabit = function() {
    console.log("수정된 습관 추가 함수 호출");
    const title = document.getElementById('habitTitle').value.trim();
    const category = document.getElementById('habitCategory').value;
    const customCategory = document.getElementById('habitCustomCategory')?.value.trim();
    const frequency = document.getElementById('habitFrequency').value;
    const description = document.getElementById('habitDescription').value.trim();
    
    if (!title) {
      alert('습관 이름을 입력해주세요.');
      return;
    }
    
    // 실제 사용할 카테고리 (직접 입력 선택 시 customCategory 사용)
    let finalCategory = category;
    if (category === 'custom' && customCategory) {
      finalCategory = customCategory;
    }
    
    // 주기에 따른 날짜 설정
    let weekDays = [];
    let specificDates = [];
    
    if (frequency === 'weekly') {
      const weekdayOption = document.querySelector('input[name="weekdayOption"]:checked')?.value;
      
      if (weekdayOption === 'weekdays' || !weekdayOption) {
        // 주 5일(월-금) 선택
        weekDays = [1, 2, 3, 4, 5]; // 월화수목금 (1-5)
        console.log("주 5일 선택됨:", weekDays);
      } else if (weekdayOption === 'custom') {
        // 직접 선택
        const checkboxes = document.querySelectorAll('.habitWeekDay:checked');
        weekDays = Array.from(checkboxes).map(cb => parseInt(cb.value));
        console.log("직접 선택된 요일:", weekDays);
        
        if (weekDays.length === 0) {
          alert('하나 이상의 요일을 선택해주세요.');
          return;
        }
      }
    } 
    else if (frequency === 'specific') {
      // 특정일 처리
      specificDates = window.selectedSpecificDates || [];
      console.log("선택된 특정일:", specificDates);
      
      if (specificDates.length === 0) {
        alert('하나 이상의 날짜를 선택해주세요.');
        return;
      }
    }
    
    const habit = {
      id: Date.now(),
      title,
      category: finalCategory,
      frequency,
      weekDays, // 주간인 경우만 사용됨
      specificDates, // 특정일인 경우만 사용됨
      description,
      createdAt: new Date().toISOString(),
      streak: 0, // 초기 연속 기록은 0
      color: getRandomHabitColor() // 랜덤 색상 지정
    };
    
    console.log("추가될 습관:", habit);
    habits.push(habit);
    saveHabits();
    
    // 입력 필드 초기화
    document.getElementById('habitTitle').value = '';
    document.getElementById('habitCategory').value = 'health';
    if (document.getElementById('habitCustomCategory')) {
      document.getElementById('habitCustomCategory').value = '';
      document.getElementById('habitCustomCategory').style.display = 'none';
    }
    document.getElementById('habitFrequency').value = 'daily';
    
    // 주간 옵션 초기화
    const weekdayOptionContainer = document.getElementById('weekdayOptionContainer');
    const customWeekdaysContainer = document.getElementById('customWeekdaysContainer');
    const specificDatesContainer = document.getElementById('specificDatesContainer');
    
    if (weekdayOptionContainer) weekdayOptionContainer.style.display = 'none';
    if (customWeekdaysContainer) customWeekdaysContainer.style.display = 'none';
    if (specificDatesContainer) specificDatesContainer.style.display = 'none';
    
    // 요일 체크박스 초기화
    document.querySelectorAll('.habitWeekDay').forEach(cb => cb.checked = false);
    
    // 주 5일 옵션이 기본값이 되도록 설정
    const weekdaysOption = document.getElementById('weekdaysOption');
    if (weekdaysOption) weekdaysOption.checked = true;
    
    // 특정일 선택 초기화
    window.selectedSpecificDates = [];
    document.querySelectorAll('.habit-calendar-day').forEach(day => {
      day.classList.remove('specific-date-selected');
    });
    
    document.getElementById('habitDescription').value = '';
    
    // 습관 목록 및 달력 렌더링
    renderHabits();
    renderHabitCalendar();
    
    alert('새로운 습관이 추가되었습니다.');
  };
  
  // 주기 변경 함수 수정
  window.toggleWeekdayOptions = function() {
    console.log("주간 옵션 토글 실행");
    const frequency = document.getElementById('habitFrequency');
    const weekdayOptionContainer = document.getElementById('weekdayOptionContainer');
    const customWeekdaysContainer = document.getElementById('customWeekdaysContainer');
    const specificDatesContainer = document.getElementById('specificDatesContainer');
    
    // 모든 옵션 컨테이너 숨기기
    if (weekdayOptionContainer) weekdayOptionContainer.style.display = 'none';
    if (customWeekdaysContainer) customWeekdaysContainer.style.display = 'none';
    if (specificDatesContainer) specificDatesContainer.style.display = 'none';
    
    if (frequency && frequency.value === 'weekly') {
      if (weekdayOptionContainer) {
        weekdayOptionContainer.style.display = 'block';
        
        // 기본으로 주 5일(월-금) 선택
        const weekdaysOption = document.getElementById('weekdaysOption');
        if (weekdaysOption) {
          weekdaysOption.checked = true;
        }
      }
    } 
    else if (frequency && frequency.value === 'specific') {
      if (specificDatesContainer) {
        specificDatesContainer.style.display = 'block';
        
        // 특정일 선택 모드 활성화
        enableSpecificDateSelection();
      }
    }
  };
  
  // 특정일 선택 활성화
  function enableSpecificDateSelection() {
    console.log("특정일 선택 모드 활성화");
    
    // 특정일 선택을 위한 전역 배열 초기화
    window.selectedSpecificDates = window.selectedSpecificDates || [];
    
    // 기존에 선택된 날짜 표시
    setTimeout(() => {
      const calendarDays = document.querySelectorAll('.habit-calendar-day');
      calendarDays.forEach(day => {
        const dateStr = day.querySelector('.habit-items')?.dataset.date;
        if (dateStr && window.selectedSpecificDates.includes(dateStr)) {
          day.classList.add('specific-date-selected');
        }
        
        // 클릭 이벤트 추가
        day.style.cursor = 'pointer';
        day.addEventListener('click', function(e) {
          if (document.getElementById('habitFrequency')?.value !== 'specific') return;
          
          const dateElement = this.querySelector('.habit-items');
          if (!dateElement) return;
          
          const dateStr = dateElement.dataset.date;
          if (!dateStr) return;
          
          console.log("날짜 클릭:", dateStr);
          
          // 날짜 토글
          const dateIndex = window.selectedSpecificDates.indexOf(dateStr);
          if (dateIndex === -1) {
            window.selectedSpecificDates.push(dateStr);
            this.classList.add('specific-date-selected');
          } else {
            window.selectedSpecificDates.splice(dateIndex, 1);
            this.classList.remove('specific-date-selected');
          }
          
          console.log("선택된 특정일:", window.selectedSpecificDates);
          
          // 이벤트 버블링 중지
          e.stopPropagation();
        });
      });
    }, 300);
    
    // 특정일 선택 스타일 추가
    addSpecificDateStyles();
  }
  
  // 특정일 선택 스타일 추가
  function addSpecificDateStyles() {
    if (document.getElementById('specific-date-styles')) return;
    
    const styleEl = document.createElement('style');
    styleEl.id = 'specific-date-styles';
    styleEl.textContent = `
      .habit-calendar-day.specific-date-selected {
        background-color: #e8f4f1;
        border: 2px solid #5f7561;
        box-shadow: 0 0 8px rgba(95, 117, 97, 0.3);
      }
      
      .habit-calendar-day.other-month {
        opacity: 0.5;
      }
      
      .habit-calendar-day {
        transition: all 0.2s ease;
      }
      
      .habit-calendar-day:hover {
        transform: scale(1.05);
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
    `;
    
    document.head.appendChild(styleEl);
    console.log("특정일 선택 스타일 추가됨");
  }
  
  // 습관이 특정 날짜에 예정되어 있는지 확인하는 함수 업데이트
  window.isHabitScheduledForDate = function(habit, date) {
    const dateStr = date.toISOString().split('T')[0];
    const dayOfWeek = date.getDay(); // 0(일) ~ 6(토)
    
    switch (habit.frequency) {
      case 'daily':
        return true;
      case 'weekly':
        return habit.weekDays.includes(dayOfWeek);
      case 'monthly':
        const habitStartDate = new Date(habit.createdAt);
        return date.getDate() === habitStartDate.getDate();
      case 'specific':
        return habit.specificDates && habit.specificDates.includes(dateStr);
      default:
        return false;
    }
  };
  
  // 렌더링 함수 업데이트를 위한 이벤트 설정
  const habitTab = document.querySelector('.nav-link[onclick="showTab(\'habits\')"]');
  if (habitTab) {
    habitTab.addEventListener('click', function() {
      console.log("습관 탭 클릭됨");
      setTimeout(function() {
        const habitFrequency = document.getElementById('habitFrequency');
        if (habitFrequency) {
          habitFrequency.removeEventListener('change', toggleWeekdayOptions);
          habitFrequency.addEventListener('change', toggleWeekdayOptions);
          console.log("습관 주기 변경 이벤트 리스너 재설정");
        }
      }, 500);
    });
  }
  
  // 초기 이벤트 리스너 설정
  setTimeout(function() {
    const habitFrequency = document.getElementById('habitFrequency');
    if (habitFrequency) {
      habitFrequency.removeEventListener('change', window.toggleWeekdayOptions);
      habitFrequency.addEventListener('change', window.toggleWeekdayOptions);
      console.log("습관 주기 변경 이벤트 리스너 설정");
    }
  }, 1000);
  
  console.log("습관 추적 기능 개선 완료");
}

// 함수 즉시 실행 및 이벤트 리스너 추가
(function() {
  console.log("습관 기능 개선 초기화");
  
  // DOM 로드 후 실행
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      fixHabitFunctions();
    });
  } else {
    fixHabitFunctions();
  }
  
  // 탭 변경 시에도 실행
  const originalShowTab = window.showTab;
  if (typeof originalShowTab === 'function') {
    window.showTab = function(tabId) {
      originalShowTab(tabId);
      
      if (tabId === 'habits') {
        setTimeout(fixHabitFunctions, 300);
      }
    };
  }
  
  // 습관 달력 렌더링 후 특정일 이벤트 설정
  const originalRenderHabitCalendar = window.renderHabitCalendar;
  if (typeof originalRenderHabitCalendar === 'function') {
    window.renderHabitCalendar = function() {
      originalRenderHabitCalendar();
      
      // 특정일 선택 모드 활성화 (주기가 특정일인 경우)
      if (document.getElementById('habitFrequency')?.value === 'specific') {
        setTimeout(() => {
          enableSpecificDateSelection();
        }, 100);
      }
    };
  }
})();
</script>
<script>
// 세부 항목 동작 수정 함수
function fixGoalSubTaskFunctions() {
  console.log("세부 항목 기능 수정 시작");
  
  // 세부항목 표시 함수 재정의
  window.showAddSubTaskForm = function(goalId) {
    console.log("세부 항목 추가 폼 표시:", goalId);
    
    // 기존 폼 제거
    let existingForm = document.getElementById('subTaskForm');
    if (existingForm) existingForm.remove();
    
    // 목표 항목 찾기
    const goalItem = document.querySelector(`.goal-item:has(button[onclick*="deleteGoal(${goalId})"])`);
    if (!goalItem) {
      console.error("목표 항목을 찾을 수 없음");
      return;
    }
    
    // 폼 생성
    const form = document.createElement('div');
    form.id = 'subTaskForm';
    form.style.background = '#f5f5f5';
    form.style.padding = '15px';
    form.style.borderRadius = '8px';
    form.style.marginTop = '10px';
    form.innerHTML = `
      <h3 style="margin-top: 0;">세부 항목 추가</h3>
      <input id="subTaskTitle" type="text" placeholder="세부 항목 이름" style="width: 100%; padding: 8px; margin-bottom: 10px;">
      <input id="subTaskGoalId" type="hidden" value="${goalId}">
      <div style="text-align: right;">
        <button onclick="addSubTask()">추가</button>
        <button onclick="closeSubTaskForm()" style="background-color: #ccc;">취소</button>
      </div>`;
    
    // 목표 항목에 폼 추가
    goalItem.appendChild(form);
    
    // 입력 필드에 포커스
    setTimeout(() => {
      document.getElementById('subTaskTitle').focus();
    }, 100);
  };
  
  // 세부 항목 추가 함수 재정의
  window.addSubTask = function() {
    console.log("세부 항목 추가 함수 호출");
    const title = document.getElementById('subTaskTitle').value.trim();
    const goalId = parseInt(document.getElementById('subTaskGoalId').value);
    
    if (!title) {
      alert('항목 이름을 입력해주세요.');
      return;
    }
    
    // 목표 찾기
    const goalIndex = goals.findIndex(g => g.id === goalId);
    if (goalIndex === -1) {
      console.error("목표를 찾을 수 없음:", goalId);
      return;
    }
    
    // 세부 항목 데이터 구조 확인 및 생성
    if (!goals[goalIndex].hasSubTasks) {
      goals[goalIndex].hasSubTasks = true;
    }
    
    // 새 항목 추가
    const subTask = {
      id: Date.now(),
      goalId: goalId,
      title: title,
      completed: false,
      createdAt: new Date().toISOString()
    };
    
    // goalSubTasks 배열에 추가
    goalSubTasks.push(subTask);
    
    // 저장 및 UI 업데이트
    saveGoals();
    renderGoals();
    closeSubTaskForm();
    
    console.log("세부 항목 추가 완료:", subTask);
  };
  
  // 세부 항목 폼 닫기 함수
  window.closeSubTaskForm = function() {
    const form = document.getElementById('subTaskForm');
    if (form) form.remove();
  };
  
  // 세부 항목 토글 함수
  window.toggleSubTask = function(goalId, taskId) {
    console.log(`세부 항목 토글: 목표 ID ${goalId}, 항목 ID ${taskId}`);
    const taskIndex = goalSubTasks.findIndex(t => t.id === taskId);
    if (taskIndex === -1) return;
    
    // 상태 토글
    goalSubTasks[taskIndex].completed = !goalSubTasks[taskIndex].completed;
    
    saveGoals();
    renderGoals();
  };
  
  // 목표 렌더링 함수 확인 및 수정
  if (typeof window.renderGoals === 'function') {
    const originalRenderGoals = window.renderGoals;
    window.renderGoals = function() {
      // 원래 함수 호출
      originalRenderGoals();
      
      // 세부 항목 섹션이 제대로 렌더링되었는지 확인
      setTimeout(() => {
        document.querySelectorAll('.goal-subtasks').forEach(subtasksDiv => {
          const goalControls = subtasksDiv.parentElement.querySelector('.goal-controls');
          if (goalControls) {
            const addTaskBtn = goalControls.querySelector('button[onclick^="showAddSubTaskForm"]');
            if (!addTaskBtn) {
              const goalId = goalControls.querySelector('button[onclick^="deleteGoal"]')?.
                getAttribute('onclick')?.match(/deleteGoal\((\d+)\)/)?.[1];
              
              if (goalId) {
                // 항목 추가 버튼이 없으면 추가
                const addBtn = document.createElement('button');
                addBtn.textContent = '항목 추가';
                addBtn.setAttribute('onclick', `showAddSubTaskForm(${goalId})`);
                goalControls.appendChild(addBtn);
              }
            }
          }
        });
      }, 100);
    };
  }
  
  console.log("세부 항목 기능 수정 완료");
}

// 페이지 로드 시 함수 실행
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(fixGoalSubTaskFunctions, 1000);
});

// 목표 탭 클릭시에도 함수 실행
const originalShowTab = window.showTab;
if (typeof originalShowTab === 'function') {
  window.showTab = function(tabId) {
    originalShowTab(tabId);
    
    if (tabId === 'goals') {
      setTimeout(fixGoalSubTaskFunctions, 500);
    }
  };
}

function fixHabitCalendar() {
  const containers = document.querySelectorAll(".habit-calendar");
  if (containers.length > 1) {
    for (let i = 1; i < containers.length; i++) containers[i].remove();
  }

  document.querySelectorAll(".habitWeekDay").forEach(cb => {
    cb.addEventListener("click", () => cb.classList.toggle("selected"));
  });
}
window.addEventListener("load", fixHabitCalendar);
</script>
<script>
  function checkPassword() {
    const input = document.getElementById('password-input').value;
    const correct = '1234';  // 원하는 비밀번호로 변경 가능
    if (input === correct) {
      document.getElementById('password-screen').style.display = 'none';
      document.getElementById('main-content').style.display = 'block';
      console.log("비밀번호 인증 성공");
    } else {
      document.getElementById('error-msg').innerText = "비밀번호가 틀렸습니다.";
    }
  }
</script>

</body>
</html>
